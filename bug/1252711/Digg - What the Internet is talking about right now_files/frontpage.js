/*
 RequireJS text 0.27.0 Copyright (c) 2010-2011, The Dojo Foundation All Rights Reserved.
 Available via the MIT or new BSD license.
 see: http://github.com/jrburke/requirejs for details
*/

/*!
 * Autolinker.js
 * 0.12.2
 *
 * Copyright(c) 2014 Gregory Jacobs <greg@greg-jacobs.com>
 * MIT Licensed. http://www.opensource.org/licenses/mit-license.php
 *
 * https://github.com/gregjacobs/Autolinker.js
 */

// $("#footer-copyright-year").html(new Date().getFullYear());

/*
 *	jQuery dotdotdot 1.7.4
 *
 *	Copyright (c) Fred Heusschen
 *	www.frebsite.nl
 *
 *	Plugin website:
 *	dotdotdot.frebsite.nl
 *
 *	Licensed under the MIT license.
 *	http://en.wikipedia.org/wiki/MIT_License
 */

(function(){define("lodash",[],function(){return window._}),define("bs/util/pubsub",["lodash"],function(e){var t=function(){this.channelHandlers={}};return t.prototype={channels:{scores_update:"story_scores:update",scores_update_error:"story_scores:error",user_auth:"user_auth:success",scrolltop:"scrolltop",popular_stories_rendered:"popular_stories_rendered",new_stories_rendered:"new_stories_rendered"},on:function(e,t,n,r){var i=this.channelHandlers[t];return i||(i=this.channelHandlers[t]=[]),n&&typeof n=="function"&&(n._scope=r||null,i.push(n)),this},one:function(t,n,r){var i=this,s=function(){var o=e.toArray(arguments);r.apply(this,o),i.off(t,n,s)};return this.on(t,n,s),this},off:function(t,n,r){var i=this.channelHandlers[n];return i&&(this.channelHandlers[n]=e.reject(i,function(e){return e===r})),this},fire:function(t){var n=this.channelHandlers[t],r=e.toArray(arguments).slice(1);return n&&e.each(n,function(e){e.apply(e._scope,r)},this),this}},new t}),define("bs/util/cookies",[],function(){var e={set:function(e){var t=[];typeof e=="object"&&(typeof e.name=="string"&&e.name.length>0&&(typeof e.value=="string"||typeof e.value=="number"||typeof e.value=="boolean")&&t.push($.trim(e.name)+"="+encodeURIComponent(e.value)),e.expires instanceof Date&&t.push("expires="+e.expires.toGMTString()),typeof e.path=="string"&&t.push("path="+e.path),typeof e.domain=="string"&&t.push("domain="+e.domain),typeof e.secure=="boolean"&&e.secure&&t.push("secure"),document.cookie=t.join(";"))},get:function(t){var n=e.getAll();return typeof n[t]!="undefined"?n[t]:null},getAll:function(){var e={},t=document.cookie;if(t){var n=null,r=null,i=null,s=t.split(";"),o=s.length-1;if(o>=0)do i=s[o].split("="),n=$.trim(i[0]),r=i[1],n!=="expires"&&typeof r!="undefined"&&(e[n]=decodeURIComponent(r));while(o--)}return e},remove:function(t){var n={};typeof t=="string"?n.name=t:typeof t=="object"&&$.extend(n,t),n.value="",n.expires=new Date(0),e.set(n)},expires:{oneYear:function(){var e=31536e6;return new Date((new Date).valueOf()+e)}}};return e}),define("bs/util/validation",[],function(){return{isURL:function(e){return/^(https?:\/\/)?(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)},isEmail:function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\ ".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA -Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}}}),define("jquery",[],function(){return jQuery}),define("bs/util/xhr",["bs/util/cookies","jquery","lodash"],function(e,t,n){var r={dataType:"digg",converters:{"text digg":function(e){var n=t.parseJSON(e);if(n.status!=="ok")throw new Error("Bad Digg API Response: "+n.mesg);return n}},traditional:!0};return{config:n.clone(r),dataProvider:function(){var i=function(e){this.config=n.extend(n.clone(r),e)};return i.prototype={isPolling:function(){return!!this.pollingRef},request:function(r){var i=n.extend(n.clone(this.config),r);return i.formdata?(i.data=i.data||new FormData,i.data.append("_xsrf",e.get("_xsrf"))):i.type==="POST"&&(i.data=i.data||{},i.data._xsrf=e.get("_xsrf")),t.ajax(i)},startPolling:function(e,n){var r=n.delayStart||!1;t.proxy(function(){r?r=!1:this.request(n),this.pollingRef=setTimeout(t.proxy(arguments.callee,this),e)},this)()},stopPolling:function(){this.pollingRef&&(clearTimeout(this.pollingRef),this.pollingRef=null)}},i}()}}),define("modernizr",[],function(){return Modernizr}),define("bs/util/helpers",["jquery","lodash","modernizr"],function(e,t,n){var r=["You've got a lot of work to do, slacker.","C'mon!",'Just "Mark as Read". You know you want to.'],i={animationEndEventNams:{WebkitAnimation:"webkitAnimationEnd",MozAnimation:"animationend",OAnimation:"oanimationend oAnimationEnd",msAnimation:"MSAnimationEnd",animation:"animationend"},transitionEndEventNames:{WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",msTransition:"MSTransitionEnd",transition:"transitionend"},documentHiddenDOMName:n.prefixed("Hidden",document,!1),onAnimationEnd:function(r,i,s){typeof i=="function"&&(s=i,i=null);var o=this.animationEndEventNames[n.prefixed("animation")];if(n.cssanimations)if(i){var u=function(t){var n=t.propertyName;!n&&t.originalEvent&&(n=t.originalEvent.propertyName),n===i&&(s(),e(r).off(o,u))};e(r).on(o,u)}else e(r).one(o,s);else t.defer(s)},onTransitionEnd:function(r,i,s){typeof i=="function"&&(s=i,i=null);var o=!1,u=function(){if(o)return;o=!0,s()};setTimeout(u,2e3);var a=this.transitionEndEventNames[n.prefixed("transition")];if(n.csstransitions)if(i){var f=function(t){var n=t.propertyName;!n&&t.originalEvent&&(n=t.originalEvent.propertyName),n===i&&(u(),e(r).off(a,f))};e(r).on(a,f)}else e(r).one(a,u);else t.defer(u)},parseUrl:function(e){var t=document.createElement("a");return t.href=e,{href:e,protocol:t.protocol.replace(":",""),hostname:t.hostname,port:t.port,search:t.search,hash:t.hash.replace("#",""),pathname:t.pathname.replace(/^([^/])/,"/$1")}},setInputCaretPosition:function(t,n){t=t instanceof e?t[0]:t;if(t.setSelectionRange)t.focus(),t.setSelectionRange(n,n);else if(t.createTextRange){var r=t.createTextRange();r.collapse(!0),r.moveEnd("character",n),r.moveStart("character",n),r.select()}},setContenteditableCaretPosition:function(t,n){t=t instanceof e?t[0]:t,this.setSelectionRange(t,n,n)},setSelectionRange:function(t,n,r){t=t instanceof e?t[0]:t;if(document.createRange&&window.getSelection){var i=document.createRange();i.selectNodeContents(t);var s=this.getTextNodesIn(t),o=!1,u=0,a;for(var f=0,l;l=s[f++];){a=u+l.length,!o&&n>=u&&(n<=a||n==a&&f<s.length)&&(i.setStart(l,n-u),o=!0);if(o&&r<=a){i.setEnd(l,r-u);break}u=a}var c=window.getSelection();c.removeAllRanges(),c.addRange(i)}else if(document.selection&&document.body.createTextRange){var h=document.body.createTextRange();h.moveToElementText(t),h.collapse(!0),h.moveEnd("character",r),h.moveStart("character",n),h.select()}},getTextNodesIn:function(e){var t=[];if(e.nodeType==3)t.push(e);else{var n=e.childNodes;for(var r=0,i=n.length;r<i;++r)t.push.apply(t,this.getTextNodesIn(n[r]))}return t},getTextRangeInEl:function(t,n,r){t=t instanceof e?t[0]:t;if(document.createRange){var i=document.createRange();i.selectNodeContents(t);var s=this.getTextNodesIn(t),o=!1,u=0,a;for(var f=0,l;l=s[f++];){a=u+l.length,!o&&n>=u&&(n<a||n==a&&f<s.length)&&(i.setStart(l,n-u),o=!0);if(o&&r<=a){i.setEnd(l,r-u);break}u=a}return i}return!1},getCaretPosition:function(t){t=t instanceof e?t[0]:t;var n=0,r;if(typeof window.getSelection!="undefined"){r=window.getSelection();if(r.rangeCount>0){var i=r.getRangeAt(0),s=i.cloneRange();s.selectNodeContents(t),s.setEnd(i.endContainer,i.endOffset),n=s.toString().length}}else if((r=document.selection)&&r.type!="Control"){var o=r.createRange(),u=document.body.createTextRange();u.moveToElementText(t),u.setEndPoint("EndToEnd",o),n=u.text.length}return n},pasteHtmlOverRange:function(t,n,r,s){t=t instanceof e?t[0]:t,t.focus(),i.setSelectionRange(t,r,s),i.pasteHtmlAtCaret(n)},pasteHtmlAtCaret:function(e){if(window.getSelection){var t=window.getSelection();if(t.getRangeAt&&t.rangeCount){var n=t.getRangeAt(0);n.deleteContents();var r=document.createElement("div");r.innerHTML=e;var i=document.createDocumentFragment(),s,o;while(s=r.firstChild)o=i.appendChild(s);n.insertNode(i),o&&(n=n.cloneRange(),n.setStartAfter(o),n.collapse(!0),t.removeAllRanges(),t.addRange(n))}}else document.selection&&document.selection.type!="Control"&&document.selection.createRange().pasteHTML(e)},popWin:function(t,n,r){if(r.width&&r.height){var i=window.screenLeft!==undefined?window.screenLeft:screen.left,s=window.screenTop!==undefined?window.screenTop:screen.top,o=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,u=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height;r.left=o/2-r.width/2+i,r.top=u/2-r.height/2+s}return r=e.param(r).replace(/&/g,","),window.open(t,n,r)},createGlobalCallback:function(e){var t="cb"+(new Date).valueOf()+Math.floor(Math.random()*1e7);return window[t]=function(){e.apply(this,arguments);try{delete window[t]}catch(n){window[t]=null}},t},listen:function(e,t,n){if(t.addEventListener)t.addEventListener(e,n,!1);else if(t.attachEvent){var r=t.attachEvent("on"+e,n);return r}},unlisten:function(e,t,n){if(t.addEventListener)t.removeEventListener(e,n,!1);else if(t.detachEvent){var r=t.detachEvent("on"+e,n);return r}},throttle:function(t,n){var r=null;return function(){var e=this,i=arguments;clearTimeout(r),r=setTimeout(function(){t.apply(e,i)},n)}},serializeAsObject:function(t){return i.deparam(e(t).serialize().replace(/\+/g,"%20"))},deparam:function(t){var n,r={};return t[0]==="?"&&(t=t.substring(1)),n=t.split("&"),e.each(n,function(e,t){var n=t.split("=");r[n[0]]=decodeURIComponent(n[1])}),r},param:function(t){return e.param(t,!0)},makeExpandingArea:function(e){var t=e.querySelector("textarea"),n=e.querySelector("span");t.addEventListener?(t.addEventListener("input",function(){n.textContent=t.value},!1),n.textContent=t.value):t.attachEvent&&(t.attachEvent("onpropertychange",function(){n.innerText=t.value}),n.innerText=t.value),e.className+=" active"},enforceRangeLimits:function(e,t,n){return e<t?t:e>n?n:e},getMaxUnreadMessage:function(){var e=Math.floor(Math.random()*r.length);return r[e]},isElementInViewport:function(e){var t=e[0].getBoundingClientRect(),n=e.parents(".scrollable"),r;r=n[0]&&n[0].getBoundingClientRect();if(!r)return;return t.bottom>=r.bottom?"bottom":t.top<=r.top?"top":!0},isElementInDocViewport:function(t){t instanceof e&&(t=t[0]);var n=t.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&n.right<=(window.innerWidth||document.documentElement.clientWidth)},isMidOfElInDocViewport:function(t,n){t instanceof e&&(t=t[0]),n||(n=0);var r=t.getBoundingClientRect(),i=~~(r.top/2+r.bottom/2);return i>=0-n&&i<=(window.innerHeight||document.documentElement.clientHeight)+n},isBottomOfElInDocViewport:function(t,n){t instanceof e&&(t=t[0]),n||(n=0);var r=t.getBoundingClientRect().bottom;return r>=0-n&&r<=(window.innerHeight||document.documentElement.clientHeight)+n},offsetFromScrollable:function(t){var n=e(t);if(!n.parents(".scrollable").length)return n.offset();var r=n.offsetParent(),i=n.position(),s;for(;;){if(r.is("body"))throw Error(".scrollable parent is not positioned, or given el is not displayed");if(r.is(".scrollable"))return i;s=r.position(),i={top:i.top+s.top,left:i.left+s.left},r=r.offsetParent()}},getScrollPos:function(){return document.documentElement.scrollTop||document.body.scrollTop},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},chunkString:function(e,t){var n=[],r=0,i=t;if(e.length%t!==0)throw new Error("chunkString(): cannot chunk str argument based on chunkLen");while(i<e.length)n.push(e.substr(r,t)),r+=t,i+=t;return n},getTweetStoryLink:function(e){var t;e=e||{};if(!e.content_id&&!e.url)throw new Error("Missing content_id and url arguments. One is required.");if(!e.title)throw new Error("Missing title argument");return t=e.content_id?"http://on.digg.com/"+e.content_id:e.url,["https://twitter.com/intent/tweet?url=",encodeURIComponent(t),"&via=Digg&text=",encodeURIComponent(e.title)].join("")},getFacebookStoryShareLink:function(e){var t;e=e||{};if(!e.app_id)throw new Error("Missing Facebook App ID argument");if(!e.content_id&&!e.url)throw new Error("Missing content_id and url arguments. One is required.");return t=e.content_id?"http://on.digg.com/"+e.content_id:e.url,["https://www.facebook.com/dialog/feed?display=popup&app_id=",e.app_id,"&link=",encodeURIComponent(t),"&redirect_uri=http://digg.com/fbshare"].join("")},getTweetURL:function(e){e=e||{};if(!e.twitter_screen_name)throw new Error("Missing Twitter screen name argument");if(!e.tweet_id)throw new Error("Missing tweet_id argument");return["http://www.twitter.com/",e.twitter_screen_name,"/status/",e.tweet_id].join("")},elementCurrentStyle:function(e,t){if(e.currentStyle){var n=0,r,i="",s=!1;for(n=0,r=t.length;n<r;n++)t[n]!="-"?(i+=s?t[n].toUpperCase():t[n],s=!1):s=!0;return t=i,e.currentStyle[t]}return getComputedStyle(e,null).getPropertyValue(t)},textareaAutoAdjustHeight:function(e){e.adjustHeight=function(){t.defer(function(){e.style.height="auto",e.style.height=~~e.scrollHeight+"px"})},i.listen("keyup",e,e.adjustHeight)},getTextWithLineBreaks:function(t){t instanceof e&&(t=t[0]);var n=e(t.outerHTML);return n.find("br").replaceWith("\n"),n.text()},plainTextPaste:function(t){function n(e){var t=i.getClipboardText(e);document.execCommand?(document.execCommand("insertText",!1,t||""),e.preventDefault()):console.warning("document.execCommand not supported, could't strip HTML from paste")}e(t).on("paste",n),e(t).data("destroyPlainTextPaste",function(){e(t).off("paste",n)})},destroyPlainTextPaste:function(t){(e(t).data("destroyPlainTextPaste")||e.noop)()},inputLimit:function(n,r,s,o){function l(){var e=u.text();if(e===a)return;a=e;var t=i.getCaretPosition(n);u.find(".overflow").length&&(u.find(".overflow")[0].outerHTML=u.find(".overflow").html());if(e.trim().length>r){if(document.createRange){var l=i.getTextRangeInEl(n,r,e.length),c=document.createElement("span");c.className="overflow",c.appendChild(l.extractContents()),l.insertNode(c),i.setContenteditableCaretPosition(n,t)}typeof o=="function"&&!f&&o(),f=!0}else typeof s=="function"&&f&&s(),f=!1}n=n instanceof e?n[0]:n;var u=e(n),a="",f=!1,c=t.debounce(l,100,{maxWait:250});u.on("keyup",c),u.data("destroyInputLimit",function(){e(n).off("keyup",c)}),l()},destroyInputLimit:function(t){(e(t).data("destroyInputLimit")||e.noop)()},preventEvent:function(e){return e.stopPropagation(),e.preventDefault(),e.returnValue=!1,!1},preventScrollBubble:function(t,n){function r(t){var r=e(this),s=this.scrollTop,o=this.scrollHeight,u=r.outerHeight(),a=t.type=="DOMMouseScroll"?t.originalEvent.detail*-40:t.originalEvent.wheelDelta,f=a>0;if(!n.allowScrollDown&&!f&&-a>o-u-s)return r.scrollTop(o),i.preventEvent(t);if(!n.allowScrollUp&&f&&a>s)return r.scrollTop(0),i.preventEvent(t)}if(typeof t!="string")throw Error("selector must be a string, not a jQuery object or HTMLElement");n=n||{},e(document).on("DOMMouseScroll mousewheel",t,r)},getClipboardText:function(e){if(!e)return null;e=e.originalEvent||e;var t;return e.clipboardData&&e.clipboardData.getData&&(t=e.clipboardData.getData("text/plain")),!t&&window.clipboardData&&window.clipboardData.getData&&(t=window.clipboardData.getData("Text")),t},getProfileImages:function(e,n){var r=window.location.protocol+"//",i=r+"//"+window.location.hostname+"/static/images/profiles",s={lg:i+"/no-profile-img_lg.png",med:i+"/no-profile-img_med.png",sm:i+"/no-profile-img_sm.png",tiny:i+"/no-profile-img_tiny.png"};if(n.version){var o={};return t.each(s,function(t,i,s){o[i]=[r,"static.digg.com/profiles/",n.version,"_",e,"_",i,".",n.extension].join("")}),o}return s},formatUser:function(e){return e.profile_images=i.getProfileImages(e.user_id,e.profile_image),e.user_profile_url="/u/"+(e.username||e.user_id),e},setCountInTitle:function(e){var t=document.title.replace(/^\(\d+\) /,"");e?document.title="("+e+") "+t:document.title=t},getVisibilityChangeEventName:function(){var e;return typeof document.hidden!="undefined"?e="visibilitychange":typeof document.mozHidden!="undefined"?e="mozvisibilitychange":typeof document.msHidden!="undefined"?e="msvisibilitychange":typeof document.webkitHidden!="undefined"&&(e="webkitvisibilitychange"),e?e:null},onVisibilityChange:function(e){var t=i.getVisibilityChangeEventName();return t?(document.addEventListener(t,e),!0):null},offVisibilityChange:function(e){var t=i.getVisibilityChangeEventName();return t?(document.removeEventListener(t,e),!0):null}};return i}),define("bs/util/i18n",[],function(){var e={Jan:"Jan",Feb:"Feb",Mar:"Mar",Apr:"Apr",May:"May",Jun:"Jun",Jul:"Jul",Aug:"Aug",Sep:"Sep",Oct:"Oct",Nov:"Nov",Dec:"Dec"};return{__:function(t,n){return e[t]?e[t]:t}}}),define("bs/util/format",["bs/util/i18n"],function(e){function t(e,t){return t||(t=1),e?e:t}function n(t){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return e.__(n[t])}function r(e){var t=e.getHours(),n=e.getMinutes(),r=t>=12?"pm":"am";t%=12,t=t?t:12,n=n<10?"0"+n:n;var i=t+":"+n+" "+r;return i}return{secondsToFuzzyTime:function(e,r){var i=6e4,s=60*i,o=24*s,u=7*o,a=o*3652425/1e4,f=new Date(e*1e3),l=new Date,c=l-f,h,p=r?"":" ago";return c<i?h="just now":c/i<=45?h=t(Math.floor(c/i),1)+"m"+p:c/s<=16?h=t(Math.floor(c/s),1)+"h"+p:c/o<=6?h=t(Math.floor(c/o),1)+"d"+p:c/u<=6?h=t(Math.floor(c/u),1)+"w"+p:c/a<=1?h=[f.getDate(),n(f.getMonth())].join(" "):h=[f.getDate(),n(f.getMonth()),f.getFullYear()].join(" "),h},secondsToDiggReaderTime:function(e){var t,i=new Date(e*1e3),s=i.getDate(),o=i.getMonth(),u=i.getFullYear(),a=new Date,f=a.getDate(),l=(new Date(new Date(a.getFullYear(),a.getMonth(),a.getDate()-1))).getDate(),c=a.getMonth(),h=a.getFullYear();return s===f&&o===c&&u===h?t=r(i):s===l&&o===c&&u===h?t="Yesterday":u===h?t=n(o)+" "+s:t=n(o)+" "+s+" "+u,t},intWithCommas:function(e,t){var n=(e+"").split("").reverse(),r=[],i,s,o=0,u;for(i=1,s=n.length;i<=s;i++)i%3===0?(r.push(n[i-1]),i!==s&&(r.push(","),o++)):r.push(n[i-1]);return t&&s>4?(u=r.reverse().join("").split(",")[0],o===1?u+="k":o===2&&(u+="m")):u=r.reverse().join(""),u},truncate:function(e,t,n,r){if(!e||e.length<=t)return e;typeof r=="undefined"&&(r="\u2026");var i;if(n){i=e.substr(0,t-3).lastIndexOf(" ");var s=e.substr(i-1,1);while([",",";",":","(","-","\u2013","\u2014"," "].indexOf(s)!==-1){i--;if(i===-1)break;s=e.substr(i-1,1)}}if(!n||i===-1)i=t-3;return e.substr(0,i)+r},slugify:function(e){return e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}}}),define("bs/widgets/dailydiggsub",["bs/core","bs/util/xhr","jquery"],function(e,t,n){function u(e){var o=n(e.target),u=o.find(".form-dailydigg-input"),l=o.find(".js--form-email-sub__email-type"),c=n.trim(u.val()),h=require("bs/core").user.isLoggedIn()?"/api/settings/email.json":"/api/dailydiggemail.json",p={email:c};l.size()&&l.val()==="video"&&(h="/api/email/signup.json",p.email_type=l.val());var d=new t.dataProvider({url:h,type:"POST",data:p,success:a,error:f},e),v;return i=e,r=n(e.target),s||(v=document.createElement("div"),v.className="response",r.append(v),s=!0),d.request(),e.stopPropagation(),e.preventDefault(),!1}function a(e){r.removeClass("error").addClass("success").find(".response").html("Thanks for subscribing!"),require("bs/core").pubsub.fire("dailydigg_subscribe_success",i)}function f(e){r.addClass("error").find(".response").html("There was a problem submitting your email. Please try again.")}var r,i,s=!1,o=!1;return{init:function(){if(o)return;o=!0,n(document).on("submit",".form-dailydigg-sub",u)}}}),function(){var e=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],t=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,n=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,r=typeof location!="undefined"&&location.href,i=r&&location.protocol&&location.protocol.replace(/\:/,""),s=r&&location.hostname,o=r&&(location.port||void 0),u=[];define("text",[],function(){var a,f,l;return typeof window!="undefined"&&window.navigator&&window.document?f=function(e,t){var n=a.createXhr();n.open("GET",e,!0),n.onreadystatechange=function(){n.readyState===4&&t(n.responseText)},n.send(null)}:typeof process!="undefined"&&process.versions&&process.versions.node?(l=require.nodeRequire("fs"),f=function(e,t){t(l.readFileSync(e,"utf8"))}):typeof Packages!="undefined"&&(f=function(e,t){var n=new java.io.File(e),r=java.lang.System.getProperty("line.separator"),n=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(n),"utf-8")),i,s,o="";try{i=new java.lang.StringBuffer,(s=n.readLine())&&s.length()&&s.charAt(0)===65279&&(s=s.substring(1));for(i.append(s);(s=n.readLine())!==null;)i.append(r),i.append(s);o=String(i.toString())}finally{n.close()}t(o)}),a={version:"0.27.0",strip:function(e){if(e){var e=e.replace(t,""),r=e.match(n);r&&(e=r[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},createXhr:function(){var t,n,r;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;for(n=0;n<3;n++){r=e[n];try{t=new ActiveXObject(r)}catch(i){}if(t){e=[r];break}}if(!t)throw Error("createXhr(): XMLHttpRequest not available");return t},get:f,parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n),e=e.substring(n+1,e.length),n=e.indexOf("!");return n!==-1&&(t=e.substring(n+1,e.length),t=t==="strip",e=e.substring(0,n)),{moduleName:r,ext:e,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,n,r){var i=a.xdRegExp.exec(e),s;return i?(e=i[2],i=i[3],i=i.split(":"),s=i[1],i=i[0],(!e||e===t)&&(!i||i===n)&&(!s&&!i||s===r)):!0},finishLoad:function(e,t,n,r,i){n=t?a.strip(n):n,i.isBuild&&i.inlineText&&(u[e]=n),r(n)},load:function(e,t,n,u){var f=a.parseName(e),l=f.moduleName+"."+f.ext,c=t.toUrl(l),h=u&&u.text&&u.text.useXhr||a.useXhr;!r||h(c,i,s,o)?a.get(c,function(t){a.finishLoad(e,f.strip,t,n,u)}):t([l],function(e){a.finishLoad(f.moduleName+"."+f.ext,f.strip,e,n,u)})},write:function(e,t,n){if(t in u){var r=a.jsEscape(u[t]);n.asModule(e+"!"+t,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,t,n,r,i){var t=a.parseName(t),s=t.moduleName+"."+t.ext,o=n.toUrl(t.moduleName+"."+t.ext)+".js";a.load(s,n,function(){var t=function(e){return r(o,e)};t.asModule=function(e,t){return r.asModule(e,o,t)},a.write(e,s,t,i)},i)}}})}(),define("text!bs/templates/popover.html",[],function(){return'<div class="popover" role="dialog" aria-hidden="true">\n    <div class="arrow"></div>\n    <div class="btn-close">&#x2716;</div>\n    <div class="popover-content"><%= popoverContent %></div>\n</div>'}),define("text!bs/templates/onboard_firstdigg.html",[],function(){return'<div id="first-digg" class="first-digg">\n    <div>\n        <h5 class="hed">You digg, we digg</h5>\n        <p>Digging a link means that you want other people to see it. Keep up the good work!</p>\n    </div>\n</div>\n'}),define("text!bs/templates/onboard_firstsave.html",[],function(){return'<h5 class="hed">Saved!</h5>\n<p>Saved stories are also synced to your<br/>iPhone, iPad, and/or Android device.</p>\n'}),define("text!bs/templates/modal_dailydigg.html",[],function(){return'<div id="modal-dailydiggsub" class="modal-dailydiggsub modal fade hide" role="dialog" aria-hidden="true">\n    <header class="modal-header">\n        <span class="modal-header-text">Subscribe to <b>The Daily Digg</b></span>\n        <div id="btn-savedstories-modal-close" class="btn-modal-close">&#x2716;</div>\n    </header>\n    <section class="modal-body">\n    \n        <p class="pitch">Welcome to Digg! Every day we send an email with a handful of our <b>top stories</b> and <b>videos</b> and none of the clutter, noise, or cats that usually distract you.</p>\n    <% if (campaignVersion < 4) { %>\n        <div class="kudos">\n        <% if (campaignVersion == 0) { %>\n            <blockquote class="tweet" cite="https://twitter.com/stevekovach/status/408209270900260864"><p>The @digg newsletter is the best email newsletter I get. It\'s also the only one.</p><footer><b>Steve Kovach</b>&nbsp;<a href="https://twitter.com/stevekovach/status/408209270900260864" target="_blank">@stevekovach&nbsp;&nbsp;Dec 4, 2013, 7:20am</a></footer></blockquote>\n        \n        <% } else if (campaignVersion == 1) { %>\n            <blockquote class="tweet" cite="https://twitter.com/mccarthyryanj/status/345188184633769984"><p>You should really sign up for the @digg email newsletter. It\'s great.</p><footer><b>Ryan McCarthy</b>&nbsp;<a href="https://twitter.com/mccarthyryanj/status/345188184633769984" target="_blank">@mccarthyryanj&nbsp;&nbsp;June 13, 2013, 7:37am</a></footer></blockquote>\n        \n        <% } else if (campaignVersion == 2) { %>\n            <blockquote class="tweet" cite="https://twitter.com/travors/status/393001208841252864"><p>The @digg newsletter is really good, in fact it\'s the only newsletter that always engages me.</p><footer><b>Dan Walsh</b>&nbsp;<a href="https://twitter.com/travors/status/393001208841252864" target="_blank">@travors&nbsp;&nbsp;Oct 13, 2013, 6:09am</a></footer></blockquote>\n            \n        <% } else if (campaignVersion == 3) { %>\n            <blockquote class="tweet" cite="https://twitter.com/BrianMueller333/status/350593250521919488"><p>Never thought I\'d look forward to receiving a daily newsletter from Digg, but here we are.</p><footer><b>Brian Mueller</b>&nbsp;<a href="https://twitter.com/BrianMueller333/status/350593250521919488" target="_blank">@BrianMueller333&nbsp;&nbsp;June 28, 2013, 5:35am</a></footer></blockquote>\n        \n        <% } %>\n        </div>\n    <% } %>\n        <form class="form-dailydigg-sub">\n            <label class="form-dailydigg-lbl">\n                <span class="lbl">Enter your email address</span>\n                <input class="form-dailydigg-input" type="email" placeholder="Enter your email address" value="<%= inputValue %>" required />\n            </label>\n            <button class="form-dailydigg-submit" type="submit">Subscribe</button>\n            <p class="calltoaction"><% if (email) { %>Hit the subscribe button<% } else { %>Enter your email, hit subscribe <% } %> and pat yourself on the back for making a great decision.</p>\n        </form>\n    </section>'}),define("bootstrap_modal",[],function(){}),define("bs/widgets/onboarding",["require","bs/core","bs/util/cookies","bs/util/xhr","bs/util/format","bs/util/helpers","bs/widgets/dailydiggsub","text!bs/templates/popover.html","text!bs/templates/onboard_firstdigg.html","text!bs/templates/onboard_firstsave.html","text!bs/templates/modal_dailydigg.html","bootstrap_modal","lodash"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){function E(e,t){return Math.floor(Math.random()*(t-e+1))+e}function S(e){var t=$(e.target).closest(".modal"),n=$(e.target).hasClass("btn-modal-close"),r=$(e.target).hasClass("form-dailydigg-cancel"),i=$(e.target).is(".form-dailydigg-sub.success");if(t.length===0||n||r||i)i?setTimeout(function(){g.modal("hide").remove()},1500):g.modal("hide").remove(),C.optOut(),$(document).off("click touchend",S),window.location.hash="_"}function x(t){var n=typeof t!="undefined"?$(t.target).closest(".popover"):$("body").closest(".popover"),r=typeof t!="undefined"?$(t.target).hasClass("btn-close"):!1,i=typeof t!="undefined"?$(t.target).hasClass("modal"):!1,s=typeof t!="undefined"?$(t.target).hasClass("modal-backdrop"):!1;if(i||s)return;if(n.length===0||r)$(".popover:not(.nav-user .popover)").remove(),$(document).off("click touchend",x),e("bs/core").pubsub.off("story_actions","sitenav_auth_displayed",x),e("bs/core").pubsub.off("story_actions","savedstories_modal_displayed",x)}function T(t){S(t),e("bs/core").pubsub.fire("dailydigg_tweet_campaign_success",w[b]),e("bs/core").pubsub.off("modal_dailydigg","dailydigg_subscribe_success",T)}function N(){window.location.hash="_",g.off("hidden.bs.modal")}var p=h.template(u),d=h.template(a),v=h.template(f),m=h.template(l),g,y=".story-container",b,w=["@stevekovach","@mccarthyryanj","@travors","@BrianMueller333","noTweet"],C={dailyDiggModal:function(t){var n=e("bs/core").user.isLoggedIn()?e("bs/core").user.get("email"):!1,r={email:n?n:!1,inputValue:n?n:"",campaignVersion:E(0,5)},i=m(r);return t&&t.preventDefault&&t.preventDefault(),g=$(i).appendTo("body").modal({keyboard:!0,show:!0}),g.on("hidden.bs.modal",N),b=r.campaignVersion,o.init(),setTimeout(function(){$(".form-dailydigg-input").focus()},10),$(document).on("click touchend",S),g.on("click",".btn-modal-close",S),t&&t.type==="click"&&$(t.target).hasClass("nav-link")?e("bs/core").pubsub.fire("dailydigg_tweet_campaign_view","Nav Link"):e("bs/core").pubsub.fire("dailydigg_tweet_campaign_view",w[b]),e("bs/core").pubsub.on("modal_dailydigg","dailydigg_subscribe_success",T),!1},dailyDiggModalHash:function(t){var n=C.dailyDiggModal,r;window.location.hash==="#dailydigg"&&(r=e("bs/core"),r.user.isLoggedIn()?C.dailyDiggModal(t):(r.pubsub.one("daily_digg_modal",r.pubsub.channels.user_auth,n),$(function(){C.dailyDiggModal(t)})))},firstDigg:function(t){var n=e("bs/core").user.getUser(),r=$("<div></div>"),i=p({popoverContent:d(n)});x(),r.replaceWith(i).appendTo(t.parents(".js--item-actions")).fadeIn(160),$(document).on("click touchend",x),e("bs/core").pubsub.on("story_actions","sitenav_auth_displayed",x),e("bs/core").pubsub.on("story_actions","savedstories_modal_displayed",x)},firstSave:function(t){var n=$("<div></div>"),r=p({popoverContent:v()});x(),n.replaceWith(r).appendTo("#nav-saved").fadeIn(160),$(document).on("click touchend",x),e("bs/core").pubsub.on("story_actions","sitenav_auth_displayed",x),e("bs/core").pubsub.on("story_actions","savedstories_modal_displayed",x),e("bs/core").pubsub.fire("onboarding_firstsave")},optOut:function(){n.set({name:"digg_onboarding_dailydiggsub",value:1,expires:n.expires.oneYear()})}};return C}),define("text!bs/templates/modal_auth.html",[],function(){return'<div id="js--modal--auth" class="modal--v2 modal--v2--responsive modal--user-auth modal fade hide" role="dialog" aria-hidden="true">\n    <div class="modal-header">\n        <div class="modal--v2__header-text">Sign In</div>\n        <div class="js--btn-modal-close modal--v2__close">&#x2716;</div>\n    </div>\n\n    <div class="modal--v2__body">\n        <p><%= notice %></p>\n        \n        <div class="user-auth">\n            <button class="btn user-auth__btn--twitter js--user-auth__btn--twitter">\n                <div class="user-auth__icon ico-twitter-blue"></div>\n                Sign in with Twitter\n            </button>\n            <button class="btn user-auth__btn--facebook js--user-auth__btn--facebook">\n                <div class="user-auth__icon ico-facebook-blue"></div>\n                Sign in with Facebook\n            </button>\n            <button class="btn user-auth__btn--google js--user-auth__btn--google">\n                <div class="user-auth__icon ico-google-red"></div>\n                Sign in with Google\n            </button>\n        </div>\n    </div>\n</div>\n'}),define("bs/util/user",["require","bs/core","bs/util/cookies","bs/util/validation","bs/util/xhr","bs/util/helpers","bs/widgets/onboarding","text!bs/templates/modal_auth.html","lodash"],function(e,t,n,r,i,s,o,u,a){function g(){p||(p=!0,FB.init({version:e("bs/core").config.FB_API_VERSION,appId:e("bs/core").config.FB_APP_ID,status:!0,cookie:!0,oauth:!0,xfbml:!0}))}function y(e,t){var n=t?{url:"/session",type:"POST",data:{action:"refresh"}}:{};c||(c=!0,v.request(n).success(function(t){c=!1,e&&typeof e=="function"&&e(f)}).error(function(e){c=!1}))}function b(e){var t=$(e.target),n=!t.parents("#js--modal--auth").length&&!t.is("#js--modal--auth"),r=t.hasClass("js--btn-modal-close");(n||r)&&w(),$(document).off("click touchend",b)}function w(e){h.$loginModal&&(h.$loginModal.modal("hide").empty().detach(),h.$loginModal=null)}function E(){if(document.location.pathname==="/welcome"||document.location.pathname==="/notashithole"||document.location.pathname.indexOf("/dialog/")===0)return;var e=(new Date).valueOf()/1e3-~~h.get("date_signup")<900,t=n.get("digg_onboarding_dailydiggsub"),r=document.location.hash;(r.match("test-onboarding")||e&&t!=="1"&&!h.get("email_subscriber"))&&o.dailyDiggModal()}function S(){e("bs/core").pubsub.one("site_nav_user_widget",e("bs/core").pubsub.channels.user_auth,E),$(document).off("click",".btn-facebook-auth, .js--user-auth__btn--facebook",P).off("click",".btn-twitter-auth, .js--user-auth__btn--twitter",H).off("click",".btn-google-auth, .js--user-auth__btn--google",B),x()}function x(){var e=!!n.get("frontend.user");return e&&!f&&y(),e}function T(t,n){var r=s.createGlobalCallback(function(r){t&&typeof t=="function"?t=s.createGlobalCallback(t):n!=="link"&&n!=="login"&&(t||(t=s.createGlobalCallback(S)),n==="digg_deeper"&&o.optOut()),_(r,t),e("bs/core").pubsub.fire("twitter_auth_success",n)});return s.popWin("/session/twitter?cb="+r,"twitterSignin",{width:590,height:460}),!1}function N(t,n){var r=s.createGlobalCallback(function(r){t&&typeof t=="function"?t=s.createGlobalCallback(t):n!=="link"&&n!=="login"&&(t||(t=s.createGlobalCallback(S))),C(r,t),e("bs/core").pubsub.fire("google_auth_success",n)});return s.popWin("/session/google?cb="+r,"googleSignin",{width:590,height:560}),!1}function C(e,t){e.oauth_refresh_token&&(document.getElementById("oauth_refresh_token").value=e.oauth_refresh_token),document.getElementById("oauth_access_token").value=e.oauth_access_token,document.getElementById("google_uid").value=e.google_uid,document.getElementById("google_name").value=e.google_name,document.getElementById("google_email").value=e.google_email,document.getElementById("google_expiration_date").value=e.expiration_date,t&&(document.getElementById("google_callback").value=t),document.getElementById("session_google").submit()}function k(t,n){var r=s.createGlobalCallback(function(r){t&&typeof t=="function"&&(t=s.createGlobalCallback(t)),L(r,t),e("bs/core").pubsub.fire("pocket_auth_success",n)});return s.popWin("/session/pocket?cb="+r,"pocketAuth",{width:960,height:640}),!1}function L(e,t){document.getElementById("pocket_token").value=e.pocket_token,document.getElementById("pocket_user_name").value=e.pocket_user_name,t&&(document.getElementById("pocket_callback").value=t),document.getElementById("session_pocket").submit()}function A(t,n){var r=s.createGlobalCallback(function(r){t&&typeof t=="function"&&(t=s.createGlobalCallback(t)),O(r,t),e("bs/core").pubsub.fire("readability_auth_success",n)});return s.popWin("/session/readability?cb="+r,"readabilityAuth",{width:960,height:640}),!1}function O(e,t){document.getElementById("readability_token").value=e.readability_token,document.getElementById("readability_secret").value=e.readability_secret,document.getElementById("readability_username").value=e.readability_username,t&&(document.getElementById("readability_callback").value=t),document.getElementById("session_readability").submit()}function M(e,t){document.getElementById("instapaper_token").value=e.token,document.getElementById("instapaper_secret").value=e.secret,document.getElementById("instapaper_username").value=e.username,t&&(document.getElementById("instapaper_callback").value=t),document.getElementById("session_instapaper").submit()}function _(e,t){document.getElementById("twitter_key").value=e.key,document.getElementById("twitter_secret").value=e.secret,document.getElementById("twitter_screen_name").value=e.screen_name,document.getElementById("twitter_user_id").value=e.user_id,document.getElementById("twitter_callback").value=t,document.getElementById("session_twitter").submit()}function D(e,t){var n=e.authResponse;document.getElementById("fb_access_token").value=n.accessToken,document.getElementById("fb_expires").value=n.expiresIn,t!=null&&(document.getElementById("facebook_callback").value=t),document.getElementById("session_facebook").submit()}function P(t){var n="Sign In";return t&&(t.stopPropagation(),t.preventDefault()),e("bs/core").pubsub.fire("fb_auth_click",n),g(),FB.getLoginStatus(function(t){t.authResponse?(h.loginFacebook(t,s.createGlobalCallback(S)),e("bs/core").pubsub.fire("fb_auth_success",n)):FB.login(function(t){t.authResponse&&(h.loginFacebook(t,s.createGlobalCallback(S)),e("bs/core").pubsub.fire("fb_auth_success",n))},{scope:e("bs/core").config.FB_PERMISSIONS})}),!1}function H(t){var n="Sign In";return t&&(t.stopPropagation(),t.preventDefault()),e("bs/core").pubsub.fire("twitter_auth_click",n),h.initTwitterLogin(null,n),!1}function B(t){var n="Sign In";return t&&(t.stopPropagation(),t.preventDefault()),e("bs/core").pubsub.fire("google_auth_click",n),h.initGoogleLogin(null,n),!1}function j(){$("body").addClass("is--dialog-onboarded"),f.profile_images&&f.profile_images.med&&$(".js--digg-new-comment__profile-img").attr("src",f.profile_images.med)}var f=null,l=null,c=!1,h,p=!1,d=function(t){c=!1,f=s.formatUser(t.user),e("bs/core").pubsub.fire(e("bs/core").pubsub.channels.user_auth,f)},v=new i.dataProvider({url:"/api/user.json",cache:!1,success:d}),m=a.template(u);return h={$loginModal:null,isLoggedIn:x,get:function(e){return f&&e in f?f[e]:null},deepGet:function(e){if(!f)return null;var t=f,n=!0;return a.each(e.split("."),function(e){if(!(e in t))return n=!1,!1;t=t[e]}),n?t:null},refresh:function(e){x()&&y(e)},getUser:function(t){if(t&&typeof t=="function"){x()?f?t(f):e("bs/core").pubsub.one("bs.user",e("bs/core").pubsub.channels.user_auth,t):t(f);return}return f},updateAccessToken:function(e){l=e},initFacebookLogin:function(){g(),h.isLoggedIn()&&FB.getLoginStatus(function(e){e.authResponse&&h.updateAccessToken(e.authResponse.accessToken)})},loginFacebook:D,initTwitterLogin:T,initGoogleLogin:N,initPocketAuth:k,initReadabilityAuth:A,authenticateInstapaper:M,authorized:function(t,n,r){return n=n||"Sign In",r=r||{},r.twitterOnly?function(){var i=function(e){f.twitter&&f.twitter.screen_name?e.call(this,f):s.call(this,e)},s=function(t){x()?h.initTwitterLogin(a.bind(t,this),n):(e("bs/core").pubsub.one("user",e("bs/core").pubsub.channels.user_auth,a.bind(function(){y(a.bind(t,this))},this)),h.initTwitterLogin(null,n))};r.async&&$("#session_twitter").attr("target","session_iframe"),x()?f?i(t):y(a.bind(i,this,t)):s.call(this,t)}:(h.$loginModal&&w(),function(){var i=a.bind(function(){if(r.requireUsername&&!f.username){document.location.href="/welcome?"+$.param({source:"dialog",next:document.location.href});return}r.requireUsername&&j(),t.call(this,f)},this);if(x())f?i():y(i);else{e("bs/core").pubsub.fire("signin_tooltip_displayed",n),e("bs/core").pubsub.fire("auth_tooltip_displayed"),e("bs/core").pubsub.one("savedstories",e("bs/core").pubsub.channels.user_auth,a.bind(function(){w(),y(i)},this));var s={};r.requireUsername?s.notice="Please sign in to join Digg Dialog":s.notice="Please sign in to "+n+" a story",h.$loginModal=$(m(s)).appendTo("body").modal({keyboard:!0,show:!0}),$(document).on("click touchend",b),e("bs/core").pubsub.on("storyaction","sitenav_auth_displayed",w)}return!1})}},e(["bs/core"],function(e){e.extend(e,{user:h})}),window.fbAsyncInit=h.initFacebookLogin,h.isLoggedIn()||$(document).on("click",".btn-facebook-auth, .js--user-auth__btn--facebook",P).on("click",".btn-twitter-auth, .js--user-auth__btn--twitter",H).on("click",".btn-google-auth, .js--user-auth__btn--google",B),$(function(){$("#session-forms").load("/session/forms")}),h}),define("bs/util/media_queries_monitor",["lodash"],function(e){function t(t){this.query=t.query,this.listeners=[],window.matchMedia?(this.mql=window.matchMedia(this.query),this.mql.addListener(e.bind(this.checkMatches,this))):this.mql={matches:!1}}function n(e){this.mediaQueries={}}return t.prototype={addListener:function(e){this.listeners.push(e)},removeListener:function(t){this.listeners=e.reject(this.listeners,function(e){return e===t})},checkMatches:function(t){var n=t||this.mql;n.matches&&e.each(this.listeners,function(e){e()})}},n.prototype={addQuery:function(n,r){this.mediaQueries[n]||(this.mediaQueries[n]=new t({query:n})),r&&typeof r=="function"&&this.mediaQueries[n].addListener(r),e.invoke(this.mediaQueries,"checkMatches")},removeQuery:function(e,t){if(!this.mediaQueries[e])throw new Error('"'+e+'" is not a currently monitored media query');this.mediaQueries[e].removeListener(t)}},{factory:function(e){return new n(e)}}}),define("backbone",[],function(){return Backbone}),define("bs/util/realtime_client",["lodash","jquery","backbone"],function(e,t,n){function o(t){t||(t={}),this._supported=!0,this.config=e.defaults(t,{max_retries:null,max_retry_interval:i,reconnect:!0,retries:0,retry_interval:r,server:s}),window.addEventListener("offline",e.bind(this.handleOffline,this)),this.openSocket()}var r=1e4,i=6e4,s="wss://realtime.digg.com/ws";o.prototype={log:function(){if(!this.config.debug)return;var e=Array.prototype.slice.call(arguments);e.unshift("realtime_client ("+this.config.server+"):"),console.log.apply(console,e)},close:function(){this.log("closing websocket intentially: skipping onclose handler and reconnection attempts"),this._ws&&this._ws.readyState===1&&(this._ws.onclose=e.noop,this._ws.close())},handleMessage:function(e){var t=e.data.charAt(0)==="{"?JSON.parse(e.data):e.data;this.log("received message",t,arguments),this.trigger("message",t)},openSocket:function(){this.log("opening socket"),this._ws=new WebSocket(this.config.server),this.initReadyState(),this._ws.onerror=e.bind(function(e){this.log("websocket onerror",arguments)},this),this._ws.onopen=e.bind(function(t){this.log("websocket onopen",arguments),this._ready.resolve(),e.extend(this.config,{retries:0,retry_interval:r}),this.trigger("open")},this),this._ws.onmessage=e.bind(this.handleMessage,this),this.config.reconnect&&(this._ws.onclose=e.bind(this.checkCloseEvent,this))},handleOffline:function(){this.log("now offline, closing websocket");var t=e.bind(function(){this.log("back online, opening websocket"),this.openSocket(),window.removeEventListener("online",t)},this);this.trigger("offline"),this.close(),window.addEventListener("online",t)},checkCloseEvent:function(e){this.log("websocket onclose",arguments),this.initReadyState(),this.trigger("close"),e.code!==1e3&&this.reconnect()},initReadyState:function(){this._ready=new t.Deferred},reconnect:function(){var t=e.bind(this.openSocket,this);if(this.config.max_retries&&this.config.retries>=this.config.max_retries){this.log("too many reconnect attempts, giving up");return}this.config.retry_interval>this.config.max_retry_interval&&(this.config.retry_interval=this.config.max_retry_interval),this.log("reconnecting in ",this.config.retry_interval/1e3,"seconds - attempt #",this.config.retries),e.delay(t,this.config.retry_interval),this.config.retry_interval=this.config.retry_interval*2,this.config.retries++,this.trigger("reconnect",{num_attempts:this.config.retries})},sendMessage:function(t){var n;t||(t={}),this.config.user&&e.extend(t,{user_id:this.config.user.user_id}),n=JSON.stringify(t),this._ready.done(e.bind(function(){this._ws.send(n)},this))}},e.extend(o.prototype,n.Events);var u,a={factory:function(t){var n;return window.WebSocket?(n=new o(t),window.addEventListener("beforeunload",e.bind(n.close,n))):(n={},e.each(["on","once","off","trigger","sendMessage"],function(e){n[e]=function(){}}),n._supported=!1),n},instance:function(e){return u||(u=a.factory(e)),u}};return a}),define("bs/core",["require","bs/util/pubsub","bs/util/user","bs/util/media_queries_monitor","bs/util/realtime_client","jquery","lodash","modernizr"],function(e,t,n,r,i,s,o,u){var a=window.BS||{};return a.extend=s.extend,a.STATIC_BASE_URL="/static/fe/46f560/",a.ENVIRONMENT="production",a.ENVIRONMENT==="staging"?a.STATIC_BASE_URL="//static.notouching.me"+a.STATIC_BASE_URL:a.ENVIRONMENT==="production"&&(a.STATIC_BASE_URL="//static.digg.com"+a.STATIC_BASE_URL),a.pubsub||a.extend(a,{pubsub:t}),a.ENVIRONMENT==="local"?e(["bs/util/user"],function(e){a._user||(a.extend(a,{user:e}),window.fbAsyncInit||(window.fbAsyncInit=e.initFacebookLogin))}):a.user||(a.extend(a,{user:e("bs/util/user")}),window.fbAsyncInit||(window.fbAsyncInit=e("bs/util/user").initFacebookLogin)),a.mediaQueriesMonitor||a.extend(a,{mediaQueriesMonitor:r.factory()}),a.config.REALTIME_SERVICE_HOSTNAME&&(a.rtClient||(a.rtClient=i.instance({server:(window.location.protocol.indexOf("https")>-1?"wss":"ws")+"://"+a.config.REALTIME_SERVICE_HOSTNAME+"/v1/ws"}),a.rtClient._supported?(a.rtClient.on("open",function(){a.pubsub.fire("realtime_client:open")}),a.rtClient.on("close",function(){a.pubsub.fire("realtime_client:close")}),a.rtClient.on("reconnect",function(e){a.pubsub.fire("realtime_client:reconnect",e)}),a.rtClient.on("message",function(e){a.rtClient._ws.send("OK"),typeof e=="object"&&a.pubsub.fire("realtime_client:message",e)})):a.rtClient.trigger("realtime_client:unsupported"))),u.addTest("ipad",function(){return!!navigator.userAgent.match(/iPad/i)}),u.addTest("iphone",function(){return!!navigator.userAgent.match(/iPhone/i)}),u.addTest("ipod",function(){return!!navigator.userAgent.match(/iPod/i)}),u.addTest("appleios",function(){return u.ipad||u.ipod||u.iphone}),u.ipad&&(a.support={ipad_version_ready:new s.Deferred},window.ondevicemotion=function(e){if(navigator.platform.indexOf("iPad")!=-1){var t=1;e.acceleration&&(t+=window.devicePixelRatio),document.documentElement.className+=" ipad-v"+t,a.support.ipad_version_ready.resolve()}window.ondevicemotion=null}),u.addTest("positionfixed",function(){var e=document.createElement("div"),t=e.cloneNode(!1),n=!1,r=document.body||function(){return n=!0,document.documentElement.appendChild(document.createElement("body"))}(),i=r.style.cssText;r.style.cssText="padding:0;margin:0",e.style.cssText="position:fixed;top:42px",r.appendChild(e),r.appendChild(t);var s=e.offsetTop!==t.offsetTop;return r.removeChild(e),r.removeChild(t),r.style.cssText=i,n&&document.documentElement.removeChild(r),navigator.userAgent.match(/OS (\d)/i),s&&(!u.appleios||u.appleios&&RegExp.$1>=5)}),u.addTest("lastchild",function(){var e,t=["#modernizr-last-child li{display:block;width:100px;height:100px;}","#modernizr-last-child li:last-child{width:200px;}"],n=document.getElementsByTagName("head")[0]||function(){return document.documentElement.appendChild(document.createElement("head"))}(),r=document.body||function(){return document.documentElement.appendChild(document.createElement("body"))}(),i=document.createElement("ul"),s=document.createElement("li"),o=document.createElement("li"),u=document.createElement("style");return u.type="text/css",u.styleSheet?u.styleSheet.cssText=t.join(""):u.appendChild(document.createTextNode(t.join(""))),n.appendChild(u),i.id="modernizr-last-child",i.appendChild(s),i.appendChild(o),r.appendChild(i),e=o.offsetWidth>s.offsetWidth,n.removeChild(u),r.removeChild(i),e}),function(e,t){t.support.touch="ontouchstart"in e}(this,this.jQuery),s.fn.k=function(e,t){return t===undefined&&(t="38,38,40,40,37,39,37,39,66,65"),this.each(function(){var n=[];s(this).keydown(function(r){n.push(r.keyCode),n.toString().indexOf(t)>=0&&(s(this).unbind("keydown",arguments.callee),e(r))})})},a}),define("bs/util/storyactions2",["require","bs/core","bs/util/cookies","bs/util/xhr","bs/util/format","bs/util/helpers","bs/widgets/onboarding","lodash"],function(e,t,n,r,i,s,o,u){function d(e){var t=(new Date).valueOf()+31536e6;$.extend(h,e),n.set({name:c,value:$.param(h),expires:new Date(t)})}function v(e){var r="http://api.digg.com/api/v3/redirect",i=$(this).closest(a),s=i.data("contentId"),o=i.data("position"),u=t.user.get("user_id"),f=n.get("frontend.auid"),l=i.data("source"),c={url:this.href};s&&(c.content_id=s),u?c.user_id=u:f&&(c.auid=f),l&&(c.source=l),o!=null&&(c.position=o),navigator.mozApps&&window.locationbar.visible===!1&&(c.platform=1005,window.open([r,$.param(c)].join("?")));if(p==="mobile")c.platform=1005,window.location.href=[r,$.param(c)].join("?");else{if(this.target!=="_blank")return;window.open([r,$.param(c)].join("?"))}return!1}function m(e){var t={contentID:e.data("contentId"),diggUrlID:e.data("urlId"),category:e.data("category"),diggScore:e.data("diggScore"),tweets:e.data("tweets"),fbShares:e.data("fbShares"),diggs:e.data("diggs"),dugg:e.data("dugg"),read_later:e.data("read_later")};return t.diggScore=u.isString(t.diggScore)?parseInt(t.diggScore.replace(/,/g,""),10):t.diggScore,t.tweets=u.isString(t.tweets)?parseInt(t.tweets.replace(/,/g,""),10):t.tweets,t.fbShares=u.isString(t.fbShares)?parseInt(t.fbShares.replace(/,/g,""),10):t.fbShares,t.diggs=u.isString(t.diggs)?parseInt(t.diggs.replace(/,/g,""),10):t.diggs,t}function g(e,t){e.data(t)}function y(e){u.each(e,function(e,t){b(t,e)})}function b(e,t,n){var r=$(".story-"+e),s=$(".diggscore-"+e),o=$(".diggs-"+e),u=$(".tweets-"+e),a=$(".fb_shares-"+e),c=$(".digg-"+e),h=$(".save-"+e),p=s.parent(".story-score"),d=$(".diggs-label-"+e);g(r,{diggScore:t.digg_score,diggs:t.diggs,tweets:t.tweets,fbShares:t.fb_shares,dugg:t.dugg,read_later:t.read_later});if(!s||!s.size())return;t.digg_score>0&&p.hasClass("story-score-zero")?p.removeClass("story-score-zero"):t.digg_score===0&&p.addClass("story-score-zero"),d.length>0&&t.diggs===0?p.addClass("story-score-zero"):d.length>0&&t.diggs===1?(d.html("digg"),p.removeClass("story-score-zero")):d.length>0&&(d.html("diggs"),p.removeClass("story-score-zero")),o.html(i.intWithCommas(t.diggs)),u.html(i.intWithCommas(t.tweets)),a.html(i.intWithCommas(t.fb_shares)),s.html(i.intWithCommas(t.digg_score,!0)),!n&&t.hasOwnProperty("dugg")&&t.dugg&&(c.html("Dugg"),r.addClass(f)),!n&&t.hasOwnProperty("read_later")&&t.read_later&&(h.html("Saved"),r.addClass(l))}function w(e){var t=$(this),n=t.parents(a),i=m(n);C(n.find(".story-action-digg"));var s={content_id:i.contentID,digg_url_id:i.diggUrlID},o=i.dugg?"/api/digg/delete.json":"/api/digg/submit.json",f=new r.dataProvider({url:o,type:"POST",data:s,success:u.bind(E,this,t,i.contentID)});return f.request(),!1}function E(e,n,r){var i=document.location.hash,s=$('.digg-story-el[data-content-id="'+n+'"]'),u=(new Date).valueOf()/1e3-~~t.user.get("date_signup")<900,a=r.data;b(n,a,!0),a.dugg?(t.pubsub.fire("digg_success",e,a,n),s.addClass(f),$(".digg-"+n).html("Dugg")):(t.pubsub.fire("digg_delete_success",e,a,n),s.removeClass(f),$(".digg-"+n).html("Digg"));if(i.match("test-onboarding")||a.dugg&&!h.dugg&&u)o.firstDigg(e),d({dugg:1})}function S(e){var t=$(this),n=t.parents(a),i=m(n);C(n.find(".story-action-save"));var s=i.read_later?"/api/story/readlater/delete.json":"/api/story/readlater/add.json",o={content_id:i.contentID,digg_url_id:i.diggUrlID},f=new r.dataProvider({url:s,type:"POST",data:o,success:u.bind(x,this,t,i.contentID)});return f.request(),!1}function x(e,n,r){var i=document.location.hash,s=$('.digg-story-el[data-content-id="'+n+'"]'),u=(new Date).valueOf()/1e3-~~t.user.get("date_signup")<900,a=r.data;g(s,{read_later:a.read_later}),a.read_later?(s.addClass(l),$(".save-"+n).html("Saved"),t.pubsub.fire("add_reading_list_success",e,a,n)):(s.removeClass(l),$(".save-"+n).html("Save"),t.pubsub.fire("delete_reading_list_request",e,a,n));if(i.match("test-onboarding")||a.read_later&&!h.saved&&u)o.firstSave(e),d({saved:1})}function T(e){C(e);var n=$(this),r=n.hasClass("share-twitter")?"twitter":"facebook";return e.preventDefault(),t.pubsub.fire("story_share",r,n),r==="twitter"?!1:(s.popWin(this.href,null,{width:550,height:450}),!1)}function N(e){var t=$(this),n=t.data("shareContentId"),r=t.data("shareId"),i="share-details-"+n+"-"+r;$(".share-details-"+n).hide(),$("#"+i).show(),$(".story-trending-share-img-container-"+n).removeClass("current"),t.parent().addClass("current")}function C(e){if(!e)return;e.currentTarget&&(e=$(e.currentTarget));var t=e.find(".js--icon");t.length&&(t.addClass("is--clicked"),setTimeout(function(){t.removeClass("is--clicked")},150))}var a=".digg-story-el",f="story-acted-dugg",l="story-acted-saved",c="saflags",h=n.get(c),p=n.get("preferred_view")||"desktop";return h=h?s.deparam(h):{},{submitDigg:w,addReadingList:S,renderStoryScores:y,redirectStoryLink:v,shareStory:T,showShareDetails:N}}),define("bs/util/fx",["bs/util/helpers","jquery"],function(e,t){var n=250,r="height",i={scrollToEl:function(r,i){var s=t(r);if(!s.length)throw Error("Missing el argument or el selector matched nothing:",r);s.length>1&&console.error("Ambiguous call, el argument has multiple matches:",r),i=i||{},typeof i.duration=="undefined"&&(i.duration=n);var o;typeof i.offset=="undefined"?(o=-1*t(".js--digg-header").outerHeight(),o+=i.offsetBeyondHeader||0):o=i.offset;var u=0;typeof i.bottomOffset!="undefined"&&(u=i.bottomOffset);var a;i.forceWindowScroll||(a=s.closest(".scrollable"));var f,l,c;a&&a.length?(f=a,l=e.offsetFromScrollable(s).top,c=f.scrollTop(),o+=f.scrollTop(),i.scrollToBottom&&(u+=f.scrollTop())):(l=s.offset().top,f=t("html, body"),c=document.documentElement.scrollTop||document.body.scrollTop);if(i.scrollToBottom){var h=l;l+=o,h+=s.outerHeight()+u,a&&a.length?h-=a.height():h-=window.innerHeight||document.documentElement.clientHeight,i.notPastTop?l=Math.min(l,h):l=h}else l+=o;var p=!1;i.onlyUp&&c<=l&&(p=!0),i.onlyDown&&c>=l&&(p=!0),i.onlyIfNotInViewport&&e.isElementInDocViewport(r)&&(p=!0);if(p){i.cb&&i.cb();return}f.animate({scrollTop:l},i.duration),i.cb&&setTimeout(i.cb,i.duration)},slideFadeIn:function(n,s){s=s||{},typeof s.transPropName=="undefined"&&(s.transPropName=r);var o=t(n);o.addClass("slide-fade pre-slide-fade"),o.css({height:"auto",opacity:0,position:"absolute"});var u=o.outerHeight(!0);return o.css({height:"0",position:"relative"}),setTimeout(function(){o.removeClass("pre-slide-fade"),o.css({height:u+"px",opacity:1,overflow:"hidden"}),e.onTransitionEnd(o,s.transPropName,function(){o.css({overflow:""}),i.setHeightAuto(o),typeof s.cb=="function"&&s.cb()})},15),o},slideFadeAddTo:function(e,n,r,s){var o=t("<div></div>");return o.addClass("slide-fade pre-slide-fade"),t(e).appendTo(o),o[n](t(r)),i.slideFadeIn(o,s)},slideFadeAppendTo:function(e,t,n){return i.slideFadeAddTo(e,"appendTo",t,n)},slideFadePrependTo:function(e,t,n){return i.slideFadeAddTo(e,"prependTo",t,n)},slideFadeOut:function(n,s){s=s||{},typeof s.transPropName=="undefined"&&(s.transPropName=r);var o=t(n),u=o[0].style.height;(u==="auto"||u==="")&&i.setHeightPx(o),setTimeout(function(){o.css({height:"0",opacity:0,overflow:"hidden"}),e.onTransitionEnd(o,s.transPropName,function(){typeof s.cb=="function"&&s.cb()})},30)},setHeightAuto:function(e){e.css({height:"auto",transition:"none"}),setTimeout(function(){e.css({transition:""})},15)},setHeightPx:function(e){e.css({height:e.outerHeight(!0)+"px",transition:"none"}),setTimeout(function(){e.css({transition:""})},15)},callIfMouseStays:function(e,t,n){var r=setTimeout(t,n),i=function(t){clearTimeout(r),e.off("mouseleave",i)};e.on("mouseleave",i)}};return i}),define("bs/util/tracker",[],function(){function e(e){this.debug=e}return e.prototype={trackEvent:function(){var e=Array.prototype.slice.call(arguments).reverse(),t=e[0];if(t&&t.hitCallback){if(!window.ga||!ga.loaded){t.hitCallback();return}t.hitCallback=_.once(t.hitCallback),setTimeout(t.hitCallback,2e3)}return e.push("event","send"),window.ga.apply(null,e.reverse()),this.debug&&console.log("tracking",e),!0},trackSocial:function(){var e=Array.prototype.slice.call(arguments).reverse();return e.push("social","send"),window.ga.apply(null,e.reverse()),this.debug&&console.log("tracking social",e),!0}},e}),define("bs/util/tracking_v2",["bs/core","bs/util/tracker","jquery","lodash"],function(e,t,n,r){function i(e){if(!e)return null;var t=e.match(/:\/\/(.[^\/]+)/);return t?t[1]:null}function s(e){var t;return e?(t=e.split("-"),t[0].charAt(0).toUpperCase()+t[0].substring(1)):""}function o(e){e.submit()}function u(e){var t=e.closest(".stories-container, [data-tracking-section]"),s=e.closest(".js--digg-story"),o=s.data("contenturl")||e.attr("href"),u=i(o),a=s.data("position")||0,f=["Tag","Source","Search"],l=s.find(".is--first-tag"),c=l.size()?n.trim(l.text()):"Uncategorized",h={section:t.data("trackingSection"),position:a,url:o,domain:u,primary_tag:c};return r.indexOf(f,h.category)>-1&&(h.is_archived=!0,h.label=t.data("tracking-label")),h}function S(){this.tracker=new t(!1)}var a=function(){var e=this;n(document).on("click",".js--digg-story__link",function(t){var r=n(this),i="Story Click",s=u(r),o=[i,s.section,s.label||s.primary_tag,s.position];return e.trackEvent.apply(e,o)})},f=function(){function r(e,r,i){var s=u(n(e)),o=[r,s.section,s.label||s.primary_tag,s.position];return t.trackSocial.apply(t,["digg",i,s.url]),t.trackEvent.apply(t,o)}var t=this;e.pubsub.on("tracking","digg_success",function(e){return r(e,"Digg","digg")}),e.pubsub.on("tracking","digg_delete_success",function(e){return r(e,"Digg Delete","digg_delete")}),e.pubsub.on("tracking","comment_digg_success",function(e){return r(e,"Comment Digg","comment_digg")}),e.pubsub.on("tracking","comment_digg_delete_success",function(e){return r(e,"Comment Digg Delete","comment_digg_delete")})},l=function(){var t=this;e.pubsub.on("tracking","add_reading_list_success",function(e){var n=e.closest(".js--digg-story"),r="Saved Story",i=u(n),s=[r,i.section,i.label||i.primary_tag,i.position];return t.trackSocial.apply(t,["digg","save",i.URL]),t.trackEvent.apply(t,s)})},c=function(){var t=this,n="Daily Digg Email Submit";e.pubsub.on("tracking","daily_digg_email_submit_start",function(e){return t.trackEvent(n,"Email Address entered")}),e.pubsub.on("tracking","daily_digg_email_submit_success",function(e){return t.trackEvent(n,"Email Address submission complete")})},h=function(){var t=this;e.pubsub.on("tracking","story_share",function(e,n){var r=e==="twitter"?"Social: Twitter":"Social: Facebook",i=u(n),s=[r,"Share",i.section];return t.trackSocial.apply(t,[e,"share",i.url]),t.trackEvent.apply(t,s)}),n(document).on("click",".btn-tweet-reply",function(e){var r=n(this),i="Social: Twitter",s=u(r);return t.trackSocial.apply(t,["twitter","reply",s.url]),t.trackEvent(i,"Reply",s.section)}).on("click",".btn-tweet-retweet",function(e){var r=n(this),i="Social: Twitter",s=u(r);return t.trackSocial.apply(t,["twitter","retweet",s.url]),t.trackEvent(i,"Retweet",s.section)}).on("click",".btn-tweet-favorite",function(e){var r=n(this),i="Social: Twitter",s=u(r);return t.trackSocial.apply(t,["twitter","favorite",s.url]),t.trackEvent(i,"Favorite",s.section,s.URL)})},p=function(){var t=this;e.pubsub.on("tracking","signin_tooltip_displayed",function(e){var n="Sign in attempt",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","fb_auth_click",function(e){var n="Click Facebook Auth",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","fb_auth_success",function(e){var n="Facebook Auth Complete",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","twitter_auth_click",function(e){var n="Click Twitter Auth",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","twitter_auth_success",function(e){var n="Twitter Auth Complete",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","google_auth_click",function(e){var n="Click Google Auth",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","google_auth_success",function(e){var n="Google Auth Complete",r="on "+e;return t.trackEvent(n,r)}),e.pubsub.on("tracking","dailydigg_signup",function(e){var n="Email Signup",r="on "+e.source_action,i="via "+e.network;return t.trackEvent(n,r,i)})},d=function(){var t=this;e.pubsub.on("tracking","dailydigg_tweet_campaign_view",function(e){return t.trackEvent("Daily Digg Signup Modal","Tweet Campaign View",e)}),e.pubsub.on("tracking","dailydigg_tweet_campaign_success",function(e){return t.trackEvent("Daily Digg Signup Modal","Tweet Campaign Success",e)})},v=function(){var t=this;n(document).on("click","#btn-hdr-submit-link",function(e){return t.trackEvent("Submit a Link","Footer")}),e.pubsub.on("tracking","submit_link_pasted",function(){return t.trackEvent("Submit a Link","Paste Link")}),e.pubsub.on("tracking","submit_link_fb_auth",function(){return t.trackEvent("Submit a Link","Auth with Facebook")})},m=function(){var t=this;e.pubsub.on("tracking","fb_enable_og_update",function(e){var n=e?"on":"off";return t.trackEvent("Toggle Timeline Sharing","Turn "+n)})},g=function(){var t=this;e.pubsub.on("tracking","spreadgun",function(e){return t.trackEvent("Konami!",e)})},y=function(){var e=this;n(function(){n("#form-digg-search").on("submit",function(t){var i=n(this).find("input[name=q]").val();r.delay(o,400,this),e.trackEvent("Search","Header",i)}),n("#search-page-form").on("submit",function(t){var i=n(this).find("input[name=q]").val();r.delay(o,400,this),e.trackEvent("Search","Search Page",i)})})},b=function(){var e=this;n(document).on("click",".tag-list-item-link",function(t){t.preventDefault(),setTimeout(function(){window.location.href=t.target.href},400);var r=n("article"),i=u(r);return e.trackEvent("Tag Navigation Click","From "+i.section,"To "+t.target.text)}).on("click",".js--digg-story__metadata-link--tag",function(t){t.preventDefault(),setTimeout(function(){window.location.href=t.target.href},400);var r=n(this),i=n("body").hasClass("homepage");return i?e.trackEvent("Archive Click","Tag Click",r.attr("href")):e.trackEvent("Pivot Click","Source Click",r.attr("href"))}).on("click",".js--digg-story__metadata-link--source",function(t){t.preventDefault(),setTimeout(function(){window.location.href=t.target.href},400);var r=n(this),i=n("body").hasClass("homepage");return i?e.trackEvent("Archive Click","Source Click",r.attr("href")):e.trackEvent("Pivot Click","Source Click",r.attr("href"))})},w=function(){var e=this,t;n(document).on("click",".btn-more-stories",function(r){var i=n(this),s=i.closest("[data-tracking-category]"),o=s.data("tracking-category"),u=s.data("tracking-action"),a=~~i.data("incrementor");return a+=1,i.data("incrementor",a),t="Page "+a.toString(),e.trackEvent("Archive Pagination Depth",t,o+" "+u)})},E=function(){var t=this,n="Digg Deeper";e.pubsub.on("tracking","digg_deeper:onboarding:start",function(){var e=[n,"Onboarding start",window.location.href];return t.trackEvent.apply(t,e)}),e.pubsub.on("tracking","digg_deeper:onboarding:opt_in",function(){var e=[n,"Twitter alerts opt in",window.location.href];return t.trackEvent.apply(t,e)}),e.pubsub.on("tracking","digg_deeper:onboarding:email_opt_in",function(){var e=[n,"Email alerts opt in",window.location.href];return t.trackEvent.apply(t,e)}),e.pubsub.on("tracking","digg_deeper:onboarding:opt_out",function(e){var r=[n,e+" opt out",window.location.href];return t.trackEvent.apply(t,r)}),e.pubsub.on("tracking","digg_deeper:onboarding:success",function(){var e=[n,"Onboarding success",window.location.href];return t.trackEvent.apply(t,e)}),e.pubsub.on("tracking","digg_deeper:stream:sortby_selected",function(e){var r=[n,"Sortby selected",e.charAt(0).toUpperCase()+e.slice(1)];return t.trackEvent.apply(t,r)}),e.pubsub.on("tracking","digg_deeper:stream:loaded",function(e,r){var i=[n,"Stream page loaded","Sort by: "+e.charAt(0).toUpperCase()+e.slice(1),r];return t.trackEvent.apply(t,i)}),e.pubsub.on("tracking","digg_deeper:stream:sharer_click",function(e){var r=[n,"Sharer click",e];return t.trackEvent.apply(t,r)}),e.pubsub.on("tracking","digg_deeper:stream:settings_click",function(e){var r=[n,"Settings click",e];return t.trackEvent.apply(t,r)})};S.prototype={initialize:function(){a.call(this.tracker),f.call(this.tracker),l.call(this.tracker),h.call(this.tracker),p.call(this.tracker),m.call(this.tracker),v.call(this.tracker),g.call(this.tracker),c.call(this.tracker),b.call(this.tracker),w.call(this.tracker),y.call(this.tracker),d.call(this.tracker),E.call(this.tracker)}};var x=new S;x.initialize()}),define("bs/util/scrollmonitor",["bs/core","bs/util/helpers","jquery","lodash"],function(e,t,n,r){function s(e,i){var s=20;this.throttleThreshold=1e3/s;var o=r.bind(this.monitor,this);typeof e=="string"?e=document.getElementById(e):e instanceof n&&(e=e[0]);if(!e)throw Error("ScrollMonitor must be instantiated with valid `el` argument");this.options=i=i||{},typeof i.monitorElementScroll=="undefined"&&(i.monitorElementScroll=!0),this._el=e,this._lastScrollTop=0,this.direction=null,this.name=i.name||"scrollMonitor",i.pubsub&&(this.pubsub=i.pubsub),this.updateScrollHeight(),this._monitor=r.throttle(o,this.throttleThreshold),i.monitorScrollableParent?n(e).parents(".scrollable").length?(this.$scrollableParent=n(e).closest(".scrollable"),this.$scrollableParent.on("scroll",this._monitor)):n(window).on("scroll",this._monitor):i.monitorWindowScroll&&n(window).on("scroll",this._monitor),i.monitorElementScroll&&n(this._el).on("scroll",this._monitor),i.delayInitialMonitor?(t.isNumeric(i.delayInitialMonitor)||(i.delayInitialMonitor=250),setTimeout(r.bind(this._monitor,this),i.delayInitialMonitor)):i.preventInitialMonitor||this._monitor(),typeof i.bottomThreshold=="undefined"?this.bottomThreshold=100:this.bottomThreshold=i.bottomThreshold,typeof i.topThreshold=="undefined"?(this.topThreshold=n(".js--digg-header").outerHeight()||0,this.topThreshold+=i.topThresholdBeyondHeader||0):this.topThreshold=i.topThreshold}var i=function(){var t=20;this.$win=n(window),this.$body=n(document.body),this.winHeight=this.$win.height(),this.scrollHeight=this.$body.height(),this.$win.scroll(r.throttle(r.bind(this.monitor,this),1e3/t))};return i.prototype={updateScrollHeight:function(){this.scrollHeight=this.$body.height()},updateWinHeight:function(){this.winHeight=this.$win.height()},monitor:function(){var t=30,n=document.documentElement.scrollTop||document.body.scrollTop;e.pubsub.fire(e.pubsub.channels.scrolltop,this.$win.scrollTop()),this.winHeight+n+t>=this.scrollHeight&&e.pubsub.fire("window_scroll_monitor:bottom")}},e.scrollMonitor=new i,r.bindAll(e.scrollMonitor),s.prototype={data:function(){var e;return this.direction=this._el.scrollTop-this._lastScrollTop<0?"up":"down",e={el:this._el,scrollTop:this._el.scrollTop,scrollHeight:this._el.scrollHeight,direction:this.direction},e.scrollBottom=e.scrollTop+e.scrollHeight,e},isBottom:function(){return this._el.offsetHeight+this._el.scrollTop+this.bottomThreshold>=this._el.scrollHeight},scrolledToElBottom:function(){var e,r;return this.$scrollableParent?(e=this.$scrollableParent.height(),r=t.offsetFromScrollable(this._el).top+n(this._el).height()):(e=n(window).height(),r=this._el.getBoundingClientRect().bottom),e+this.bottomThreshold>=r},scrolledPastElTop:function(){if(this.$scrollableParent)return t.offsetFromScrollable(this._el).top<=0;var e=this._el.getBoundingClientRect();return e.top-this.topThreshold<=0},checkScrollDepth:function(e){return this._el.offsetHeight+this._el.scrollTop>=this._el.scrollHeight*e},updateScrollHeight:function(){this.scrollHeight=this._el.scrollHeight},monitor:function(){if(this.pubsub){if(this.options.monitorWindowScroll||this.options.monitorScrollableParent)this.scrolledToElBottom()?this.pubsub.fire(this.name+":scroll:bottom",this.data()):this.pubsub.fire(this.name+":scroll:not_bottom",this.data()),this.options.checkScrollPast&&(this.scrolledPastElTop()?this.pubsub.fire(this.name+":scroll:past",this.data()):this.pubsub.fire(this.name+":scroll:not_past",this.data()));this.options.monitorElementScroll&&(this.pubsub.fire(this.name+":scroll",this.data()),this.checkScrollDepth(.5)&&this.pubsub.fire(this.name+":scroll:50%",this.data()),this.isBottom()&&this.pubsub.fire(this.name+":scroll:bottom",this.data()))}this._lastScrollTop=this._el.scrollTop},destroy:function(){n(this._el).off("scroll"),n(window).off("scroll",this._monitor),this.$scrollableParent&&this.$scrollableParent.off("scroll",this._monitor);var e=this;r.delay(function(){e._el=null},this.throttleThreshold+1)}},{factory:function(e,t){return new s(e,t)}}}),define("bs/util/realtime_comments_client",["bs/core","bs/util/xhr","bs/util/realtime_client","lodash","backbone"],function(e,t,n,r,i){function a(t){var i=window.location.protocol.indexOf("https")>-1?"wss":"ws";this.realtimeCommentsClient=n.factory({server:i+"://"+e.config.REALTIME_DIALOG_SERVICE_HOSTNAME+"/v1/ws",debug:document.location.search.indexOf("debug_realtime")!==-1}),this.pollingInterval=o,t&&t.editors_picks_enabled&&s.push("realtime.editors_pick","realtime.editors_pick_removed"),this.realtimeCommentsClient._supported?(this.realtimeCommentsClient.on("message",r.bind(this.messageHandler,this)),this.realtimeCommentsClient.on("close offline",r.bind(this.startPolling,this)),this.realtimeCommentsClient.on("open",r.bind(this.stopPolling,this))):this.startPolling(),this.name="instance_"+Math.floor(Math.random()*1e7),this.lastConnected=Date.now(),this.registeredContentIds={}}var s=["realtime.story_update","realtime.comment","realtime.comment_removed"],o=1e4,u=new t.dataProvider({url:"/api/dialog/events.json",cache:!1});a.prototype={messageHandler:function(e){this.lastConnected=Date.now(),r.contains(s,e.type)&&this.trigger("message:"+e.content_id,e)},onContentIdMessage:function(e,t,n){this.on("message:"+e,t,n),this.registeredContentIds[e]?this.registeredContentIds[e]++:this.registeredContentIds[e]=1},offContentIdMessage:function(e,t,n){this.off("message:"+e,t,n),this.registeredContentIds[e]--,this.registeredContentIds[e]||delete this.registeredContentIds[e]},startPolling:function(){this.isPolling=!0,this.fetchRealtimeEvents()},stopPolling:function(){this.isPolling&&(this.isPolling=!1,this.fetchRealtimeEvents()),this.pollingRef&&(clearTimeout(this.pollingRef),delete this.pollingRef)},fetchRealtimeEvents:function(){var e=this;r.each(r.keys(this.registeredContentIds),function(t){u.request({data:{content_id:t,since:e.lastConnected/1e3},success:r.bind(e.eventsFeedSuccess,e)})}),this.isPolling&&(this.pollingRef=setTimeout(function(){e.isPolling&&e.fetchRealtimeEvents()},this.pollingInterval))},eventsFeedSuccess:function(e){if(!e.data||!e.data.feed)return;r.each(e.data.feed,r.bind(this.messageHandler,this)),e.polling&&e.polling.interval&&(this.pollingInterval=e.polling.interval*1e3)}},r.extend(a.prototype,i.Events);var f,l={factory:function(e){return new a(e)},instance:function(e){return f||(f=l.factory(e)),f}};return l}),define("bs/util/emoji",[],function(){var e=["[\ue000-\uf8ff]","\ud7c9[\ude00-\udfbf]","\ud83c[\udde6-\udfff]","\ud83d[\udc00-\ude4f]","\ud83d[\ude80-\udeff]","\ud83e[\udd00-\uddff]"];return{ranges:e,"char":"(?:"+e.join("|")+")"}}),define("bs/util/autocomplete",["bs/util/xhr","bs/util/helpers","jquery","lodash","modernizr"],function(e,t,n,r,i){function a(e,t){this.$el=n(e),this.options=t||{}}var s=150,o="/api/autocomplete.json",u=new e.dataProvider({url:o});return a.prototype={init:function(){var e=this;if(!this.options.triggers||!this.options.triggers.length)throw Error("Gotta pass at least one trigger for Autocomplete to do anything");this.initializeTriggers(),this.$el.parents(".js--digg-autocomplete--upwards").length&&(this.upwards=!0),this.boundCheckInput=r.bind(this.checkInput,this),this.boundClickOff=r.bind(this.clickOff,this),this.debouncedCheckForTrigger=r.debounce(r.bind(this.checkForTrigger,this),s,{maxWait:250}),this.$el.on("click",this.boundCheckInput).on("keydown",this.boundCheckInput),n(document).on("click",this.boundClickOff)},destroy:function(){this.clearSuggestions(),this.$el.off("click",this.boundCheckInput).off("keydown",this.boundCheckInput),n(document).off("click",this.boundClickOff)},initializeTriggers:function(){this.triggers=this.options.triggers;var e=this;r.each(this.triggers,function(e){var t=e.trigger+e.regexString+"$";e.regex=new RegExp(t);if(e.postCaretRegexString){var n="^"+e.postCaretRegexString;e.postCaretRegex=new RegExp(n)}})},autocompleteFetchSuccess:function(e){e.count?this.showSuggestions(e.html):this.clearSuggestions()},autocompleteFetchError:function(){console.error("failed to get autocomplete response from API",arguments)},checkInput:function(e){var n=this;r.defer(function(){n.caretPosition=t.getCaretPosition(n.$el)});if(e.which&&n.$suggestions&&n.$suggestions.find(".js--digg-autocomplete__suggestion").length&&n.suggestionsUiKeydown(e)===!1)return e.preventDefault(),e.stopImmediatePropagation(),!1;n.debouncedCheckForTrigger()},checkForTrigger:function(){if(this.dontCheck)return;var e=this.$el.text(),t=this.caretPosition,n=e.substr(0,t),i=e.substr(t),s=!1,o=this;r.each(this.triggers,function(e){var t=n,r="";e.postCaretRegex&&(r=(i.match(e.postCaretRegex)||[""])[0],t+=r);var u=(t.match(e.regex)||[""])[0];u=u.replace(e.trigger,"");if(u){if(!o.$suggestions||e.lastMatch!==u)e.lastMatch=u,e.lastMatchEnd=o.caretPosition+r.length,e.lastMatchStart=e.lastMatchEnd-u.length-e.trigger.length,o.currentTriggerObj=e,o.lookup(e,u);return s=!0,!1}}),s||this.clearSuggestions()},lookup:function(e,t){u.request({success:r.bind(this.autocompleteFetchSuccess,this),error:r.bind(this.autocompleteFetchError,this),data:{text:t,category:e.category}})},suggestionsUiKeydown:function(e){var t=this;switch(e.which){case 38:return this.upwards?this.selectNext():this.selectPrevious();case 40:return this.upwards?this.selectPrevious():this.selectNext();case 9:case 13:return r.defer(function(){t.selectSuggestion(t.$suggestions.find(".is--selected"))}),!1;case 27:return this.clearSuggestions(),this.dontCheck=!0,setTimeout(function(){t.dontCheck=!1},s+10),!1}},showSuggestions:function(e){this.$suggestions||(this.$suggestions=n('<div class="digg-autocomplete"></div>'),this.$suggestions.insertAfter(this.$el),this.$suggestions.on("click",".js--digg-autocomplete__suggestion",r.bind(this.mouseSelect,this))),this.$suggestions.html(e)},clearSuggestions:function(){this.$suggestions&&(this.$suggestions.remove(),delete this.$suggestions)},clickOff:function(e){if(e.target===this.$el[0]||this.$el.has(e.target).length)return;this.clearSuggestions()},selectPrevious:function(){var e=this.$suggestions.find(".is--selected"),t=e.prev();if(t.length)return e.removeClass("is--selected"),t.addClass("is--selected"),!1;this.clearSuggestions();return},selectNext:function(){var e=this.$suggestions.find(".is--selected"),t=e.next();if(t.length)return e.removeClass("is--selected"),t.addClass("is--selected"),!1;this.clearSuggestions();return},mouseSelect:function(e){var t=n(e.target);return t.hasClass("js--digg-autocomplete__suggestion")||(t=t.parents(".js--digg-autocomplete__suggestion")),this.selectSuggestion(t),!1},selectSuggestion:function(e){var n=this.currentTriggerObj,r=e.data("value"),i='<a href="#">'+n.trigger+r+"</a>&nbsp;";t.pasteHtmlOverRange(this.$el,i,n.lastMatchStart,n.lastMatchEnd),this.clearSuggestions()}},{factory:function(e,t){return new a(e,t)}}}),define("bs/util/url_fetch",["bs/core","bs/util/xhr","bs/util/validation","lodash"],function(e,t,n,r){function u(e,t){this.url=e,this.options=t||{},this.options.success=this.options.success||$.noop,this.options.error=this.options.error||$.noop,this.options.story_format=this.options.story_format||"social",this.fetchPollingAttempt=0}var i=5,s=new t.dataProvider({url:"/api/url/fetch.json"}),o=new t.dataProvider({cache:!1,url:"/api/url/fetch/status.json"});return u.prototype={fetch:function(){s.request({data:{url:this.url,story_format:this.options.story_format},success:r.bind(this.fetchSuccess,this),error:r.bind(this.fetchError,this)})},fetchSuccess:function(e){e.data&&e.data.polling&&e.data.polling.status===1?this.checkFetchStatus(e.data.content_id):e.html?this.options.success(e):(console.error("unexpected response format",e),this.options.error("Sorry, we ran into a problem!<br>Try entering the link again."))},fetchError:function(e,t,n){console.error("failed to fetch story",arguments),this.options.error("Sorry, we couldn't find anything here.<br>Try entering the link again.")},checkFetchStatus:function(e){this.fetchPollingAttempt++,o.request({data:{content_id:e,story_format:this.options.story_format},success:r.bind(this.checkFetchStatusResponse,this),error:r.bind(this.fetchError,this)})},checkFetchStatusResponse:function(e){if(e.data&&e.data.polling&&e.data.polling.status===1){this.fetchPollingAttempt>2;if(this.fetchPollingAttempt>i)console.error("polling timed out while fetching story",arguments),this.options.error("Sorry, we couldn't find anything at that link.<br>Double-check the link and try entering it again.");else{var t=this;setTimeout(function(){t.checkFetchStatus(e.data.content_id)},e.data.polling.interval*1e3||3e3)}}else e.html?this.options.success(e):(console.error("unexpected response format",e),this.options.error("Sorry, we ran into a problem!<br>Try entering the link again."))}},{factory:function(e,t){return new u(e,t)}}}),function(e,t){typeof define=="function"&&define.amd?define("autolinker",t):typeof exports!="undefined"?module.exports=t():e.Autolinker=t()}(this,function(){var e=function(t){e.Util.assign(this,t)};return e.prototype={constructor:e,urls:!0,email:!0,twitter:!0,newWindow:!0,stripPrefix:!0,className:"",htmlCharacterEntitiesRegex:/(&nbsp;|&#160;|&lt;|&#60;|&gt;|&#62;)/gi,matcherRegex:function(){var e=/(^|[^\w])@(\w{1,15})/,t=/(?:[\-;:&=\+\$,\w\.]+@)/,n=/(?:[A-Za-z]{3,9}:(?:\/\/)?)/,r=/(?:www\.)/,i=/[A-Za-z0-9\.\-]*[A-Za-z0-9\-]/,s=/\.(?:international|construction|contractors|enterprises|photography|productions|foundation|immobilien|industries|management|properties|technology|christmas|community|directory|education|equipment|institute|marketing|solutions|vacations|bargains|boutique|builders|catering|cleaning|clothing|computer|democrat|diamonds|graphics|holdings|lighting|partners|plumbing|supplies|training|ventures|academy|careers|company|cruises|domains|exposed|flights|florist|gallery|guitars|holiday|kitchen|neustar|okinawa|recipes|rentals|reviews|shiksha|singles|support|systems|agency|berlin|camera|center|coffee|condos|dating|estate|events|expert|futbol|kaufen|luxury|maison|monash|museum|nagoya|photos|repair|report|social|supply|tattoo|tienda|travel|viajes|villas|vision|voting|voyage|actor|build|cards|cheap|codes|dance|email|glass|house|mango|ninja|parts|photo|shoes|solar|today|tokyo|tools|watch|works|aero|arpa|asia|best|bike|blue|buzz|camp|club|cool|coop|farm|fish|gift|guru|info|jobs|kiwi|kred|land|limo|link|menu|mobi|moda|name|pics|pink|post|qpon|rich|ruhr|sexy|tips|vote|voto|wang|wien|wiki|zone|bar|bid|biz|cab|cat|ceo|com|edu|gov|int|kim|mil|net|onl|org|pro|pub|red|tel|uno|wed|xxx|xyz|ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)\b/,o=/(?:[\-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[\-A-Za-z0-9+&@#\/%=~_()|])?/;return new RegExp(["(",e.source,")","|","(",t.source,i.source,s.source,")","|","(","(?:","(?:",n.source,i.source,")","|","(?:","(.?//)?",r.source,i.source,")","|","(?:","(.?//)?",i.source,s.source,")",")",o.source,")"].join(""),"gi")}(),invalidProtocolRelMatchRegex:/^[\w]\/\//,charBeforeProtocolRelMatchRegex:/^(.)?\/\//,link:function(t){var n=this,r=this.getHtmlParser(),i=this.htmlCharacterEntitiesRegex,s=0,o=[];return r.parse(t,{processHtmlNode:function(e,t,n){t==="a"&&(n?s=Math.max(s-1,0):s++),o.push(e)},processTextNode:function(t){if(s===0){var r=e.Util.splitAndCapture(t,i);for(var u=0,a=r.length;u<a;u++){var f=r[u],l=n.processTextNode(f);o.push(l)}}else o.push(t)}}),o.join("")},getHtmlParser:function(){var t=this.htmlParser;return t||(t=this.htmlParser=new e.HtmlParser),t},getTagBuilder:function(){var t=this.tagBuilder;return t||(t=this.tagBuilder=new e.AnchorTagBuilder({newWindow:this.newWindow,truncate:this.truncate,className:this.className})),t},processTextNode:function(t){var n=this,r=this.charBeforeProtocolRelMatchRegex;return t.replace(this.matcherRegex,function(t,i,s,o,u,a,f,l){var c=i,h=s,p=o,d=u,v=a,m=f||l,g="",y="",b;if(!n.isValidMatch(c,d,v,m))return t;n.matchHasUnbalancedClosingParen(t)&&(t=t.substr(0,t.length-1),y=")");if(d)b=new e.match.Email({matchedText:t,email:d});else if(c)h&&(g=h,t=t.slice(1)),b=new e.match.Twitter({matchedText:t,twitterHandle:p});else{if(m){var w=m.match(r)[1]||"";w&&(g=w,t=t.slice(1))}b=new e.match.Url({matchedText:t,url:t,protocolRelativeMatch:m,stripPrefix:n.stripPrefix})}var E=n.createMatchReturnVal(b,t);return g+E+y})},isValidMatch:function(e,t,n,r){return e&&!this.twitter||t&&!this.email||n&&!this.urls||n&&n.indexOf(".")===-1||n&&/^[A-Za-z]{3,9}:/.test(n)&&!/:.*?[A-Za-z]/.test(n)||r&&this.invalidProtocolRelMatchRegex.test(r)?!1:!0},matchHasUnbalancedClosingParen:function(e){var t=e.charAt(e.length-1);if(t===")"){var n=e.match(/\(/g),r=e.match(/\)/g),i=n&&n.length||0,s=r&&r.length||0;if(i<s)return!0}return!1},createMatchReturnVal:function(t,n){var r;this.replaceFn&&(r=this.replaceFn.call(this,this,t));if(typeof r=="string")return r;if(r===!1)return n;if(r instanceof e.HtmlTag)return r.toString();var i=this.getTagBuilder(),s=i.build(t);return s.toString()}},e.link=function(t,n){var r=new e(n);return r.link(t)},e.match={},e.Util={abstractMethod:function(){throw"abstract"},assign:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},extend:function(t,n){var r=t.prototype,i=function(){};i.prototype=r;var s;n.hasOwnProperty("constructor")?s=n.constructor:s=function(){r.constructor.apply(this,arguments)};var o=s.prototype=new i;return o.constructor=s,o.superclass=r,delete n.constructor,e.Util.assign(o,n),s},ellipsis:function(e,t,n){return e.length>t&&(n=n==null?"..":n,e=e.substring(0,t-n.length)+n),e},indexOf:function(e,t){if(Array.prototype.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},splitAndCapture:function(e,t){if(!t.global)throw new Error("`splitRegex` must have the 'g' flag set");var n=[],r=0,i;while(i=t.exec(e))n.push(e.substring(r,i.index)),n.push(i[0]),r=i.index+i[0].length;return n.push(e.substring(r)),n}},e.HtmlParser=e.Util.extend(Object,{htmlRegex:function(){var e=/[0-9a-zA-Z:]+/,t=/[^\s\0"'>\/=\x01-\x1F\x7F]+/,n=/(?:".*?"|'.*?'|[^'"=<>`\s]+)/,r=t.source+"(?:\\s*=\\s*"+n.source+")?";return new RegExp(["<(?:!|(/))?","("+e.source+")","(?:","\\s+","(?:",r,"|",n.source+")",")*","\\s*/?",">"].join(""),"g")}(),parse:function(e,t){t=t||{};var n=t.processHtmlNode||function(){},r=t.processTextNode||function(){},i=this.htmlRegex,s,o=0;while((s=i.exec(e))!==null){var u=s[0],a=s[2],f=!!s[1],l=e.substring(o,s.index);l&&r(l),n(u,a,f),o=s.index+u.length}if(o<e.length){var c=e.substring(o);c&&r(c)}}}),e.HtmlTag=e.Util.extend(Object,{whitespaceRegex:/\s+/,constructor:function(t){e.Util.assign(this,t),this.innerHtml=this.innerHtml||this.innerHTML},setTagName:function(e){return this.tagName=e,this},getTagName:function(){return this.tagName||""},setAttr:function(e,t){var n=this.getAttrs();return n[e]=t,this},getAttr:function(e){return this.getAttrs()[e]},setAttrs:function(t){var n=this.getAttrs();return e.Util.assign(n,t),this},getAttrs:function(){return this.attrs||(this.attrs={})},setClass:function(e){return this.setAttr("class",e)},addClass:function(t){var n=this.getClass(),r=this.whitespaceRegex,i=e.Util.indexOf,s=n?n.split(r):[],o=t.split(r),u;while(u=o.shift())i(s,u)===-1&&s.push(u);return this.getAttrs()["class"]=s.join(" "),this},removeClass:function(t){var n=this.getClass(),r=this.whitespaceRegex,i=e.Util.indexOf,s=n?n.split(r):[],o=t.split(r),u;while(s.length&&(u=o.shift())){var a=i(s,u);a!==-1&&s.splice(a,1)}return this.getAttrs()["class"]=s.join(" "),this},getClass:function(){return this.getAttrs()["class"]||""},hasClass:function(e){return(" "+this.getClass()+" ").indexOf(" "+e+" ")!==-1},setInnerHtml:function(e){return this.innerHtml=e,this},getInnerHtml:function(){return this.innerHtml||""},toString:function(){var e=this.getTagName(),t=this.buildAttrsStr();return t=t?" "+t:"",["<",e,t,">",this.getInnerHtml(),"</",e,">"].join("")},buildAttrsStr:function(){if(!this.attrs)return"";var e=this.getAttrs(),t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n+'="'+e[n]+'"');return t.join(" ")}}),e.AnchorTagBuilder=e.Util.extend(Object,{constructor:function(t){e.Util.assign(this,t)},build:function(t){var n=new e.HtmlTag({tagName:"a",attrs:this.createAttrs(t.getType(),t.getAnchorHref()),innerHtml:this.processAnchorText(t.getAnchorText())});return n},createAttrs:function(e,t){var n={href:t},r=this.createCssClass(e);return r&&(n["class"]=r),this.newWindow&&(n.target="_blank"),n},createCssClass:function(e){var t=this.className;return t?t+" "+t+"-"+e:""},processAnchorText:function(e){return e=this.doTruncate(e),e},doTruncate:function(t){return e.Util.ellipsis(t,this.truncate||Number.POSITIVE_INFINITY)}}),e.match.Match=e.Util.extend(Object,{constructor:function(t){e.Util.assign(this,t)},getType:e.Util.abstractMethod,getMatchedText:function(){return this.matchedText},getAnchorHref:e.Util.abstractMethod,getAnchorText:e.Util.abstractMethod}),e.match.Email=e.Util.extend(e.match.Match,{getType:function(){return"email"},getEmail:function(){return this.email},getAnchorHref:function(){return"mailto:"+this.email},getAnchorText:function(){return this.email}}),e.match.Twitter=e.Util.extend(e.match.Match,{getType:function(){return"twitter"},getTwitterHandle:function(){return this.twitterHandle},getAnchorHref:function(){return"https://twitter.com/"+this.twitterHandle},getAnchorText:function(){return"@"+this.twitterHandle}}),e.match.Url=e.Util.extend(e.match.Match,{urlPrefixRegex:/^(https?:\/\/)?(www\.)?/i,protocolRelativeRegex:/^\/\//,checkForProtocolRegex:/^[A-Za-z]{3,9}:/,getType:function(){return"url"},getUrl:function(){var e=this.url;return!this.protocolRelativeMatch&&!this.checkForProtocolRegex.test(e)&&(e=this.url="http://"+e),e},getAnchorHref:function(){var e=this.getUrl();return e.replace(/&amp;/g,"&")},getAnchorText:function(){var e=this.getUrl();return this.protocolRelativeMatch&&(e=this.stripProtocolRelativePrefix(e)),this.stripPrefix&&(e=this.stripUrlPrefix(e)),e=this.removeTrailingSlash(e),e},stripUrlPrefix:function(e){return e.replace(this.urlPrefixRegex,"")},stripProtocolRelativePrefix:function(e){return e.replace(this.protocolRelativeRegex,"")},removeTrailingSlash:function(e){return e.charAt(e.length-1)==="/"&&(e=e.slice(0,-1)),e}}),e}),define("bs/widgets/url_embed",["bs/core","bs/util/xhr","bs/util/validation","bs/util/helpers","bs/util/fx","bs/util/url_fetch","autolinker","lodash"],function(e,t,n,r,i,s,o,u){function a(e){var t=[];return o.link(e,{email:!1,phone:!1,twitter:!1,hashtag:!1,replaceFn:function(e,n){return n.getType()==="url"&&t.push(n.getUrl()),!1}}),t}function f(e){e=e||{},this.$input=$(e.input),this.$el=$(e.el);if(!this.$input.length||!this.$el.length)throw Error("Must provide input and el");this.$input.on("paste.diggUrlEmbed",u.bind(this.inputPaste,this)).on("keyup.diggUrlEmbed",u.debounce(u.bind(this.inputKeyup,this),1e3)),this.$el.on("click.diggUrlEmbed",".js--url-embed__remove",u.bind(this.clear,this))}return f.prototype={destroy:function(){this.$input.off(".diggUrlEmbed"),this.$el.off(".diggUrlEmbed")},inputPaste:function(e){var t=r.getClipboardText(e),n=a(t);this.processUrls(n)},inputKeyup:function(e){var t=a(r.getTextWithLineBreaks(this.$input));this.processUrls(t)},processUrls:function(e){if(this.url)return;if(!e.length)return;var t=e[0];this.hideEmbed(),this.url=t,this.showEmbed(t)},clear:function(){this.contentId=null,this.url=null,this.hideEmbed()},showEmbed:function(e){this.$el.addClass("is--loading"),s.factory(e,{story_format:"embed",success:u.bind(this.urlFetchSuccess,this),error:u.bind(this.urlFetchError,this)}).fetch()},hideEmbed:function(){if(!this.$embed)return;var e=this;i.slideFadeOut(this.$embed,{cb:function(){e.$el.find(".js--url-embed__embed-wrapper").empty(),e.$embed=null}})},urlFetchSuccess:function(e){this.$el.removeClass("is--loading");if(!this.url)return;this.contentId=e.content_id,this.$embed=i.slideFadeAppendTo($(e.html),this.$el.find(".js--url-embed__embed-wrapper"))},urlFetchError:function(e){this.$el.removeClass("is--loading");if(!this.url)return;this.contentId=null,this.url=null}},{factory:function(e){return new f(e)}}}),define("bs/model/new_comment",["bs/core","bs/util/xhr","bs/util/helpers","bs/util/fx","bs/util/emoji","bs/util/autocomplete","bs/widgets/url_embed","backbone","jquery","lodash"],function(e,t,n,r,i,s,o,u,a,f){function h(e,n){f.extend(this,Backbone.Events),this.$el=e instanceof a?e:a(e),this.$inputEl=this.$el.find(".js--digg-new-comment__input");if(!this.$el.length)throw Error("Missing el argument or el selector matched nothing:",e);if(n.standalone&&(!n.content_id||!n.submittedContainer))throw Error("New Comment widget must be passed story content_id and submittedContainer if instantiated in standalone mode!");this.options=n||{},this.commentSubmitDataProvider=new t.dataProvider({type:"POST",cache:!1,url:"/api/comment/submit.json",success:f.bind(this.submitSuccess,this),error:f.bind(this.submitError,this)})}var l=1e3,c=["digg_dialog_trusted_user","digg_dialog_editor","digg_dialog_moderator"];return h.prototype={charLimit:l,init:function(){return this.initialized?this:(this.initialized=!0,this.$inputEl.is(":disabled")&&this.clear(),n.plainTextPaste(this.$inputEl),n.inputLimit(this.$inputEl,l,f.bind(this.commentUnderLimit,this),f.bind(this.commentOverLimit,this)),this.autocomplete=s.factory(this.$inputEl,{triggers:[{trigger:"@",regexString:"\\w+ ?\\w*",postCaretRegexString:"\\w*",category:"users"},{trigger:"#",regexString:"[\\d_]*([a-zA-Z]|"+i.char+")(\\w|"+i.char+")*",postCaretRegexString:"(\\w|"+i.char+")*",category:"tags"}]}),this.autocomplete.init(),this.$el.on("click",".js--digg-new-comment__cancel",f.bind(this.cancel,this)).on("click",".js--digg-new-comment__submit",f.bind(this.submit,this)),this.$inputEl.on("keydown",f.bind(this.checkForEnter,this)),this.urlEmbed=o.factory({el:this.$el.find(".js--url-embed"),input:this.$inputEl}),this)},destroy:function(){n.destroyInputLimit(this.$inputEl),n.destroyPlainTextPaste(this.$inputEl),this.autocomplete.destroy(),this.urlEmbed&&this.urlEmbed.destroy(),this.$el.empty()},checkForEnter:function(e){if(this.options.modKeySubmit&&!e.ctrlKey&&!e.shiftKey&&!e.metaKey)return;if(e.keyCode===13){var t=e.ctrlKey||e.shiftKey||e.metaKey;if(this.options.modKeySubmit&&t||!this.options.modKeySubmit&&!t)this.submit(),e.preventDefault()}},commentUnderLimit:function(){this.$el.removeClass("has--submit-error").find(".js--digg-new-comment__submit").removeClass("is--disabled"),this.trigger("under_limit")},commentOverLimit:function(){this.$el.find(".js--digg-new-comment__submit").addClass("is--disabled"),this.trigger("over_limit")},showAndFocus:function(e){function n(){a("body").removeClass("is--adding-comment"),t.focus(),typeof e=="function"&&e()}a("body").addClass("is--adding-comment");var t=this;r.scrollToEl(this.$inputEl,{onlyDown:!0,scrollToBottom:!0,notPastTop:!0,bottomOffset:120,cb:function(){if(t.options.parentEl){var e=a(t.options.parentEl).find(".js--digg-comment__reply-area");r.slideFadeIn(e,{cb:n})}else n()}})},focus:function(e){this.$inputEl[0].focus()},blur:function(){this.$inputEl[0].blur()},clear:function(){this.clearText(),this.clearState()},clearText:function(){this.$inputEl.html("")},setText:function(e,t){var r=e;r.indexOf(" ")===0&&(r="&nbsp;"+r.substr(1)),r.lastIndexOf(" ")===r.length-1&&(r=r.substring(0,r.length-1)+"&nbsp;"),this.$inputEl.html(r);if(t){var i=this;this.showAndFocus(function(){n.setContenteditableCaretPosition(i.$inputEl,e.length)})}},setCaretAtEnd:function(){n.setContenteditableCaretPosition(this.$inputEl,this.getText().length)},getText:function(){return n.getTextWithLineBreaks(this.$inputEl).trim()},isOverLimit:function(){return this.getText().length>l},clearState:function(){this.$inputEl.attr("contenteditable",!0),this.submitting=!1,this.$el.removeClass("has--submit-error is--submitting").find(".js--digg-new-comment__submit").removeClass("has--loading-bars")},enableSubmittingState:function(){this.clearState(),this.submitting=!0,this.$inputEl.removeAttr("contenteditable"),this.$el.removeClass("has--submit-error").addClass("is--submitting").find(".js--digg-new-comment__submit").addClass("has--loading-bars")},submitErrorState:function(e){this.clearState(),this.$el.addClass("has--submit-error").find(".js--digg-new-comment__error-message").html(e),this.focus()},submit:function(){if(this.submitting)return;var e=this.getText();if(!e)return;this.clearState(),this.trigger("submit",e);if(!this.options.standalone)return;if(this.isOverLimit()){this.submitErrorState("Your comment can't be longer than "+l+" characters!");return}var t={content_id:this.options.content_id,comment_text:e};this.options.realtimeEnabled&&(t.flat_mode=!0),this.options.in_reply_to_comment_id&&(t.in_reply_to_comment_id=this.options.in_reply_to_comment_id),this.urlEmbed&&this.urlEmbed.contentId&&(t.url_preview_content_id=this.urlEmbed.contentId);var n=this.$el.closest("[data-slug]").data("slug");n&&(t.slug=n),this.commentSubmitDataProvider.request({data:t}),this.enableSubmittingState()},submitSuccess:function(e){this.trigger("submit_success",e);if(this.options.parentEl){var t=a(this.options.parentEl);t.removeClass("has--no-children has--no-children--displayed"),r.slideFadeOut(t.find(".js--digg-comment__reply-area"),{cb:f.bind(this.clear,this)})}else this.clear();this.urlEmbed&&this.urlEmbed.clear(),this.handleNewComment(e.html)},submitError:function(e,t,n){var r="Sorry, there was an error - we're working on it! Try again.";throw this.trigger("submit_error",r),this.clearState(),this.options.standalone&&this.submitErrorState(r),new Error('Failed to submit new comment. Comment text: "'+this.getText()+'". Options: '+JSON.stringify(this.options)+". Status: "+t+". API response: "+(e?e.responseText:""))},handleNewComment:function(e){var t;typeof this.options.submittedContainer=="function"?t=a(this.options.submittedContainer()):t=a(this.options.submittedContainer);var n=a(e);n.addClass("slide-fade pre-slide-fade");if(this.commentAlreadyHere(n.data("commentId"))){this.incrementCommentCounts(),this.blur(),this.clear();return}n.appendTo(t),n.parents(".is--empty").removeClass("is--empty"),a("body").addClass("is--adding-comment");var i=!1,s=0;if(this.options.parentEl)if(this.options.realtimeEnabled&&this.segment==="all"){var o=a(this.options.parentEl).find(".js--digg-comment__reply-area");s=o.outerHeight(!0)}else i=!0;var u=this;r.scrollToEl(n,{onlyIfNotInViewport:i,scrollToBottom:!0,notPastTop:!0,bottomOffset:175+s,cb:function(){r.slideFadeIn(n,{cb:function(){u.incrementCommentCounts(),u.blur(),u.clear(),setTimeout(function(){a("body").removeClass("is--adding-comment")},500)}})}})},commentAlreadyHere:function(e){var t=this.$el.closest(".js--digg-comment__list");return t.length?!!t.find('[data-comment-id="'+e+'"]').length:!!a('[data-comment-id="'+e+'"]').length},incrementCommentCounts:function(){},cancel:function(e){this.blur();var t=this.$el.closest(".js--digg-comment__reply-area");if(t.length){var n=this;r.slideFadeOut(t,{cb:function(){n.clear()}})}else this.clear();this.urlEmbed&&this.urlEmbed.clear(),e.preventDefault()}},{factory:function(e,t){var n=new h(e,t);return a(e).data("newCommentModule",n),n},ensureInstantiated:function(e,t,n){var r=a(e).data("newCommentModule");return r?n&&(r.options=t):(r=new h(e,t),a(e).data("newCommentModule",r)),r}}}),define("bs/util/comments",["bs/core","bs/util/xhr","bs/util/realtime_comments_client","bs/util/format","bs/util/helpers","bs/util/fx","bs/util/scrollmonitor","bs/model/new_comment","modernizr","lodash"],function(e,t,n,r,i,s,o,u,a,f){function y(e){return e.parents(".js--digg-story").last()}function b(e){var t=Infinity;return e.find("[data-comment-timestamp]").each(function(){t=Math.min(parseInt($(this).data("commentTimestamp"),10),t)}),t===Infinity?null:t}function w(){$(".js--digg-comment__timestamp__text").each(function(){var e=$(this),t=e.closest("[datetime]").attr("datetime");t=t.replace(/-/g,"/");var n=new Date(t);e.html(r.secondsToFuzzyTime(n.getTime()/1e3,!0)),e.attr("title",n.toLocaleString())})}function E(e){e.addClass("is--highlighted"),f.delay(function(){e.removeClass("is--highlighted")},2500)}function S(e,t){var n=t.data("commentIdsSeen")||{},r=e.filter(function(){if($(this).hasClass("js--digg-comment"))return n[$(this).data("commentId")]?!1:(n[$(this).data("commentId")]=!0,$(this).find(".js--digg-comment--child").each(function(){n[$(this).data("commentId")]=!0}),!0)});return t.data("commentIdsSeen",n),r}function x(e){var t=e.data("commentIdsSeen")||{};e.find(".js--digg-comment").each(function(){t[$(this).data("commentId")]=!0}),e.data("commentIdsSeen",t)}function T(e){e.preventDefault(),$(this).closest(".js--digg-comment__body").addClass("has--full-text-visible"),$(e.target).remove()}function N(e){if(parseInt($(this).data("commentCount"),10)!==0)return;var t=y($(this)).find(".js--digg-new-comment--top-level").last(),n=C.call(t);n&&(n.showAndFocus(),e.preventDefault())}function C(e){var t=$(this),n=t.closest(".js--digg-story");if(n.length===0)return;var r=u.ensureInstantiated(t,{standalone:!0,content_id:n.data("contentId"),submittedContainer:n.find(".js--digg-comment__list__comments-container")});return r.init(),r}function k(e){e&&e.preventDefault&&e.preventDefault();if($("body").hasClass("is--realtime-state--closed"))return;var t=$(this).closest(".js--digg-comment"),n=y(t),r=t.closest("[data-realtime-enabled]").data("realtimeEnabled"),i=t.closest("[data-segment]").data("segment"),s,o,a;$(this).parents(".js--digg-story--compact").length?(o=n.find(".js--digg-story__new-comment .js--digg-new-comment"),a=n.find(".js--digg-comment__list__comments-container")):r&&i==="all"?(a=n.find(".js--digg-comment__list__comments-container"),o=t.find(".js--digg-new-comment"),o.length||(s=t.parent().closest(".js--digg-comment"),o=s.find(".js--digg-new-comment"))):t.hasClass("js--digg-comment--child")?(s=t.parent().closest(".js--digg-comment"),a=s.find(".js--digg-comment__children"),o=s.find(".js--digg-new-comment")):(a=t.find(".js--digg-comment__children"),o=t.find(".js--digg-new-comment"));if(!o.length){var f=$(".js--digg-comment__reply-area--clone-me .js--digg-comment__reply-area-wrapper").first().clone();f.insertAfter(t.find(".js--digg-comment__body")),o=f.find(".js--digg-new-comment"),s=t}var l=u.ensureInstantiated(o,{standalone:!0,content_id:n.data("contentId"),in_reply_to_comment_id:t.data("commentId"),parentEl:s||t,submittedContainer:a,realtimeEnabled:r},!0);l.init();var c=L(t);l.setText(c,!0)}function L(t){var n={};return $commentBody=t.children(".js--digg-comment__body"),n[$commentBody.find(".js--digg-user").data("username")]=!0,$commentBody.find(".js--digg-comment__text").find(".js--digg-user-link").each(function(){n[$(this).data("username")]=!0}),delete n[e.user.get("username")],f.size(n)===0?"":"@"+f.keys(n).join(" @")+" "}function A(e){e.preventDefault();var t=$(this).closest(".js--digg-comment"),n=t.data("commentId"),r=t.data("nextPosition")||b(t);t.addClass("is--loading").removeClass("has--child-pagination-error"),m.request({data:{comment_id:n,position:r,slug:this.permalinkWidget.slug},success:f.partial(O,t),error:f.partial(_,t)})}function O(e,t){var n=S($(t.html),e.find(".js--digg-comment__children"));n.length?(s.slideFadePrependTo(n,e.find(".js--digg-comment__children"),{cb:f.partial(M,e,t)}),e.removeClass("has--no-children-displayed")):M(e,t),e.data("nextPosition",t.next_position)}function M(e,t){var n=e.find(".js--digg-comment__thread-pagination"),r=parseInt(e.data("commentChildCount"),10)-e.find(".js--digg-comment").length;r<=0||t.next_position==-1?(e.removeClass("has--more-children"),i.onTransitionEnd(n,function(){e.removeClass("is--loading")})):e.removeClass("is--loading")}function _(e){console.error("failed to paginate thread",arguments),e.find(".js--digg-comment__child-pagination__error").html(l),e.removeClass("is--loading").addClass("has--child-pagination-error")}function D(e){this.$el=$(e.el),this.content_id=e.content_id,this.segment=e.segment,this.permalinkWidget=e.permalinkWidget;if(!this.$el.length||!this.content_id||!this.segment||!this.permalinkWidget)throw Error("CommentsWidget requires `el`, `content_id`, `segment`, and `permalinkWidget` parameters");this.options=e}var l="There was a problem, sorry! Give it another shot.",c=".is--special-user--dialog\\.guest",h="is--tooltip-visible",p=["a","button","input","[contenteditable]",".js--show-story-embed",".js--digg-story__video-embed",".js--digg-autocomplete__suggestion",".js--digg-user",".js--digg-user-link"].join(", "),d=new t.dataProvider({url:"/api/comment/info.json"}),v=new t.dataProvider({url:"/api/comment/thread.json"}),m=new t.dataProvider({cache:!1,url:"/api/comment/replies.json"}),g={all:new t.dataProvider({cache:!1,url:"/api/comments/all.json"}),live:new t.dataProvider({cache:!1,url:"/api/comments/live.json"}),answered:new t.dataProvider({cache:!1,url:"/api/comments/answered.json"}),mostdugg:new t.dataProvider({cache:!1,url:"/api/comments/mostdugg.json"}),editorspicks:new t.dataProvider({cache:!1,url:"/api/comments/editorspicks.json"}),network:new t.dataProvider({cache:!1,url:"/api/comments/network.json"})};return D.prototype={init:function(){if(this.options.loadOnScroll)if(i.isElementInDocViewport(this.$el))this.loadComments();else{this.scrollmonitor=o.factory(this.$el[0],{name:this.segment+"_comments",monitorElementScroll:!1,monitorScrollableParent:!0,pubsub:e.pubsub});var t=this;e.pubsub.on(this.segment+"_comments",this.segment+"_comments:scroll:bottom",function(){t.detachScrollMonitor(),t.loadComments()})}else this.options.alreadyLoaded?(this.loaded=Date.now(),this.next_position=this.$el.data("nextPosition")||b(this.$el),this.$el.removeClass("is--loading"),x(this.$el),this.maybeListenForLiveComments()):this.options.noInitialLoad||this.loadComments();this.$el.on("click",".js--digg-comment__list__btn-view-new-comments",f.bind(this.viewUnseenComments,this)).on("click",".js--digg-comment__thread-permalink",f.bind(this.openThreadPermalink,this)).on("mousedown",".js--digg-comment",f.bind(this.commentMousedown,this)).on("mouseenter",".js--digg-comment",f.bind(this.commentMouseenter,this)).on("mouseleave",".js--digg-comment",f.bind(this.commentMouseleave,this)).on("click",".js--digg-comment__top-level-pagination",f.bind(this.loadComments,this)),this.unseenCommentsCount=0},destroy:function(){this.scrollmonitor&&this.detachScrollMonitor(),this.$el.empty(),this.isListeningForLiveComments&&this.stopListeningForLiveComments()},clearComments:function(){this.$el.data("commentIdsSeen",{}).find(".js--digg-comment__list__comments-container").empty(),this.next_position=null},detachScrollMonitor:function(){this.scrollmonitor&&(this.scrollmonitor.destroy(),delete this.scrollmonitor),e.pubsub.off(this.segment+"_comments",this.segment+"_comments:scroll:bottom")},loadCommentId:function(e,t){var n=this.$el.find('[data-short-comment-id="'+e+'"], [data-comment-id="'+e+'"]');if(n.length){E(n);return}this.clearComments(),this.detachScrollMonitor(),this.loading=!0,this.$el.addClass("is--loading").removeClass("has--pagination-error");var r={comment_id:e,slug:this.permalinkWidget.slug},i=this;v.request({data:r,success:function(){i.loading=!1,i.loaded=Date.now(),t.success&&t.success.apply(null,arguments),i.loadSuccess.apply(i,arguments);var n=i.$el.find('[data-comment-id="'+e+'"]');n.length||(n=i.$el.find('[data-short-comment-id="'+e+'"]')),n.hasClass("js--digg-comment--child")&&E(n)},error:function(){i.loading=!1,t.error&&t.error.apply(null,arguments),i.loadError.apply(i,arguments)}})},loadComments:function(e){this.loading=!0,this.$el.addClass("is--loading").removeClass("has--pagination-error");var t="oldest",n="newer";e&&$(e.target).parents(".js--digg-comment__pagination--older").length&&(t="newest",n="older");var r=g[this.segment];this.segment==="all"&&this.options.realtimeEnabled&&(r=g.live),r.request({data:{content_id:this.content_id,start_from:t,position:this.next_position||null,slug:this.permalinkWidget.slug},success:f.bind(function(e){this.loadSuccess(e,n)},this),error:f.bind(this.loadError,this)}),e&&e.preventDefault&&e.preventDefault(),this.maybeListenForLiveComments()},loadSuccess:function(e,t){function r(){var e=this.$el.find(".js--digg-comment__top-level-pagination");this.next_position==-1?this.$el.addClass("has--no-more-comments").removeClass("has--more-comments"):this.$el.addClass("has--more-comments").removeClass("has--no-more-comments"),this.$el.removeClass("is--loading"),n.length>0&&this.$el.removeClass("has--no-comments-displayed")}this.loading=!1,this.loaded=Date.now();var n=$(e.html);n=S(n,this.$el),e.next_position&&(this.next_position=e.next_position);var i=f.bind(r,this);n.length?s.slideFadeAddTo(n,t==="older"?"prependTo":"appendTo",this.$el.find(".js--digg-comment__list__comments-container"),{cb:i}):i()},loadError:function(e,t,n){throw this.loading=!1,this.$el.find(".js--digg-comment__pagination__error").html(l),this.$el.removeClass("is--loading").addClass("has--pagination-error"),new Error("Failed to load comments. Status: "+t+". API response: "+(e?e.responseText:""))},commentMouseenter:function(e){$(e.currentTarget).addClass("is--mouse-active")},commentMouseleave:function(e){$(e.currentTarget).removeClass("is--mouse-active")},commentMousedown:function(e){function s(t){r=e.pageX,i=e.pageY,$(document).off("mousemove.commentClickDetection",s)}function o(t){typeof r=="undefined"&&n.openThreadPermalink(e,!0),Math.abs(r-t.pageX)<3&&Math.abs(i-t.pageY)<3&&n.openThreadPermalink(e,!0),$(document).off(".commentClickDetection")}var t=$(e.target);if(t.is(p)||t.parents(p).length)return;e.stopPropagation();var n=this,r,i;$(document).on("mousemove.commentClickDetection",s),$(document).on("mouseup.commentClickDetection",o)},openThreadPermalink:function(e,t){var n;$(e.target).is(".js--digg-comment")?n=$(e.target):n=$(e.target).closest(".js--digg-comment");if(!n||!n.length)throw Error("could not find comment element");var r=n.find("."+h);if(r.length){r.removeClass(h);return}if(t){$readMore=n.find("> .js--digg-comment__body .js--digg-comment__text__read-more");if($readMore.length)return $readMore.trigger("click"),e.preventDefault(),!1}e.preventDefault(),location.href="#"+n.data("shortCommentId")},maybeListenForLiveComments:function(){if(this.isListeningForLiveComments||this.segment!=="all"&&this.segment!=="answered"&&this.segment!=="editorspicks")return;this.isListeningForLiveComments=!0;var e=i.deparam(location.search.substr(1));if(e.ama_example_url&&!e.unlive){this.listenForFakeAmaComments(e.ama_example_url);return}n.instance().on("message:"+this.content_id,this.onRealtimeMessage,this)},stopListeningForLiveComments:function(){n.instance().off("message:"+this.content_id,null,this)},listenForFakeAmaComments:function(e){var n=i.deparam(location.search.substr(1));this.ama_example_url=n.ama_example_url;var r=n.min_seconds*1e3||5e3,s=n.max_seconds*1e3||15e3,o=s-r,u=this;(new t.dataProvider({url:"/api/url/content.json",data:{content_id:this.content_id,format:"json",ama_example_url:this.ama_example_url},success:function(e){function n(i){if(e.realtime_messages.length>0){if(i===!0&&!t)return;u.onRealtimeCommentMessage(e.realtime_messages.shift()),i===!0&&setTimeout(function(){n(!0)},~~(Math.random()*o+r))}}var t=!1,i=$("#fake-dialog-controls");i.length||(i=$('<span id="fake-dialog-controls" style="font-size: 13px; line-height: 14px; position: fixed; bottom: 10px; left: 10px; z-index: 10000; background-color: rgba(255,255,255,0.8);">live updates: <a href="javascript:void(0)" class="toggle">off</a><br><a href="javascript:void(0)" class="more">get next live comment<a></span>'),$("body").append(i)),i.find(".more").on("click",n),i.find(".toggle").on("click",function(){$(this).html()==="off"?($(this).html("on"),t=!0,n(!0)):($(this).html("off"),t=!1)})},error:function(){console.error("failed to hit permalink API to get fake live comment data",arguments),alert("failed to hit permalink API to get fake live comment data")}})).request()},onRealtimeMessage:function(e){e.type==="realtime.comment"&&this.segment!=="editorspicks"||e.type==="realtime.editors_pick"?this.onRealtimeCommentMessage(e):e.type==="realtime.comment_removed"?this.onRealtimeCommentRemoval(e):e.type==="realtime.editors_pick_removed"&&this.onRealtimeEditorsPickRemoval(e)},onRealtimeCommentRemoval:function(e){var t=$('[data-comment-id="'+e.comment_id+'"]');if(!t.length)return;t.addClass("is--deleted is--deleted-live");if(!t.find(".js--digg-comment__children").children().length){var n=t[0].getBoundingClientRect(),r=window.innerHeight||document.documentElement.clientHeight,o=n.top>r;(o||i.isMidOfElInDocViewport(t))&&setTimeout(function(){s.slideFadeOut(t)},2e3)}},onRealtimeEditorsPickRemoval:function(e){$('[data-comment-id="'+e.comment_id+'"]').removeClass("is--editors-pick").find(".js--toggle-editors-pick-btn").html("Editors' Pick"),$(".js--digg-permalink__comments--editorspicks").find('[data-comment-id="'+e.comment_id+'"]').remove()},onRealtimeCommentMessage:function(e){if(this.handleRealtimeCommentInWidget(e.comment_id,e.type))return;this.liveLoadNewComment(e.comment_id)},handleRealtimeCommentInWidget:function(e,t){var n=this.$el.find('[data-comment-id="'+e+'"]');return n.length?(n.hasClass("is--pending-moderation")&&(n.removeClass("is--pending-moderation"),E(n)),t==="realtime.editors_pick"&&n.addClass("is--editors-pick"),!0):!1},liveLoadNewComment:function(e){data={comment_id:e,flat_mode:!0,use_anonymous:!0,include_context:!0,slug:this.permalinkWidget.slug},this.ama_example_url&&(data.ama_example_url=this.ama_example_url),d.request({data:data,success:f.bind(this.liveCommentLoaded,this,e),error:function(){console.error("failed to fetch realtime comment",e,arguments)}})},liveCommentLoaded:function(e,t){if(this.handleRealtimeCommentInWidget(e))return;var n=$(t.html),r=!1,i=n.find(".js--digg-comment--child").last();i.length?i.find(c).length&&(r=!0):n.find(c).length&&(r=!0);if(this.segment==="answered"){if(!r)return}else if(this.segment==="all"&&!r){var s=n.find(".js--digg-comment--child");s.length&&(n=s.last())}this.liveInsertPacket(n)},liveInsertPacket:function(e){var t=e.find(".js--digg-comment--child").data("parentCommentId"),n;if(t){var r=this.$el.find(".js--digg-comment--top-level").last();if(r.data("commentId")===t){e=e.find(".js--digg-comment--child"),e.length>1&&(e=e.filter(function(){var e=$(this).data("commentId");return r.find('[data-comment-id="'+e+'"]').length?!1:!0}));if(e.length===0){console.warn("Childless parent or all duplicate comments in realtime comment response");return}n=r.find(".js--digg-comment__children")}else n=this.$el.find(".js--digg-comment__list__comments-container")}else n=this.$el.find(".js--digg-comment__list__comments-container");e.addClass("is--unseen"),n.parents(".js--digg-permalink__comments__segment").removeClass("is--empty");var i=this.$el.find(".digg-comment").last(),o=this;s.slideFadeAppendTo(e,n,{cb:function(){n.parents(".js--digg-comment").removeClass("has--no-children has--no-children-displayed"),o.indicateNewLiveComment(i,e)}})},indicateNewLiveComment:function(t,n){var r=t.length&&i.isBottomOfElInDocViewport(t,-50),u=i.isMidOfElInDocViewport(n,-50),l=a.prefixed("visibilityState",document);if(this.isActive&&l!=="hidden"&&u)f.defer(function(){n.removeClass("is--unseen")});else if(this.isActive&&l!=="hidden"&&r)$("body").addClass("is--adding-comment"),s.scrollToEl(n,{scrollToBottom:!0,notPastTop:!0,onlyDown:!0,bottomOffset:60,duration:500,cb:function(){$("body").removeClass("is--adding-comment")}}),f.defer(function(){n.removeClass("is--unseen")});else{this.$el.addClass("has--unseen-comments"),this.unseenCommentsScrollMonitor||(this.unseenCommentsScrollMonitor=o.factory(n.find(".js--digg-comment__body").first(),{name:this.segment+"_unseen_comments",pubsub:e.pubsub,monitorElementScroll:!1,monitorWindowScroll:!0,bottomThreshold:25}),e.pubsub.one(this.segment+"_unseen_comments",this.segment+"_unseen_comments:scroll:bottom",f.bind(this.newLiveCommentsSeen,this)),l==="hidden"&&this.checkUnseenCommentWhenPageVisible(n)),this.unseenCommentsCount++;var c="View "+this.unseenCommentsCount+" new comment"+(this.unseenCommentsCount===1?"":"s")+" \u2193";this.$el.find(".js--digg-comment__list__btn-view-new-comments").html(c),this.segment==="all"&&i.setCountInTitle(this.unseenCommentsCount)}},checkUnseenCommentWhenPageVisible:function(e){var t=this,n=function(){a.prefixed("visibilityState",document)==="visible"&&(i.offVisibilityChange(n),i.isMidOfElInDocViewport(e,-50)&&t.newLiveCommentsSeen())};i.onVisibilityChange(n)},viewUnseenComments:function(){var e=this.$el.find(".is--unseen").first();this.newLiveCommentsSeen({force:!0});if(!e.length){console.warn("Could not find any unseen comments, why was button still visible?");return}s.scrollToEl(e,{duration:750,onlyDown:!0,offsetBeyondHeader:-40})},newLiveCommentsSeen:function(e){e=e||{};if(!this.isActive&&!e.force)return;this.$el.removeClass("has--unseen-comments"),this.$el.find(".is--unseen").removeClass("is--unseen");var t=this;f.defer(function(){t.unseenCommentsScrollMonitor&&(t.unseenCommentsScrollMonitor.destroy(),delete t.unseenCommentsScrollMonitor)}),this.unseenCommentsCount=0,this.segment==="all"&&i.setCountInTitle(this.unseenCommentsCount)}},{isInitialized:!1,init:function(t){if(this.isInitialized)return;this.isInitialized=!0,$(document).on("click",".js--comment-dialog-onboard",e.user.authorized($.noop,null,{requireUsername:!0})).on("click",".js--digg-comment__text__read-more",T).on("click",".js--digg-story__metadata-comments-link",N).on("click",".js--digg-new-comment",C).on("click",".js--digg-comment__reply",e.user.authorized(k,null,{requireUsername:!0})).on("click",".js--digg-comment__thread-pagination",A),setInterval(w,6e4)},commentsWidgetFactory:function(e){return new D(e)}}}),define("bs/widgets/story_permalink",["require","bs/core","bs/util/xhr","bs/util/helpers","bs/util/tracker","bs/util/tracking_v2","bs/util/fx","bs/util/scrollmonitor","bs/util/realtime_comments_client","bs/util/comments","bs/model/new_comment","modernizr","jquery","lodash"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function S(e){var t=e.match(/\/s\/[^\/]*\/([^\/#]*)/);return t&&t[1]?t[1]:null}function x(e){return(e.match(/\|/g)||[]).length===2||(e.match(/!/g)||[]).length===2||(e.match(/-/g)||[]).length===2}function C(e,t){if(!e)throw Error("el parameter required for StoryPermalink!");this.$el=h(e),this.options=t||{},this.options.commentsMode=!0,this.content_id=this.$el.data("contentId"),this.realtimeEnabled=this.$el.data("realtimeEnabled"),this.slug=this.$el.data("slug"),this.guestName=this.$el.data("guestName"),this.userIsGuest=this.$el.data("isGuest");if(!this.content_id)throw Error("could not find content_id in given story permalink element")}var d=new i,v=1200,m=480,g="#js--digg-permalink-modal",y=15e3,b=500,w={CLOSED:0,LIVE:1,OPEN:2,PRE_GAME:3,POST_GAME:4},E={0:"closed",1:"live",2:"open",3:"pre-game",4:"post-game"},T=new n.dataProvider({}),N=new n.dataProvider({cache:!1,url:"/api/url/content.json"});C.prototype={init:function(){var t;e(["bs/util/item_actions"],function(e){e.init()}),this.$el.data("isEditorsPicksVisible")&&(t={editors_picks_enabled:!0}),a.instance(t).onContentIdMessage(this.content_id,this.onRealtimeMessage,this),f.init(),this.initComments(),this.initStickyCommentTabs(),this.activeSegment=this.comments.all,this.activeSegment.isActive=!0,this.activeSegmentId="all",this.activeSegmentName="All",this.handleHashChange(),this._boundHandleHashChange||(this._boundHandleHashChange=p.bind(this.handleHashChange,this)),h(window).on("hashchange",this._boundHandleHashChange)},initComments:function(){this.initNewComments(),this.comments={};var e=h(".js--digg-permalink__comments__segment").map(function(){return h(this).data("segment")}),t=this;p.each(e,function(e){widgetOptions={el:t.$el.find(".js--digg-permalink__comments--"+e+" .js--digg-comment__list"),content_id:t.content_id,segment:e,realtimeEnabled:t.realtimeEnabled,permalinkWidget:t},e==="all"?widgetOptions.alreadyLoaded=!0:widgetOptions.noInitialLoad=!0,t.comments[e]=f.commentsWidgetFactory(widgetOptions),t.comments[e].init()}),this.$el.on("click",".js--nav-btn--permalink-comments-segment",p.bind(this.commentSegmentClick,this))},initNewComments:function(){var e=this,n={standalone:!0,content_id:this.content_id,submittedContainer:p.bind(this.getContainerForNewComment,this)};this.options.commentsMode||(this.newTopLevelComment=l.ensureInstantiated(this.$el.find(".js--digg-permalink__new-top-level-comment--top .js--digg-new-comment--top-level"),n),this.newTopLevelComment.init());var r;this.options.$modal?r=this.options.$modal.find(".js--digg-permalink__new-top-level-comment--fixed .js--digg-new-comment--top-level"):r=h("#js--digg-permalink__new-top-level-comment--fixed .js--digg-new-comment--top-level"),this.newTopLevelCommentFixed=l.ensureInstantiated(r,n,!0),this.newTopLevelCommentFixed.init(),this.options.commentsMode?this.newTopLevelCommentFixed.$el.addClass("is--visible"):(t.pubsub.on("permalink_new_comment","permalink_new_comment:scroll:past",function(){e.newTopLevelCommentFixed.$el.addClass("is--visible")}),t.pubsub.on("permalink_new_comment","permalink_new_comment:scroll:not_past",function(){e.newTopLevelCommentFixed.$el.removeClass("is--visible")}),this.newCommentFixedScrollmonitor=u.factory(this.newTopLevelComment.$inputEl,{name:"permalink_new_comment",monitorElementScroll:!1,monitorScrollableParent:!0,checkScrollPast:!0,pubsub:t.pubsub}))},initStickyCommentTabs:function(){var e=this;t.pubsub.on("permalink_segments_header","permalink_segments_header:scroll:past",function(){e.reachedSticky=!0,h("body").addClass("is--amongst-comments")}),t.pubsub.on("permalink_segments_header","permalink_segments_header:scroll:not_past",function(){h("body").removeClass("is--amongst-comments")}),this.amongstCommentsScrollmonitor=u.factory(this.$el.find(".js--digg-permalink__comments"),{name:"permalink_segments_header",monitorElementScroll:!1,monitorWindowScroll:!0,checkScrollPast:!0,delayInitialMonitor:1e3,pubsub:t.pubsub})},destroy:function(){this.options.commentsMode||(this.newTopLevelComment.destroy(),this.newCommentFixedScrollmonitor.destroy(),t.pubsub.off("permalink_new_comment","permalink_new_comment:scroll:past"),t.pubsub.off("permalink_new_comment","permalink_new_comment:scroll:not_past")),this.newTopLevelCommentFixed.$el.removeClass("is--visible"),this.amongstCommentsScrollmonitor.destroy(),t.pubsub.off("permalink_segments_header","permalink_segments_header:scroll:bottom"),t.pubsub.off("permalink_segments_header","permalink_segments_header:scroll:not_bottom"),a.instance().offContentIdMessage(this.content_id,null,this),p.each(f,function(e,t){e.destroy()}),h(window).off("hashchange",this._boundHandleHashChange)},commentSegmentClick:function(e){var t=h(e.currentTarget).data("navSegment");this.activateCommentSegment(t),d.trackEvent("Dialog","tab.select",t)},activateCommentSegment:function(e,t){t=t||{},this.setUpBackLink(e),this.activeSegmentId!=="permalink"&&(this.activeSegment.scrollPos=r.getScrollPos());if(!this.comments[e].loaded&&!this.comments[e].loading)this.comments[e].loadComments();else if(this.realtimeEnabled&&e==="mostdugg"&&this.activeSegmentId!=="permalink"){var n=Date.now()-this.comments[e].loaded;n>y&&(this.comments.mostdugg.clearComments(),this.comments.mostdugg.loadComments(),delete this.comments.mostdugg.scrollPos)}this.$el.find(".js--digg-permalink__comments .is--active").removeClass("is--active");var i=this.$el.find(".js--digg-permalink__comments--"+e);i.addClass("is--active");var s=this.$el.find(".js--nav-btn--permalink-comments-segment--"+e);s.addClass("is--active"),this.activeSegment.isActive=!1,this.activeSegment=this.comments[e],this.activeSegmentId=e,this.activeSegmentName=s.html(),t.noScroll||this.restoreScrollPos(),this.$el.addClass("is--transitioning-segments");var o=this;setTimeout(function(){o.activeSegment.isActive=!0,document.documentElement.clientWidth<v&&o.$el.find(".js--digg-permalink__comments__segment").css("min-height",document.documentElement.clientHeight),o.$el.removeClass("is--transitioning-segments")},b*2)},restoreScrollPos:function(){if(!this.reachedSticky)return;var e=document.documentElement.clientWidth,t;e>=v?t=0:(t=this.$el.find(".js--digg-permalink__comments").offset().top,e>=m&&(t-=h(".js--digg-header").outerHeight()));var n;typeof this.activeSegment.scrollPos=="undefined"?n=t:n=Math.max(this.activeSegment.scrollPos,t),setTimeout(function(){h("html, body").animate({scrollTop:n},b/2)},b/2)},setUpBackLink:function(e){if(e==="permalink"){if(this.activeSegmentId==="permalink")return;$backLink=this.$el.find(".js--digg-nav-btn--permalink-comments-back-link"),$backLink.data("navSegment",this.activeSegmentId),$backLink.find(".js--digg-nav-btn--permalink-comments-back-link__label").html("Back to "+this.activeSegmentName+" comments"),this.$el.addClass("has--back-link")}else e!=="permalink"&&this.$el.removeClass("has--back-link")},getContainerForNewComment:function(){return this.activeSegmentId!=="all"&&(this.activateCommentSegment("all",{noScroll:!0}),this.activeSegmentId="all"),this.$el.find(".js--digg-permalink__comments--"+this.activeSegmentId+" .js--digg-comment__list__comments-container")},handleHashChange:function(){var e=window.location.hash;if(!e)return;var t=document.documentElement.clientWidth,n;if(e==="#diggs")n=this.$el.find(".js--digg-permalink__diggs-list");else if(e==="#comments"){if(this.options.commentsMode)return;n=this.$el.find(".js--digg-permalink__comments")}else if(x(e)){var r=e.substr(1);r=r.replace(/!/g,"|"),n=this.loadCommentPermalinkTab(r)}n&&n.length&&(this.options.$modal?o.scrollToEl(n,{offset:-25}):o.scrollToEl(n,{offset:t<m?0:undefined}))},loadCommentPermalinkTab:function(e,t){return t=t||{},this.comments.permalink.loadCommentId(e,t),this.activateCommentSegment("permalink",{noScroll:!0}),d.trackEvent("Dialog","comment_permalink.load",e),this.comments.permalink.loading?this.$el.find(".js--digg-permalink__comments"):!1},onRealtimeMessage:function(e){e.type==="realtime.story_update"&&this.onRealtimeStoryUpdate(e)},onRealtimeStoryUpdate:function(e){T.request({url:"/api/story/id/"+this.content_id+".json",success:p.bind(this.storyUpdateSuccess,this),error:function(){console.error("failed to fetch realtime story update",e,arguments)}})},storyUpdateSuccess:function(e){var t=e.data.feed[0],n=t.content;this.guestName=n.dialog.name;var r=n.dialog.state,i=this.$el.find(".js--digg-story"),s=this.options.$modal?this.options.$modal:h("body"),u;this.userIsGuest?u="Leave a comment...":n.dialog.comment_prompt?u=n.dialog.comment_prompt:r==w.LIVE&&this.guestName?u="Ask "+this.guestName+" a question...":u="Leave a comment...";var a=this.$el.find(".js--digg-new-comment--top-level .js--digg-new-comment__placeholder:not(.is--guest)");a.html(u),r==w.CLOSED?this.$el.find(".js--digg-new-comment__input").each(function(){var e=h(this);if(!e.html()){e.html("Comments are now closed").removeAttr("contenteditable");var t=e.closest(".js--digg-comment__reply-area");t.length&&o.slideFadeOut(t)}}):s.hasClass("is--realtime-state--closed")&&this.$el.find(".js--digg-new-comment__input").html("").attr("contenteditable",!0),p.each(E,function(e){s.removeClass("is--realtime-state--"+e)}),s.addClass("is--realtime-state--"+E[r]);var f=n.dialog.description.text_html;f&&i.find(".js--digg-story__description").html(f);if(n.embed_code){var l=i.find(".js--digg-story__html-embed-container");this.currentEmbed||(this.currentEmbed=p.unescape(l.data("originalEmbedHtml")));var c=p.unescape(n.embed_code);c!==this.currentEmbed&&(l.html(n.embed_code),this.currentEmbed=c,n.embed_code_class_modifier&&i.find(".js--digg-story__media-container").addClass("is--"+n.embed_code_class_modifier),this.$el.addClass("has--embed"))}else{var d=p.find(n.media.images||[],{platform:"www",type:"marquee_standard",blurred:!1})||{};d.url&&i.find(".js--digg-story__image-img").attr("src",d.url),this.$el.removeClass("has--embed")}i.find(".js--digg-story__header-embed .js--digg-story__link").html(n.title_alt||n.title);var v=h(".js--nav-btn--permalink-comments-segment--answered");n.dialog.hide_answered_tab?v.hide():v.html(n.dialog.answered_tab_label||"Answered").show()}};var k={init:function(){this.$modal=h(g),this.$modal.length||console.error("no story permalink modal found - can't intialize permalink modal"),r.preventScrollBubble(g+" .scrollable"),this.initializeHistory(),this.$modal.on("click",".js--digg-permalink-modal__error__try-again",p.bind(this.tryAgain,this))},permalinkHandler:function(e){if(e.shiftKey||e.altKey||e.metaKey||e.ctrlKey||e.which>1)return;var n=h(e.currentTarget).attr("href");if(!n)throw Error("invalid permalink! could not find href");if(document.location.pathname===r.parseUrl(n).pathname){h(e.target).parents("#js--nav-notifications").length&&t.pubsub.fire("nav_notifications:close");return}this.loadModal(n),e.stopPropagation(),e.preventDefault()},loadModal:function(e,t){c.history||(t=!0);var n=S(e);this.clearState(),this.clearStory(),this.$modal.scrollTop(0),this.$modal.addClass("is--visible is--loading"),this.exitModalProxy||(this.exitModalProxy=p.bind(this.exitModal,this)),h(document).on("keyup",this.exitModalProxy),this.$modal.find(".js--digg-permalink-modal__exit-modal").on("click",this.exitModalProxy),t||history.pushState({permalinkState:{href:e}},null,e),parsedUrl=r.parseUrl(e),parsedUrl.hash==="comments"||x(parsedUrl.hash)?this.commentsMode=!0:this.commentsMode=!1;var i=["permalink"];this.commentsMode&&i.push("abbreviated"),this.xhrReq=N.request({data:{content_id:n,display_styles:i.join(",")},success:p.bind(this.loadPermalinkSuccess,this),error:p.bind(this.loadPermalinkError,this)})},exitModal:function(e,t){if(e&&e.keyCode&&e.keyCode!==27)return;c.history||(t=!0),this.closeModal(),this.clearState(),document.title=this.initialTitle,t||history.pushState({permalinkState:{initial:!0}},this.initialTitle,this.initialHref),e&&e.preventDefault&&e.preventDefault()},closeModal:function(e){this.$modal.removeClass("is--visible");var t=this;r.onTransitionEnd(this.$modal.find(".js--digg-permalink-modal__body"),function(){t.clearStory(),e&&e()})},clearState:function(e){this.xhrReq&&this.xhrReq.abort(),this.$modal.removeClass("has--error").find(".js--digg-permalink-modal__exit-modal").off("click",this.exitModalProxy),h(document).off("keyup",this.exitModalProxy)},clearStory:function(){this.storyPermalink&&(this.storyPermalink.destroy(),delete this.storyPermalink),this.$modal.find(".js--digg-permalink-modal__story-container").empty()},loadPermalinkSuccess:function(e){document.title=e.title,this.$modal.find(".js--digg-permalink-modal__story-container").html(e.html),this.storyPermalink=new C(this.$modal.find(".js--digg-permalink"),{$modal:this.$modal,commentsMode:this.commentsMode}),this.storyPermalink.init();var t=this;p.defer(function(){t.$modal.removeClass("is--loading")})},loadPermalinkError:function(e,t,n){if(t==="abort")return;console.error("failed to fetch story permalink info",arguments),this.$modal.removeClass("is--loading").addClass("has--error").find(".js--digg-permalink-modal__error__message").html("Sorry, our bad! There was a problem loading this story.")},tryAgain:function(e){this.loadModal(document.location.href,!0),e&&e.preventDefault&&e.preventDefault()},initializeHistory:function(){this.initialTitle=document.title,this.initialHref=document.location.href;if(c.history){var e=history.state||{};e.permalinkState={initial:!0},history.replaceState(e,this.initialTitle,this.initialHref),window.addEventListener("popstate",p.bind(this.popstateListener,this))}},popstateListener:function(e){if(!e||!e.state||!e.state.permalinkState)return;var t=e.state.permalinkState;t.initial?this.exitModal({},!0):t.href&&this.loadModal(t.href,!0)}};return{factory:function(e,t){return new C(e,t)},permalinkHandler:p.bind(k.permalinkHandler,k)}}),define("text!bs/templates/modal_report_comment.html",[],function(){return'<div id="js--modal--report" class="modal--v2 modal--v2--responsive modal--report modal fade hide report" role="dialog" aria-hidden="true" data-report-subject="comment">\n    <div class="modal-header">\n        <div class="modal--v2__header-text">Report</div>\n        <div class="js--btn-modal-close modal--v2__close">&#10006;</div>\n    </div>\n\n    <input id="js--report__comment-id" type="hidden" name="comment_id" value="<%= comment_id %>" />\n\n    <div id="js--report__stage--flag-type" class="report__stage js--report__stage is--active">\n        <div class="modal--v2__body">\n            <p class="report__p">Please give us more information about this comment.</p>\n            <p class="report__p"><a href="/community-guidelines" target="_blank" class="report__link">View Digg\'s community guidelines</a></p>\n\n            <ul id="js--report__flag-types" class="report__flag-type-list">\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_SPAM %>">\n                    This is spam\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_VIOLATION %>">\n                    It violates community guidelines\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_OFFENSIVE %>">\n                     It\'s offensive\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_ATTACK %>">\n                    This is a personal attack\n                </label></li>\n                <!-- disabled for dialog v1\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_OTHER %>">\n                    Other\n                </label></li>\n                -->\n            </ul>\n\n            <div class="report__error js--report__error"></div>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button class="js--btn-modal-close modal--v2__btn">Cancel</button>\n            <button id="js--report__btn-submit" class="modal--v2__btn is--disabled">Submit</button>\n        </div>\n    </div>\n\n    <div id="js--report__stage--other-details" class="report__stage js--report__stage">\n        <div class="modal--v2__body">\n            <p class="report__p">You selected "other." Can you give us more information?</p>\n\n            <textarea id="js--report__details" class="report__details"></textarea>\n\n            <div class="report__error js--report__error"></div>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button id="js--report__btn-back" class="modal--v2__btn">Back</button>\n            <button id="js--report__btn-submit--details" class="modal--v2__btn is--disabled">Submit</button>\n        </div>\n    </div>\n\n    <div id="js--report__stage--success" class="report__stage js--report__stage">\n        <div class="modal--v2__body">\n            <p class="report__p">Thank you. This comment has been reported to our moderators.</p>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button class="js--btn-modal-close modal--v2__btn">Close</button>\n        </div>\n    </div>\n</div>\n'}),define("text!bs/templates/modal_report_user.html",[],function(){return'<div id="js--modal--report" class="modal--v2 modal--v2--responsive modal--report modal fade hide report" role="dialog" aria-hidden="true" data-report-subject="user">\n    <div class="modal-header">\n        <div class="modal--v2__header-text">Report</div>\n        <div class="js--btn-modal-close modal--v2__close">&#10006;</div>\n    </div>\n\n    <input id="js--report__user-id" type="hidden" name="user_id" value="<%= user_id %>" />\n\n    <div id="js--report__stage--flag-type" class="report__stage js--report__stage is--active">\n        <div class="modal--v2__body">\n            <p class="report__p">Please give us more information about this user.</p>\n            <p class="report__p"><a href="/community-guidelines" target="_blank" class="report__link">View Digg\'s community guidelines</a></p>\n\n            <ul id="js--report__flag-types" class="report__flag-type-list">\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_SPAM %>">\n                    This user is posting spam\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_ATTACK %>">\n                    This user is committing personal attacks\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_VIOLATION %>">\n                    This user is violating community guidelines\n                </label></li>\n                <li><label class="report__flag-type-label">\n                    <input class="report__flag-type" type="radio" name="flag_code" value="<%= flagCodes.FLAG_OTHER %>">\n                    Other\n                </label></li>\n            </ul>\n\n            <div class="report__error js--report__error"></div>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button class="js--btn-modal-close modal--v2__btn">Cancel</button>\n            <button id="js--report__btn-submit" class="modal--v2__btn is--disabled">Submit</button>\n        </div>\n    </div>\n\n    <div id="js--report__stage--other-details" class="report__stage js--report__stage">\n        <div class="modal--v2__body">\n            <p class="report__p">You selected "other." Can you give us more information?</p>\n\n            <textarea id="js--report__details" class="report__details"></textarea>\n\n            <div class="report__error js--report__error"></div>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button id="js--report__btn-back" class="modal--v2__btn">Back</button>\n            <button id="js--report__btn-submit--details" class="modal--v2__btn is--disabled">Submit</button>\n        </div>\n    </div>\n\n    <div id="js--report__stage--success" class="report__stage js--report__stage">\n        <div class="modal--v2__body">\n            <p class="report__p">Thank you. This user has been reported to our moderators.</p>\n        </div>\n\n        <div class="modal--v2__footer">\n            <button class="js--btn-modal-close modal--v2__btn">Close</button>\n        </div>\n    </div>\n</div>\n'}),define("bs/widgets/report",["require","bs/core","bs/util/xhr","bs/util/helpers","bs/util/tracker","text!bs/templates/modal_report_comment.html","text!bs/templates/modal_report_user.html","bootstrap_modal","lodash"],function(e,t,n,r,i,s,o,u,a){function m(e){d=e,w(),$(".js--report__stage.is--active").removeClass("is--active"),$("#js--report__stage--"+e).addClass("is--active")}function g(){$("#js--report__btn-submit, #js--report__btn-submit--details").addClass("has--loading-bars is--disabled")}function y(){$("#js--report__btn-submit, #js--report__btn-submit--details").removeClass("has--loading-bars is--disabled")}function b(e){$(".js--report__error").html(e).addClass("is--visible")}function w(){$(".js--report__error").removeClass("is--visible")}function E(e){var t=$(e.target).closest(".modal").length===0,n=$(e.target).hasClass("js--btn-modal-close");if(t||n)p.modal("hide").remove(),$(document).off("click touchend",E)}function S(){var e=$("#js--report__btn-submit"),t=$("#js--report__flag-types [type=radio]:checked").val();parseInt(t,10)===f.FLAG_OTHER?e.css("width",e.outerWidth()).html("Next"):e.html("Submit"),$("#js--report__btn-submit").removeClass("is--disabled")}function x(e){var t=$(e.target).val();t?$("#js--report__btn-submit--details").removeClass("is--disabled"):$("#js--report__btn-submit--details").addClass("is--disabled")}function T(){m("flag-type")}function N(e){var t=$("#js--modal--report").data("reportSubject"),n=$("#js--report__flag-types [type=radio]:checked").val();if(!n){alert("You must select a reason for flagging this comment.");return}if(d=="other-details"){var r=$("#js--report__details").val();r?C(n,t,r):alert("Please tell us why you'd like to report this comment.")}else parseInt(n,10)===f.FLAG_OTHER?m("other-details"):C(n,t)}function C(e,t,n){g(),w();var r={flag_code:e,details:n?n.substr(0,1e4):null};t==="comment"?r.comment_id=$("#js--report__comment-id").val():t==="user"&&(r.flagged_user_id=$("#js--report__user-id").val()),v.request({url:"/api/"+t+"/report.json",data:r})}function k(){l.trackEvent("User/Comment Reporting","Submitted"),m("success")}function L(){console.error("error while trying to report comment",arguments),b("Sorry, our bad! We ran into an error while submitting this report. Try again or get in touch at support@digg.com."),y()}function A(e,t){if(!e||!t)throw Error("Report dialog modal must be called with `subject` and `id`");l.trackEvent("User/Comment Reporting","Modal opened");var n,r={flagCodes:f};e==="comment"?(r.comment_id=t,n=c(r)):e==="user"&&(r.user_id=t,n=h(r)),p=$(n).appendTo("body").modal({keyboard:!0,show:!0}),$(document).on("click touchend",E),p.on("click",".js--btn-modal-close",E).on("change","#js--report__flag-types [type=radio]",S).on("keyup","#js--report__details",a.throttle(x,200)).on("click","#js--report__btn-back",T).on("click","#js--report__btn-submit, #js--report__btn-submit--details",N)}var f={FLAG_SPAM:101,FLAG_OFFENSIVE:102,FLAG_ATTACK:103,FLAG_VIOLATION:104,FLAG_OTHER:105,FLAG_OFF_TOPIC:106},l=new i,c=a.template(s),h=a.template(o),p,d,v=new n.dataProvider({type:"POST",success:function(e){e&&e.status==="ok"?k():L()},error:L});return{showModal:A}}),define("bs/util/item_actions",["bs/core","bs/util/user","bs/util/cookies","bs/util/xhr","bs/util/format","bs/util/helpers","bs/util/fx","bs/util/tracker","bs/widgets/story_permalink","bs/widgets/onboarding","bs/widgets/report","lodash"],function(e,t,n,r,i,s,o,u,a,f,l,c){function x(e){var t=(new Date).valueOf()+31536e6;$.extend(E,e),n.set({name:w,value:$.param(E),expires:new Date(t)})}function T(t){var r="http://api.digg.com/api/v5/redirect",i=$(this).closest(d),s=i.data("contentId"),o=i.data("position"),u=e.user.get("user_id"),a=n.get("frontend.auid"),f=i.data("source"),l={url:this.href};s&&(l.content_id=s),u?l.user_id=u:a&&(l.auid=a),f&&(l.source=f),o!=null&&(l.position=o),navigator.mozApps&&window.locationbar.visible===!1&&(l.platform=1005,window.open([r,$.param(l)].join("?")));if(S==="mobile")l.platform=1005,window.location.href=[r,$.param(l)].join("?");else{if(this.target!=="_blank")return;window.open([r,$.param(l)].join("?"))}return!1}function N(e){var t={contentID:e.data("contentId"),url:e.data("contenturl"),diggUrlID:e.data("urlId"),title:(e.find(".js--digg-story__title-link").html()||"").trim(),diggs:e.data("diggs"),dugg:e.data("dugg")||e.hasClass(m),read_later:e.data("read_later")||e.hasClass(g)};return t.diggs=c.isString(t.diggs)?parseInt(t.diggs.replace(/,/g,""),10):t.diggs,t}function C(e,t){e.data(t)}function k(e){var t={commentID:e.data("commentId"),dugg:e.hasClass(m)};if(!t.commentID)throw Error("Failed to get comment_id from element",e);return t}function L(e){return $(".js--story-"+e.replace(":","\\:"))}function A(e){c.each(e,function(e,t){O(t,e)})}function O(e,t){var n=L(e);M(n,t),_(n,t)}function M(e,t,n){C(e,{diggs:t.diggs,dugg:t.dugg});var r=e.find(".js--digg-label, .js--digg-btn--story .js--digg-btn__label"),s=e.find(".js--digg-count, .js--digg-btn--story .js--digg-btn__count"),o=s.parents(".js--diggs-container");t.diggs===0?o.addClass("is--zero"):o.removeClass("is--zero"),t.dugg?(e.addClass(m),n&&Z(e.find(".js--digg-btn--story"))):e.removeClass(m),s.html(t.diggs?i.intWithCommas(t.diggs):""),!t.diggs||t.diggs==1?r.html("digg"):r.html("diggs")}function _(e,t,n){C(e,{read_later:t.read_later});var r=e.find(".js--save-btn-label");t.read_later?(r.html("Saved"),e.addClass(g),n&&Z(e.find(".js--save-btn"))):(r.html("Save"),e.removeClass(g))}function D(e){s.deparam(location.search.substr(1)).enable_permalink_modals&&a.permalinkHandler(e)}function P(e){var t=$(this),n=t.parents(d),i=N(n);Z(n.find(".js--digg-btn--story"));var s={content_id:i.contentID,digg_url_id:i.diggUrlID},o=i.dugg?"/api/digg/delete.json":"/api/digg/submit.json",u=new r.dataProvider({url:o,type:"POST",data:s,success:c.bind(H,this,t,i.contentID)});return u.request(),!1}function H(t,n,r){var i=document.location.hash,s=L(n),o=(new Date).valueOf()/1e3-~~e.user.get("date_signup")<900,u=r.data;M(s,u,!0),u.dugg?e.pubsub.fire("digg_success",t,u,n):e.pubsub.fire("digg_delete_success",t,u,n);if(i.match("test-onboarding")||u.dugg&&!E.dugg&&o)f.firstDigg(t),x({dugg:1})}function B(e){var t=$(this),n=t.closest(v),i=k(n),s={comment_id:i.commentID},o="/api/comment/digg/"+(i.dugg?"delete":"submit")+".json",u=new r.dataProvider({url:o,type:"POST",data:s,success:c.bind(j,this,t,i.commentID),error:function(){console.error("Failed to digg comment",i.commentID,arguments)}});return u.request(),!1}function j(t,n,r){var s=document.location.hash,o=$('.js--digg-comment[data-comment-id="'+n+'"]'),u=r.data,a=o.children(".js--digg-comment__body").find(".js--digg-btn--comment"),f=a.find(".js--digg-label"),l=a.find(".js--digg-btn__count");u.dugg?(e.pubsub.fire("comment_digg_success",t,u,n),o.addClass(m)):(e.pubsub.fire("comment_digg_delete_success",t,u,n),o.removeClass(m)),l.html(u.digg_count?i.intWithCommas(u.digg_count):""),!u.digg_count||u.digg_count==1?f.html("Digg"):f.html("Diggs");var c=l.parents(".js--diggs-container");u.diggs===0?c.addClass("is--zero"):c.removeClass("is--zero")}function F(e){if(!confirm("Are you sure you want to delete this comment?"))return;var t=$(this),n=t.closest(v),r=k(n),i={comment_id:r.commentID};return y.request({data:i,error:q,success:c.bind(I,this,n)}),tt(),!1}function I(e){e.addClass("is--deleted is--deleted-live")}function q(){console.error("failed to delete comment",arguments),alert("Sorry, we ran into a problem deleting your comment! Give it another shot or try again later.")}function R(e){var t=$(this),n=t.closest(v),i=k(n),s={comment_id:i.commentID},o=n.hasClass("is--editors-pick"),u="/api/comment/editorspick/"+(o?"delete.json":"submit.json"),a=new r.dataProvider({url:u,type:"POST",data:s,error:c.bind(U,this,n),success:c.bind(z,this,n)});return t.addClass("is--loading"),a.request(),!1}function U(e,t){console.error("failed to update editors' pick status for comment",arguments),alert("Sorry, we ran into a problem updating this comment as an Editors' Pick! Give it another shot or try again later.")}function z(e){var t=e.find(".js--toggle-editors-pick-btn"),n=e.hasClass("is--editors-pick");n?(e.removeClass("is--editors-pick"),e.find(".js--toggle-editors-pick-btn").html("Editors' Pick")):(e.addClass("is--editors-pick"),e.find(".js--toggle-editors-pick-btn").html("Remove Editors' Pick"))}function W(e){var t=$(this),n=t.parents(d),i=N(n);Z(n.find(".js--save-btn"));var s=i.read_later?"/api/story/readlater/delete.json":"/api/story/readlater/add.json",o={content_id:i.contentID,digg_url_id:i.diggUrlID},u=new r.dataProvider({url:s,type:"POST",data:o,success:c.bind(X,this,t,i.contentID)});return u.request(),!1}function X(t,n,r){var i=document.location.hash,s=L(n),o=(new Date).valueOf()/1e3-~~e.user.get("date_signup")<900,u=r.data;_(s,u,!0),u.read_later?e.pubsub.fire("add_reading_list_success",t,u,n):e.pubsub.fire("delete_reading_list_request",t,u,n);if(i.match("test-onboarding")||u.read_later&&!E.saved&&o)f.firstSave(t),x({saved:1})}function V(e){e&&e.preventDefault&&e.preventDefault(),$comment=$(this).closest(".js--digg-comment"),l.showModal("comment",$comment.data("commentId")),tt()}function J(t){Z(t);var n=$(this),r=n.hasClass("share-twitter")?"twitter":"facebook";return t.preventDefault(),e.pubsub.fire("story_share",r,n),r==="twitter"?!1:(s.popWin(this.getAttribute("href"),null,{width:550,height:450}),tt(),!1)}function K(e){var t=$(this),n=t.parents(d),r=N(n),i=t.closest(".js--tag-profile"),o=i.data("tagId"),u=i.data("tagName");if(n.hasClass("digg-story--editors-pick")){alert("THIS IS AN EDIT STORY GUYS.\n\nJust remove the "+u+" tag if you don't want it here, or ban it if you're feeling feisty.");return}var a=t.hasClass("js--blacklist-domain"),f=s.parseUrl(r.url).hostname,l;if(a)l=confirm("Are you sure you want to blacklist all stories from "+f+" in "+u+"?"+"\n\nTHIS WILL REMOVE EVERYTHING FROM "+f.toUpperCase()+" FROM THIS CHANNEL.\n\nJUST TO BE CLEAR.");else{var h=r.title?'the story "'+r.title+'"':"this story";l=confirm("Are you sure you want to blacklist "+h+" from "+u+"?")}if(!l)return;b.request({success:c.partial(Q,n,a,f),data:{content_id:r.contentID,tag_id:o,blacklist_domain:a}}),tt()}function Q(e,t,n){var r=["Couldn't agree more.","Yeah not a bad idea.","If you say so...","*slowly wipes hands*","Let it be so!","Right on.","nice choice\n\n                    what story\n    wow\n                              such content\n\n\n          very blacklist","Thank you for your time. We are doing our best to serve you. This item has been blacklisted as per your request. We appreciate your custom. Please come again."];alert(r[c.random(r.length-1)]),t?$('[data-contenturl*="'+n+'"]').each(function(){e=$(this),o.slideFadeOut(e,{cb:function(){e.remove()}})}):o.slideFadeOut(e,{cb:function(){e.remove()}})}function G(){console.error("Failed to blacklist story:",arguments),alert("Wait, that didn't work! Try again, or contact your friendly neighborhood developer for assistance.")}function Y(e){e.preventDefault(),e.stopPropagation();var t=$(this).closest(d),n=N(t),r=c.unescape(t.find(".js--story-embed-html").html()),i=$(r);i.find("video").attr("autoplay",!0);var s=i.find("iframe").first();if(s.length){var o=s.attr("src");o.indexOf("autoplay=0")!==-1?o=o.replace("autoplay=0","autoplay=1"):o.indexOf("?")!==-1?o+="&autoplay=1":o+="?autoplay=1",s.attr("src",o)}$(this).removeClass("js--show-story-embed").html("").append(i),h.trackEvent("Digg Story Embed","play",n.title)}function Z(e){if(!e)return;e.currentTarget&&(e=$(e.currentTarget));var t=e.find(".js--icon");t.length&&(t.addClass("is--clicked"),setTimeout(function(){t.removeClass("is--clicked")},150))}function et(e){if(e.target.className.indexOf("digg-story__action")<0&&e.target.className.indexOf("item-actions")<0)return tt(),!1}function tt(e){var t="is--tooltip-visible";return $("."+t).removeClass(t),$("."+t).parents(".js--digg-story").off("mouseleave"),$("."+t).parents(".js--digg-comment").off("mouseleave"),$(document).off("mousedown",et),!1}function nt(e){$(this).parent().addClass("is--tooltip-visible"),c.defer(c.bind(function(){$(document).on("mousedown",et);var e=$(this).closest(".js--digg-comment");e.length?e.on("mouseleave",tt):$(this).parents(".js--digg-story").on("mouseleave",tt)},this))}function rt(){if(p)return;p=!0,$(document).on("click",".js--digg-permalink-link",D).on("mousedown",".js--story-show-additional-actions",nt).on("click",".js--digg-btn--story, .js--digg-story-action--digg",e.user.authorized(P,"Digg")).on("click",".js--digg-btn--comment",e.user.authorized(B,null,{requireUsername:!0})).on("click",".js--save-btn, .js--digg-story-action--save",e.user.authorized(W,"Save")).on("click",".js--report-btn",e.user.authorized(V,null,{requireUsername:!0})).on("click",".js--toggle-editors-pick-btn",R).on("click",".js--delete-comment-btn",F).on("click",".js--tweet-btn, .js--facebook-share-btn",J).on("click",".js--blacklist-story, .js--blacklist-domain",K).on("click",".js--story-link, .js--digg-story__link",T).on("click",".js--show-story-embed",Y),e.pubsub.on("score_updates",e.pubsub.channels.scores_update,function(e){$(function(){A(e)})})}var h=new u,p=!1,d=".js--digg-story",v=".js--digg-comment",m="is--dugg",g="is--saved",y=new r.dataProvider({url:"/api/comment/delete.json",type:"POST"}),b=new r.dataProvider({url:"/api/channel/feed/remove.json",type:"POST",error:G}),w="saflags",E=n.get(w),S=n.get("preferred_view")||"desktop";return E=E?s.deparam(E):{},{init:rt,showPermalink:D,submitDigg:P,addReadingList:W,renderStoryScores:A,redirectStoryLink:T,shareStory:J,showAdditionalStoryActions:nt}}),define("bs/util/interface",[],function(){function e(e){this.members=e}return{factory:function(t){return new e(t)},ensureImplements:function(e,t){var n,r,i;for(n=0,r=t.members.length;n<r;n++){i=t.members[n];if(typeof e[i]=="undefined")throw new Error("InterfaceError: missing member '"+i+"'")}return!0}}}),define("bs/interfaces/digg_user_data",["bs/util/interface"],function(e){var t=e.factory(["user_id"]);return t}),define("bs/model/user",["bs/core","bs/util/interface","bs/interfaces/digg_user_data","bs/util/xhr","backbone","lodash"],function(e,t,n,r,i,s){function u(e){e.status_code===33?this.trigger("username_lookup:success",e.display_message):this.trigger("username_lookup:error",e.display_message)}function a(){this.trigger("username_lookup:error","There was a problem checking this name")}function l(e){e.status_code===53?this.trigger("user_email_lookup:success",e.display_message):this.trigger("user_email_lookup:error",e.display_message)}function c(){this.trigger("user_email_lookup:error","There was a problem checking this email")}function E(e,t,n){y=e.next_position,this.trigger("followers_users:load:success",e.html)}function S(e,t,n){this.trigger("followers_users:load:error",n)}function x(e,t,n){b=e.next_position,this.trigger("following_users:load:success",e.html)}function T(e,t,n){this.trigger("following_users:load:error",n)}function N(e,t,n){w=e.next_position,this.trigger("following_tags:load:success",e.html)}function C(e,t,n){this.trigger("following_tags:load:error",n)}function k(e,t,n){this.trigger("follow_user:success")}function L(e,t,n){this.trigger("follow_user:error",n)}function A(e,t,n){this.trigger("unfollow_user:success")}function O(e,t,n){this.trigger("unfollow_user:error",n)}function M(e,t,n){!e||!e.data?this.trigger("follow_status:error","invalid response",e):this.trigger("follow_status:success",e.data)}function _(e,t,n){this.trigger("follow_status:error",n)}function D(e){this.user_id=e.user_id,s.extend(this,Backbone.Events)}var o=new r.dataProvider({url:"/api/username/status.json"}),f=new r.dataProvider({url:"/api/user/email/status.json"}),h=new r.dataProvider({cache:!1,url:"/api/network/followers/users.json"}),p=new r.dataProvider({cache:!1,url:"/api/network/following/users.json"}),d=new r.dataProvider({cache:!1,url:"/api/network/following/tags.json"}),v=new r.dataProvider({url:"/api/network/follow/user.json",type:"POST"}),m=new r.dataProvider({url:"/api/network/unfollow/user.json",type:"POST"}),g=new r.dataProvider({cache:!1,url:"/api/network/follow/status.json"}),y,b,w;return D.prototype={doUsernameLookup:function(e){o.request({data:{username:e},success:s.bind(u,this),error:s.bind(a,this)})},doUserEmailLookup:function(e){f.request({data:{email:e},success:s.bind(l,this),error:s.bind(c,this)})},getFollowersUsers:function(e){var t={user_id:this.user_id};"position"in e&&(y=e.position),y&&(t.position=y);var n=s.defaults(e,t);h.request({data:n,success:s.bind(E,this),error:s.bind(S,this)})},getFollowingUsers:function(e){var t={user_id:this.user_id};"position"in e&&(b=e.position),b&&(t.position=b);var n=s.defaults(e,t);p.request({data:n,success:s.bind(x,this),error:s.bind(T,this)})},getFollowingTags:function(e){var t={user_id:this.user_id};"position"in e&&(w=e.position),w&&(t.position=w);var n=s.defaults(e,t);d.request({data:n,success:s.bind(N,this),error:s.bind(C,this)})},followUser:function(){v.request({data:{user_id:this.user_id},success:s.bind(k,this),error:s.bind(L,this)})},unfollowUser:function(){m.request({data:{user_id:this.user_id},success:s.bind(A,this),error:s.bind(O,this)})},getFollowStatus:function(){g.request({data:{user_id:this.user_id},success:s.bind(M,this),error:s.bind(_,this)})}},{factory:function(e){return t.ensureImplements(e,n),new D(e)}}}),define("text!bs/templates/modal_generic.html",[],function(){return'<div id="js--modal--generic" class="modal--v2 modal--v2--responsive modal--v2--user-bio modal fade hide" role="dialog" aria-hidden="true">\n    <div class="modal-header">\n        <div id="js--modal--generic__header"></div>\n        <div class="js--btn-modal-close modal--v2__close" data-dismiss="modal">\u2716</div>\n    </div>\n\n    <div class="modal--v2__body" id="js--modal--generic__body"></div>\n\n    <div class="modal--v2__footer" id="js--modal--generic__footer"></div>\n</div>\n'}),define("bs/util/user_graph",["bs/core","bs/util/xhr","bs/util/fx","bs/model/user","bs/widgets/report","text!bs/templates/modal_generic.html","jquery","bootstrap_modal","lodash"],function(e,t,n,r,i,s,o,u,a){function g(t){var n=o(this),i=n.hasClass("is--following")?"unfollow":"follow",s=n.data("diggUserId"),u=r.factory({user_id:s}),a=function(){var t=i==="follow"?"Following":"Follow",n=o('.js--digg-graph-btn[data-digg-user-id="'+s+'"]');n.html(t),i==="follow"?n.addClass(l):n.removeClass(l),m[s]&&(m[s].following=i==="follow"),e.pubsub.fire("follow_count_updated",s,i),n.removeClass(c),u.off()},f=function(){console.error("There was an error "+i+"ing user_id "+s,arguments),n.addClass(c),u.off()};n.addClass(c),u.on(i+"_user:success",a),u.on(i+"_user:error",f),i==="follow"?u.followUser():i==="unfollow"&&u.unfollowUser()}function y(t){var n=o(t);if(n.data("followStatusChecked"))return;n.data("followStatusChecked",!0);var i=n.find(".js--digg-graph-btn"),s=n.find(".js--digg-graph-context"),u=n.data("diggUserId"),a=r.factory({user_id:u});if(u===e.user.get("user_id")){i.hide(),s.html("You are here");return}if(m[u]){b(m[u],i,s);return}i.addClass(c);var f=function(e){m[u]=e,b(e,i,s),i.removeClass(c),a.off()},l=function(){console.error("There was an error checking follow status for",u,arguments),i.addClass(c),a.off()};i.addClass(c),a.on("follow_status:success",f),a.on("follow_status:error",l),a.getFollowStatus()}function b(e,t,n){e.following?t.addClass(l):t.removeClass(l),t.html(e.following?"Following":"Follow"),e.follows_you?n.hide().html("Follows you").fadeIn(100):n.fadeOut(100,function(){n.html("")})}function w(e){n.callIfMouseStays(o(e.currentTarget),function(){E(o(e.currentTarget)),x(e,{dontSetHeight:!0})},d)}function E(e){if(e.find(".js--digg-user__tooltip").length)return;var t=e.html().substring(1),n=o('[data-username="'+t+'"] .js--digg-user__tooltip').last().clone().css({top:""});if(!n.length)return;e.append(n)}function S(e){n.callIfMouseStays(o(e.currentTarget),a.partial(x,e),d)}function x(e,t){t=t||{};var n=o(e.currentTarget),r=function(e){n.removeClass(h),n.removeClass(p),n.off("mouseleave",r)},i;if(!v){var u=n.find(".js--digg-user__tooltip"),a=n.position(),f=n[0].getBoundingClientRect();f.left<150&&n.addClass(p),t.dontSetHeight||u.css({top:a.top}),n.addClass(h),n.on("mouseleave",r)}else e.type==="click"&&(i=o("#js--modal--generic"),i.size()||(i=o(s).appendTo("body")),i.modal({keyboard:!0,show:!0}),clonedEl=n.find(".js--digg-user__tooltip").clone(),clonedEl.removeClass(),o("#js--modal--generic__body").empty().append(clonedEl),e.stopPropagation(),e.preventDefault())}function T(e){o(this).parent().addClass("is--tooltip-visible"),a.defer(a.bind(function(){o(document).on("mousedown",N),o(this).parents(".js--digg-user__tooltip").on("mouseleave",C)},this))}function N(e){o(e.target).hasClass("js--digg-user__context-menu__item")||C()}function C(){var e="is--tooltip-visible";o("."+e).removeClass(e),o("."+e).parents(".js--digg-user__tooltip").off("mouseleave"),o(document).off("mousedown",N)}function k(e){e&&e.preventDefault&&e.preventDefault();var t=o(this).closest("[data-digg-user-id]").data("diggUserId");i.showModal("user",t),C()}function L(){if(f)return;f=!0,o(document).on("click",".js--digg-graph-btn",g).on("click",".js--digg-user__context-menu-link",T).on("click",".js--report-user-btn",k).on("mouseenter",".js--digg-comment__text .js--digg-user-link",w).on("mouseenter",".js--digg-user",S).on("click",".js--digg-user",x)}var f=!1,l="is--following",c="has--loading-bars",h="is--mouseover",p="is--rightwards-tooltip",d=250,v=!1,m={};return e.mediaQueriesMonitor.addQuery("(max-width: 480px)",function(){v=!0}),e.mediaQueriesMonitor.addQuery("(min-width: 481px)",function(){v=!1}),{init:L,handleGraphButtonClick:g,displayTooltip:x}}),define("bs/util/storyscores",["bs/core","bs/util/xhr","bs/util/cookies","lodash"],function(e,t,n,r){function d(e){this.name=e,this.pollInterval=i,this.storyScores={},this.delta={},this.currentContentIDs=[],this.dataProvider=new t.dataProvider({url:"/api/story/scores.json?"+this.name,type:"POST",success:r.bind(c,this),error:h})}var i=3e5,s={},o={},u=[],a=function(e,t,n){if(!s[t]||!r.isEqual(s[t],e))o[t]=e,s[t]=e},f=function(t){o={},r.each(t.data,a),e.pubsub.fire(e.pubsub.channels.scores_update,o)},l=function(e,t,n){if(!this.storyScores[t]||!r.isEqual(this.storyScores[t],e))this.delta[t]=e,this.storyScores[t]=e},c=function(t){this.delta={},r.each(t.data,r.bind(l,this)),e.pubsub.fire(e.pubsub.channels.scores_update,this.delta)},h=function(t){e.pubsub.fire(e.pubsub.channels.scores_update_error,t)},p=new t.dataProvider({url:"/api/story/scores.json",type:"POST",success:f,error:h});return d.prototype={setPollInterval:function(e){return this.pollInterval=e,this},register:function(t){if(t.length===0)return;return Array.prototype.push.apply(this.currentContentIDs,t),this.currentContentIDs=r.uniq(this.currentContentIDs),this.dataProvider.isPolling()&&this.dataProvider.stopPolling(),e.features.polling_scores?e.user.isLoggedIn()&&this.dataProvider.startPolling(this.pollInterval,{data:{content_ids:this.currentContentIDs.join(",")}}):e.user.isLoggedIn()&&this.dataProvider.request({data:{content_ids:this.currentContentIDs.join(",")}}),this},deregisterAll:function(){return this.currentContentIDs=[],this.storyScores={},this}},{factory:function(e){return new d(e)},register:function(t){return Array.prototype.push.apply(u,t),u=r.uniq(u),p.isPolling()&&p.stopPolling(),e.features.polling_scores&&p.startPolling(i,{data:{content_ids:u.join(",")}}),s},deregister:function(e){u=r.difference(u,e)}}}),define("bs/widgets/lazyimages",["jquery","bs/core","bs/util/scrollmonitor"],function(e,t,n){function a(t){var n=e(t),r=e(t).data("src");r=r!==u?r:u,n.attr("src",r)}function f(t){var n=e(t),r=e(t).data("src");r=r!==u?u:r,n.attr("src",r)}function l(){var e=o,t=h(),n=e*2+t,i=t-e*2;for(var u=s.length-1;u>=0;u-=1)if(s[u].offset<n&&s[u].offset>i&&!s[u].loaded)a(s[u].el),s[u].loaded=!0;else if(r.garbageCollection&&s[u].offset>n||r.garbageCollection&&s[u].offset<i&&s[u].loaded)f(s[u].el),s[u].loaded=!1}function c(){var e=document.documentElement.clientHeight||window.innerHeight;return o=e,e}function h(){var e=document.documentElement.scrollTop||document.body.scrollTop;return e}function p(e){var t=0;if(e.offsetParent)do t+=e.offsetTop,e=e.offsetParent;while(e&&e.nodeName!=="BODY");return t}function d(){var t=e(".lazy-image-img");for(var n=t.length-1;n>=0;n-=1)e(t[n]).hasClass("need-offset")&&(e(t[n]).removeClass("need-offset").addClass("got-offset"),s.push({el:e(t[n]),offset:p(t[n]),loaded:!1}))}function v(){if(i)return;i=!0,Modernizr.touch&&e(window).on("touchend",function(){l()}),t.pubsub.on("scroll",t.pubsub.channels.scrolltop,l),e(window).on("resize",function(){c(),l()}),window.addEventListener&&window.addEventListener("orientationchange",function(){c(),l()},!1),t.pubsub.on("storystream","render_stories",function(){d(),l()})}var r={garbageCollection:!1},i=!1,s=[],o=document.documentElement.clientHeight||window.innerHeight,u="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m={init:function(e){r=e?e:r,m.recheck()},recheck:function(){d(),l(),s.length>0&&v()}};return m}),define("text!bs/templates/user_auth.html",[],function(){return'<div id="nav-user-auth" class="nav-user-auth">\n    <a id="btn-facebook-auth-topnav" class="btn-service-auth btn-facebook-auth" href="#fb">\n      <div class="auth-ico"></div>\n      Sign in with Facebook\n    </a>\n    <a id="btn-twitter-auth-topnav" class="btn-service-auth btn-twitter-auth" href="#twitter">\n      <div class="auth-ico"></div>\n      Sign in with Twitter\n    </a>\n    <a id="btn-google-auth-topnav" class="btn-service-auth btn-google-auth" href="#google">\n      <div class="auth-ico"></div>\n      Sign in with Google\n    </a>\n</div>'}),define("text!bs/templates/user_nav.html",[],function(){return'<div id="nav-user-nav" class="nav-user-nav">\n    <ul class="popover-list">\n        <li class="popover-list-item"><a class="popover-list-link" href="/settings">Settings</a></li>\n        <li class="popover-list-item"><a class="popover-list-link" href="/logout">Sign Out</a></li>\n    </ul>\n</div>'}),define("bs/widgets/usernav",["bs/core","text!bs/templates/popover.html","text!bs/templates/user_auth.html","text!bs/templates/user_nav.html","lodash"],function(e,t,n,r,i){function h(t){var n=typeof t!="undefined"?$(t.target).closest(".popover"):$("body").closest(".popover");l&&n.length===0&&($(document).off("click touchend",h),e.pubsub.off("usernav","auth_tooltip_displayed",h),s.removeClass("usernav-active"),o.removeClass(c),l=!1)}function p(t){l?h(t):(s.addClass("usernav-active"),o.addClass(c),l=!0,$(document).on("click touchend",h),e.pubsub.on("usernav","auth_tooltip_displayed",h),e.pubsub.fire("sitenav_auth_displayed"),e.pubsub.fire("hide_onboarding_popovers"));if($(t.target).hasClass("nav-link"))return!1}function d(){o.addClass("widget-active").append(u({popoverContent:a()}))}function v(t){o.addClass("widget-active").html('<a class="nav-link" href="#" title="'+t.name+'">'+t.name+"</a>"+u({popoverContent:f()})),s.addClass("authenticated"),h(),e.pubsub.off("site_nav_user_widget",e.pubsub.channels.user_auth,v)}function m(){var t=e.user.get("name");o.find(".nav-link").attr("title",t).html(t)}var s=$("#digg-header"),o=$("#nav-user"),u=i.template(t),a=i.template(n),f=i.template(r),l=!1,c="show-popover";return{init:function(){e.user.isLoggedIn()?$(m):(d(),e.pubsub.one("site_nav_user_widget",e.pubsub.channels.user_auth,v)),$(document).on("click","#nav-user",p),e.pubsub.on("usernav","savedstories_modal_displayed",h),e.pubsub.on("usernav","onboarding_firstsave",h)}}}),define("text!bs/templates/story_saved.html",[],function(){return'<article class="digg-story js--digg-story js--digg-story-<%=content.content_id %>story-container story-<%= content.content_id %> digg-story-el is--saved" data-content-id="<%= content.content_id %>" data-contenturl="<%=content.url%>" data-position="<%=position%>" data-diggs="<%= diggs.count %>" data-tweets="<%= tweets.count %>" data-fb-shares="<%= fb_shares.count %>" data-digg-score="<%= digg_score %>">\n    <% if (typeof image != \'undefined\') { %>\n        <div class="story-image">\n            <a data-position="<%=position%>" data-content-id="<%= content.content_id %>" class="js--digg-story__link" href="<%= content.url %>" target="<%=content.link_target%>">\n                <img class="story-image-img" src="<%= image.url %>" width="<%= image.width %>" height="<%= image.height %>" alt="" />\n            </a>\n        </div>\n    <% } %>\n    <div class="digg-story__content">\n        <header class="digg-story__header">\n            <div class="digg-story__kicker"><%= content.kicker %></div>\n            <h2 class="digg-story__title entry-title">\n                <a class="digg-story__title-link js--digg-story__link" href="<%= content.url %>" target="<%=content.link_target%>"><%= content.title ? content.title.replace(/(\\S+) (\\S+)$/, "$1&nbsp;$2") : "" %></a>\n            </h2>\n            <div class="digg-story__metadata-container">\n            <% if (content.domain_name != \'YouTube\') { %>\n                <span class="digg-story__metadata-item digg-story__metadata--source">\n                    <% if (content.domain_name === \'Digg Top Stories\') { %>\n                        <a itemprop="publisher copyrightHolder sourceOrganization provider" class="digg-story__metadata-link js--digg-story__link" href="/source/<%= content.domain %>"><%= content.domain %></a>\n\n                    <% } else { %>\n                        <%= content.domain_name %>\n\n                    <% } %>\n                </span>\n            <% } %>\n            <% if (content.tags && content.tags.length) { %>\n                <% for (var i = 0, j = content.tags.length; i < j; i++) { %>\n                    <span class="digg-story__metadata-item story-tag<% if (i === 0) { %> first-tag<% } %>">\n                        <a itemprop="keywords" class="digg-story__metadata-link js--digg-story__link" href="/channel/<%= content.tags[i].slug %>"><%= content.tags[i].display %></a>\n                    </span>\n                <% } %>\n            <% } %>\n            <% if (date !== null) { %><abbr class="published digg-story__metadata--timestamp"><time><%= formattedDate %></time></abbr><% } %>\n            </div>\n        </header>\n    </div>\n    <div class="digg-story__actions-container">\n        <div class="item-actions">\n            <button class="digg-story__action item-actions__action item-actions__digg js--digg-btn--story">\n                <span class="item-actions__digg__icon"></span>\n                <span class="item-actions__label-wrapper">\n                    <span class="item-actions__digg__count js--digg-btn__count"></span>\n                    <span class="item-actions__label item-actions__digg__label js--digg-label">Digg</span>\n                </span>\n            </button>\n            <button class="digg-story__action--save item-actions__action js--save-btn">\n                <span class="item-actions__save__icon"></span>\n                <span class="item-actions__label js--save-btn-label">Save</span>\n            </button>\n            <span class="item-actions__share-actions">\n                <button href="<%= fblink %>" class="item-actions__action js--facebook-share-btn">\n                    <span class="item-actions__facebook__icon"></span>\n                    <span class="item-actions__label">Share</span>\n                </button>\n                <button href="<%= tweetlink %>" class="item-actions__action js--tweet-btn">\n                    <span class="item-actions__twitter__icon"></span>\n                    <span class="item-actions__label">Tweet</span>\n                </button>\n            </span>\n        </div>\n\n    </div>\n</article>\n'}),define("text!bs/templates/saved_nav.html",[],function(){return'<li id="saved-stories-container" class="nav-item nav-saved"><a class="nav-link" href="#savedstories" id="btn-savedstories">Saved <sup id="savedstories-new-count" class="savedstories-none"><%= savedStoryCount %></sup></a></li>'}),define("text!bs/templates/reader/feed_zero_saved.html",[],function(){return'<div class="zero-items-message">\n    <h2 class="zero-items-message-hed">You haven&rsquo;t saved anything yet.</h2>\n    <p>Click the <span class="save-icon">SAVE ICON</span> to save an item here.</p>\n</div>\n'}),define("bs/widgets/savedstories",["bs/core","bs/util/xhr","bs/util/format","bs/util/storyactions2","bs/util/storyscores","text!bs/templates/story_saved.html","text!bs/templates/saved_nav.html","text!bs/templates/reader/feed_zero_saved.html","bootstrap_modal","lodash"],function(e,t,n,r,i,s,o,u,a,f){function E(t){var r=[""],i=[];t.length===0?b.html(y):($("#btn-savedstories-more").remove(),f.each(t,function(t,s){t.view="saved",t.position=s,t.content.link_to_publisher=!0,t.content.link_target=t.content.link_to_publisher?"_blank":"_self",t.content.title=t.content.title_alt?t.content.title_alt:t.content.title,t.formattedDate=n.secondsToFuzzyTime(t.date),t.tweetlink="https://twitter.com/intent/tweet?url=http://on.digg.com/"+t.content.content_id+"&via=Digg&text="+encodeURIComponent(t.content.title),t.fblink="https://www.facebook.com/dialog/feed?display=popup&app_id="+e.config.FB_APP_ID+"&link=http://on.digg.com/"+t.content.content_id+"&redirect_uri=http://digg.com/fbshare",i.push(t.content.content_id),r.push(m(t))}),p!=="-1"&&r.push('<div id="btn-savedstories-more" class="btn-action">Load more...</div>'),b.append(r.join("")).parents(".modal").removeClass("loading"),h=l.find(".modal-body").get(0).scrollHeight,e.pubsub.fire("savedstories_rendered",i)),b.parents(".modal").removeClass("loading")}function S(){var e=new t.dataProvider({url:"/api/readlater/stats.json",success:function(e){v=e.data["new"],$("#nav-user").before(g({savedStoryCount:v})),v>0&&$("#savedstories-new-count").removeClass("savedstories-none")}});e.request()}function x(){var e=$("#savedstories-new-count"),n=new t.dataProvider({url:"/api/readlater/stats.json",success:function(t){v=t.data["new"],e.html(v),v>0&&e.removeClass("savedstories-none")}});n.request()}function T(e){var t=$("#savedstories-new-count"),n=~~t.html()||0;n+=e,n>0?t.removeClass("savedstories-none"):t.addClass("savedstories-none"),t.html(n)}function N(e,t,n){return $(".story-"+n).addClass("story-deleted").find(".save-"+n).text("Undo"),!1}function C(e,t,n){return $(".story-"+n).removeClass("story-deleted").find(".save-"+n).text("Saved"),!1}var l,c,h,p,d,v=0,m=f.template(s),g=f.template(o),y=f.template(u),b=$("#modal-savedstories-container"),w=new t.dataProvider({url:"/api/readlater.json",cache:!1,success:function(e){c=e.data.feed,p=e.data.next_position,d=e.data.total_count,E(c)},error:function(e){b.html('<div class="stories-error">There was a problem loading Saved stories. <br/>We\'re working on a fix. Wait a moment and try again.</div>')}});e.pubsub.on("saved_stories","add_reading_list_success",function(){T(1)}),e.pubsub.on("saved_stories","delete_reading_list_request",function(){T(-1)});var k={initialize:function(t){e.user.isLoggedIn()?x():e.pubsub.one("savedstories",e.pubsub.channels.user_auth,S),l=$(t.elID).modal({keyboard:!0,show:!1}),e.pubsub.on("story_scores","savedstories_rendered",function(e){var t=i.factory("saved_stories_"+(new Date).valueOf());t.register(e)}),$(document).on("click touchend","#btn-savedstories",k.show).on("click touchend","#btn-savedstories-modal-close",k.hide).on("click touchend",".btn-deleted-undo",C).on("click touchend","#btn-savedstories-more",function(){$(this).addClass("loading").html("<span class='loading-txt'>Loading ...</span>"),w.request({data:{position:p}})})},show:function(){var t=Math.floor($(window).height()*.8),n=l.find(".modal-body");return l.addClass("loading").css({height:t+"px",marginTop:"-"+Math.floor(t/2)+"px"}).modal("show"),n.height(t-l.find(".modal-header").height()-100+"px"),w.request(),$(document).on("click touchend",k.hide),e.pubsub.on("savedstories_list","delete_reading_list_request",N),e.pubsub.on("savedstories_list","add_reading_list_success",C),e.pubsub.fire("savedstories_modal_displayed"),!1},hide:function(t){var n=$(t.target).closest(l),r=$(t.target).attr("id")==="btn-savedstories-modal-close";if(n.length===0||r)l.modal("hide"),b.html("").empty(),$(document).off("click touchend",k.hide),e.pubsub.off("savedstories_list","delete_reading_list_request",N),e.pubsub.off("savedstories_list","add_reading_list_success",C);return!1}};return k}),define("bs/util/touchit",["bs/util/interface"],function(e){function t(e,t,n,r){if(e.addEventListener)return e.addEventListener(t,n,r),{destroy:function(){e.removeEventListener(t,n,r)}};var i=function(e){n.handleEvent(window.event,n)};return e.attachEvent("on"+t,i),{destroy:function(){e.detachEvent("on"+t,i)}}}function i(e,n,i){this.events=[],this.touchEvents=[],this.element=e,this.handler=n,this.useCapture=i,this.addClassTimer=null,this.removeClassTimer=null,r?this.events.push(t(e,"touchstart",this,this.useCapture)):this.events.push(t(e,"click",this,this.useCapture)),document.addEventListener("click",this.clickbuster.onClick,!0),this.clickbuster.coordinates=[]}var n="touching",r="ontouchstart"in window;return i.prototype={destroy:function(){for(var e=this.events.length-1;e>=0;e-=1)this.events[e].destroy();this.events=this.touchEvents=this.element=this.handler=this.fastButton=null},handleEvent:function(e){switch(e.type){case"touchstart":this.onTouchStart(e);break;case"touchmove":this.onTouchMove(e);break;case"touchend":this.onClick(e);break;case"click":this.onClick(e)}},onTouchStart:function(e){var r=this.element,i=n;this.touchEvents.push(t(this.element,"touchend",this,this.useCapture)),this.touchEvents.push(t(document.body,"touchmove",this,this.useCapture)),this.startX=e.touches[0].clientX,this.startY=e.touches[0].clientY,this.addClassTimer!=null&&clearTimeout(this.addClassTimer),this.removeClassTimer!=null&&clearTimeout(this.removeClassTimer),this.hasClass(r,i)||(this.addClassTimer=setTimeout(function(){r.className=r.className+" "+i},10),this.removeClassTimer=setTimeout(function(){r.className=r.className.replace(new RegExp("\\b"+i+"\\b"),"")},310))},onTouchMove:function(e){if(Math.abs(e.touches[0].clientX-this.startX)>10||Math.abs(e.touches[0].clientY-this.startY)>10)this.removeClass(this.element,n),this.reset()},onClick:function(e){e.stopPropagation();var t=this.handler.call(this.element,e);return e.type==="touchend"&&this.clickbuster.preventGhostClick(this.startX,this.startY),this.reset(),t},addClass:function(e,t){e.className=e.className+" "+t},removeClass:function(e,t){e.className=e.className.replace(new RegExp("\\b"+t+"\\b"),"")},hasClass:function(e,t){return e.className.indexOf(t)>-1?!0:!1},reset:function(){clearTimeout(this.addClassTimer),this.addClassTimer=null,clearTimeout(this.removeClassTimer),this.removeClassTimer=null,setTimeout(this.removeClass(this.element,n),200);for(var e=this.touchEvents.length-1;e>=0;e-=1)this.touchEvents[e].destroy();this.touchEvents=[]},clickbuster:{preventGhostClick:function(e,t){this.coordinates.push(e,t),setTimeout(this.pop,2500)},pop:function(){typeof this.coordinates!="undefined"&&this.coordinates.splice(0,2)},onClick:function(e){if(typeof this.coordinates!="undefined")for(var t=0;t<this.coordinates.length;t+=2){var n=this.coordinates[t],r=this.coordinates[t+1];Math.abs(e.clientX-n)<25&&Math.abs(e.clientY-r)<25&&(alert("ghost click"),e.stopPropagation(),e.preventDefault())}}}},{factory:function(e,t,n){return new i(e,t,n)}}}),define("bs/widgets/notifications",["jquery","lodash","bs/core","bs/util/xhr","bs/util/scrollmonitor","bs/util/item_actions","bs/util/user_graph","bs/util/helpers"],function(e,t,n,r,i,s,o,u){function c(e,t,n){console.error("Error fetching unread notifications count:",n.message)}function h(e,t,n){console.error("Error fetching notifications feed",n.message),this._fetching=!1}function p(r){if(!r.el)throw Error("NotificationsWidget constructor: missing 'el' option");this._realtime=!0,this.el=r.el,this.$el=e(this.el),s.init(),o.init(),n.rtClient._supported?(n.pubsub.on("nav_notifications","realtime_client:message",t.bind(function(e){e.payload&&typeof e.payload.unread_count!="undefined"&&this.renderStatus({data:e.payload})},this)),n.pubsub.on("nav_notifications","realtime_client:open",t.bind(this.useRealtimeClient,this)),n.pubsub.on("nav_notifications","realtime_client:reconnect",t.bind(function(e){this.checkRealtimeClientConnect(e)},this))):this.usePollingDataProvider()}function d(r){if(!r.el)throw Error("NotificationsPageWidget constructor: missing 'el' option");this.el=r.el,this.$el=e(this.el),this.next_position=null,s.init(),o.init(),n.pubsub.on("notifications_stream","window_scroll_monitor:bottom",t.bind(this.getNextPage,this))}var a=3,f=new r.dataProvider({url:"/api/notifications/status.json",error:c}),l=new r.dataProvider({url:"/api/notifications/feed.json"});return p.prototype={fetchStatus:function(){f.request({success:t.bind(this.renderStatus,this),cache:!1})},checkRealtimeClientConnect:function(e){this._realtime&&e.num_attempts>=a&&this.usePollingDataProvider()},useRealtimeClient:function(){this._realtime=!0,f.stopPolling()},usePollingDataProvider:function(){var e=1e4;this._realtime=!1,f.startPolling(e,{success:t.bind(this.renderStatus,this),cache:!1})},renderStatus:function(e){var t=e.data.unread_count||0,n,r=this.$el,i="has--unread-notifications";n=t>99?"\u221e":t+"",t===0,t&&r.html(n),t>0?this.$el.addClass(i):this.$el.removeClass(i);if(!this.initialized){this.initialized=!0;return}}},d.prototype={fetchFeed:function(){var e={};if(this._fetching)return;return this.next_position&&(e.position=this.next_position),this._fetching=!0,l.request({data:e,success:t.bind(this.renderNotificationsFeed,this)})},renderNotificationsFeed:function(e){var t=e.html;e.next_position&&(this.next_position=e.next_position),this._fetching=!1,this.$el.find(".js--ico-loading").remove(),this.$el.find("#js--notifications-page-feed-container").append(t),n.scrollMonitor.updateScrollHeight(),n.scrollMonitor.monitor()},getNextPage:function(e){var t;if(this.next_position===-1)return;t=this.fetchFeed(),t&&(this.$el.find("#js--notifications-page-feed-container").append('<div class="ico-loading js--ico-loading notifications-page-loading"></div>'),n.pubsub.fire("loading_in_progress"))}},{factory:function(e){return e.type==="nav_widget"?new p(e):new d(e)}}}),define("bs/widgets/header",["jquery","lodash","modernizr","bs/core","bs/util/helpers","bs/util/touchit","bs/widgets/notifications"],function(e,t,n,r,i,s,o){function g(e){return n.csstransitions?(l.on(m,y),u.addClass(h)):y(),c.focus(),!1}function y(t){e(document).on("click touchend",b),n.csstransitions?(l.off(m,y),u.removeClass(h).addClass(p)):u.addClass(p),v=!0}function b(t){n.csstransitions&&t.target.name!=="q"&&v?(e(document).off("click touchend",b),l.on(m,w),u.removeClass(p).addClass(d)):v&&t.target.name!=="q"&&w(t)}function w(t){n.csstransitions?(l.off(m,w),u.removeClass(d)):u.removeClass(p),v=!1,c.blur(),e(document).off("click touchend",b)}function E(t){n.csstransitions&&l.off(m,w),u.removeClass(d),u.removeClass(p),v=!1,c.blur(),e(document).off("click touchend",b)}function N(){e(".js--btn-profile-tooltip").on("click",C)}function C(n){var r=e(this),i=document.getElementById("js--nav-notifications"),s=i.innerHTML||0;if(r.hasClass(T))return;s&&(document.getElementById("js--profile-tooltip-notification-count").innerHTML=s),r.addClass(T),t.delay(function(){e(document).on("click",k)},500)}function k(t){var n=e(t.currentTarget);!n.hasClass("js--btn-profile-tooltip")&&!n.hasClass("nav-profile-tooltip__action")&&(e(document).off("click",k),e("."+T).removeClass(T))}var u=e(".js--digg-header"),a=document.getElementById("js--nav-search"),f=e(a),l=e("#form-digg-search"),c=e("#form-digg-search-input"),h="is--search-expanded",p="is--search-active",d="is--search-collapsed",v=!1,m=i.transitionEndEventNames[n.prefixed("transition")],S={init:function(t){t=t||{},t.headerSelector&&(u=e(t.headerSelector)),t.searchLabelEl&&(a=t.searchLabelEl,f=e(a)),t.formSelector&&(l=e(t.formSelector)),t.inputSelector&&(c=e(t.inputSelector)),document.addEventListener?s.factory(a,g):f.on("click",g),r.pubsub.on("mobileheader","mobile_nav_collapse",E)}},x,T="is--profile-tooltip-visible";return{init:function(){if(!u.length)return;N(),r.user.isLoggedIn()&&(x=o.factory({el:document.getElementById("js--nav-notifications"),type:"nav_widget"}),x.fetchStatus()),S.init({headerSelector:"#js--digg-header",searchLabelEl:document.getElementById("js--nav-search"),formSelector:"#form-digg-search",inputSelector:"#form-digg-search-input"}),e(".channel__subnav-wtf").addClass("is--visible")}}}),define("bs/widgets/mobileheader",["jquery","bs/core","bs/util/touchit","lodash"],function(e,t,n,r){function a(n){var r="mobile-nav-active";u&&(f(),u=!1),s.hasClass(r)?(s.removeClass(r),e("body").removeClass("freeze-scroll"),t.pubsub.fire("mobile_nav_collapse")):(s.addClass(r),e("body").addClass("freeze-scroll"))}function f(){var e=l(),t=s.height(),n=e-t;window.matchMedia&&window.matchMedia("(max-width:879px)").matches?o.css("height",n):window.matchMedia&&window.matchMedia("(min-width:880px)").matches&&o.css("height",55)}function l(){return document.documentElement.clientHeight}function c(){f(),u=!1}function h(e){var t=document.getElementById("digg-header");if(e&&e.target===t)return e.stopPropagation(),e.preventDefault(),!1}var i=document.getElementById("digg-nav-toggle"),s=e("#digg-header"),o=s.find(".digg-nav-wrap"),u=!0;return{init:function(){e(window).on("resize orientationchange",r.throttle(c,100)),e(document).on("touchstart",h),document.addEventListener?n.factory(i,a):e(i).on("click",a)}}}),define("bs/widgets/promobanner",["require","bs/core","bs/util/tracker","bs/util/cookies"],function(e,t,n,r){function a(){$(this).hasClass("js--set-no-cookie")||r.set({name:u,value:1,expires:new Date((new Date).valueOf()+31536e6),path:"/"}),$("body").addClass("promo-collapse"),o.off("click touchend",".promo-close-btn",a),i.trackEvent("Promo Banner",u,"close")}function f(){$("body").removeClass("promo-collapse"),i.trackEvent("Promo Banner",u,"open")}var i=new n,s=!1,o=$("#site-promo-banner"),u=o.data("campaign"),l={init:function(){o.length>0&&!s&&($("body").hasClass("promo-collapse")?setTimeout(f,1500):i.trackEvent("Promo Banner",u,"already-open"),o.on("click touchend",".promo-close-btn",a),s=!0)}};return l}),define("bs/widgets/popularvideos",["bs/core","bs/util/xhr","bs/util/storyscores","lodash"],function(e,t,n,r){function c(){i.addClass("loaded"),s.html("<div class='stories-error'>There was problem loading the Most Dugg Videos. Wait a moment and try again.</div>")}var i=$("#popular-videos"),s=i.find(".content"),o=n.factory("popular_videos"),u=[],a=!1,f={count:5,exclude_sponsored:!0,format:"html"},l=new t.dataProvider({url:"/api/video/popular.json",data:f,success:function(e){i.addClass("loaded"),s.empty().append(e.html),i.find(".js--digg-story").each(function(e,t){u.push($(t).data("contentId"))}),u.length&&o.register(u)},error:function(e){c()}});return{init:function(){if(a)return;a=!0,l.request()}}}),define("bs/widgets/popularstories",["bs/core","bs/util/xhr","bs/util/storyscores","lodash"],function(e,t,n,r){function l(){i.addClass("loaded"),s.html('<div class="stories-error">There was problem loading the Most Dugg Stories. Wait a moment and try again.</div>')}var i=$("#popular-stories"),s=i.find(".content"),o={count:10,exclude_sponsored:!0,exclude_videos:!0,format:"html"},u=n.factory("popular_stories"),a=[],f=!1,c=new t.dataProvider({url:"/api/news/popular.json",data:o,success:function(e){i.addClass("loaded"),s.empty().append(e.html),i.find(".js--digg-story").each(function(e,t){a.push($(t).data("contentId"))}),a.length&&u.register(a)},error:function(e,t,n){l()}});return{init:function(){if(f)return;f=!0,c.request()}}}),define("bs/widgets/upcomingstories",["bs/core","bs/util/xhr","bs/util/storyscores","lodash"],function(e,t,n,r){function c(){i.addClass("loaded"),s.html('<div class="stories-error">There was problem loading the Upcoming Stories. Wait a moment and try again.</div>')}var i=$("#upcoming-stories"),s=i.find(".content"),o=n.factory("upcoming_stories"),u=[],a=!1,f={count:15,format:"html"},l=new t.dataProvider({url:"/api/news/upcoming.json",data:f,success:function(e){i.addClass("loaded"),s.empty().append(e.html),i.find(".js--digg-story").each(function(e,t){u.push($(t).data("contentId"))}),u.length&&o.register(u)},error:function(e){c()}});return{init:function(){if(a)return;a=!0,l.request()}}}),define("bs/widgets/footer",["bs/core","bs/util/xhr","jquery"],function(e,t,n){function r(){var r=n.trim(n("#digg-reader-email-form-input").val()),i="/api/promo/signup.json",s=new t.dataProvider({url:i,type:"POST",data:{promo:"reader_android",email:r},success:function(t){n("#digg-reader-email-form").hide(),n("#digg-reader-email-error").hide(),n("#digg-reader-email-success").html("Thanks!").show(),e.pubsub.fire("save_digg_reader_submit_complete")},error:function(e){n("#digg-reader-email-error").html("There was a problem submitting your email.").show()}});return s.request(),!1}function i(){var r=n.trim(n("#daily-digg-email-input").val()),i="/api/dailydiggemail.json",s=new t.dataProvider({url:i,type:"POST",data:{email:r},success:function(t){n("#daily-digg-email-form").hide(),n("#daily-digg-email-error").hide(),n("#daily-digg-email-success").html("Thanks for subscribing!").show(),e.pubsub.fire("save_daily_digg_submit_complete")},error:function(e){n("#daily-digg-email-error").html("There was a problem submitting your email. Please try again.").show()}});return s.request(),!1}n(function(){Modernizr.inputtypes.email&&n("#daily-digg-email-input").clone().attr("type","email").insertAfter("#daily-digg-email-input").prev().remove(),n("#daily-digg-email-input").on("keyup",function(e){e.keyCode==13?i():n("#daily-digg-email-error").html("&nbsp;")}),n("#daily-digg-email-submit-btn").on("click",function(e){i()}),n("#digg-reader-email-form-input").on("keyup",function(e){return e.keyCode==13?r():n("#digg-reader-email-error").html("&nbsp;"),e.stopPropagation(),e.preventDefault(),!1}),n("#reader-promo-submit-btn").on("click",function(e){r()}),n("#daily-digg-email-form").addClass("ready"),n("#digg-reader-email-form").addClass("ready")})}),define("text!bs/templates/deeper/story_modal.html",[],function(){return'<div class="js--modal--digg-deeper-story modal--digg-deeper modal fade hide" role="dialog" aria-hidden="true">\n\n    <div class="js--btn-modal-close modal--digg-deeper__close">&#x2716;</div>\n\n    <%= storyDetailsHTML %><!-- will be article.digg-story element -->\n\n    <div class="modal--digg-deeper__shared-by">Shared by <%= sharerCount %> people</div>\n\n    <div class="modal--digg-deeper_sharers">\n        <%= sharersHTML %>\n\n        <div class="ico-loading"></div>\n    </div>\n\n</div>\n'}),define("text!bs/templates/deeper/story.html",[],function(){return'<% \n/**\n * Template for a story living in the Digg Deeper stream\n */\n%>\n\n<article \n    class="digg-story--deeper\n        js--digg-story\n        js--story-<%= content.content_id %>\n        <%= dugg ? \'is--dugg\' : \'\' %>\n        <%= read_later ? \'is--saved\' : \'\' %>\n    " \n    data-content-id="<%= content.content_id %>"\n    data-contenturl="<%= content.url %>"\n    data-position="<%= position %>"\n    data-source="<%= source %>"\n>\n    <% if ( ! tweets.hideSharers) { %>\n        <% if (feed === \'fof\') { %>\n            <div class="digg-story--deeper__sharers">\n                <% var sharer, tweet; %>\n                <% for (var s = 0, lenTweets = friends.data.length > maxSharersDisplayed ? maxSharersDisplayed : friends.data.length; s < lenTweets; s++) { %>\n                    <% sharer = friends.data[s]; %>\n                        <figure class="digg-story--deeper__sharer-img-container js--digg-deeper__sharer-img-container">\n                            <a href="/u/<%= sharer.user_id %>/deeper" class="digg-story--deeper__sharer-link">\n                                <img class="digg-story--deeper__sharer-img js--digg-deeper-sharer-img" src="<%= sharer.profile_image_url %>" alt="Image of <%= sharer.name %>">\n                            </a>\n                            <figcaption class="digg-story--deeper__sharer-name">\n                                <!-- <%= sharer.name %> -->\n                            </figcaption>\n                        </figure>\n                        <% if (lenTweets === 1) { %>\n                            <span class="digg-story--deeper__single-sharer-label">Top story for <%= sharer.name %></span>\n                        <% } %>\n                <% } %>\n\n                <% if (tweets.count > maxSharersDisplayed) { %>\n                    <span class="<%= ~~tweets.count - maxSharersDisplayed > 10 ? \'digg-story--deeper__sharers-circle--sml\' : \'digg-story--deeper__sharers-circle\' %>">\n                        <span class="digg-story--deeper__sharers-total">+<%= ~~tweets.count - maxSharersDisplayed %></span>\n                    </span>\n                <% } %>\n            </div>\n        <% } else { %>\n            <div class="digg-story--deeper__sharers">\n                <% var sharer, tweet; %>\n                <% for (var s = 0, lenTweets = tweets.data.length > maxSharersDisplayed ? maxSharersDisplayed : tweets.data.length; s < lenTweets; s++) { %>\n                    <% tweet = tweets.data[s]; %>\n                    <% sharer = tweet.user; %>\n                        <figure class="digg-story--deeper__sharer-img-container js--digg-deeper__sharer-img-container">\n                            <span class="digg-story--deeper__sharer-link js--btn-show-digg-story-modal" data-screenname="<%= sharer.screen_name %>">\n                                <img class="digg-story--deeper__sharer-img" src="<%= sharer.profile_image_url %>" alt="Image of <%= sharer.name %>">\n                            </span>\n                            <% if ( ! tweets.hideTweetDetails) { %>\n                                <figcaption class="digg-story--deeper__sharer-tweet js--digg-deeper__sharer-details">\n                                    <img class="digg-story--deeper__sharer-img-detail" src="<%= sharer.profile_image_url %>" alt="Image of <%= sharer.name %>">\n                                    <div class="digg-story--deeper__sharer-tweet-details-label">From Twitter</div>\n                                    <span class="digg-story--deeper__sharer-tweet-name"><%= sharer.name %></span> <span class="digg-story--deeper__sharer-tweet-screenname">@<%= sharer.screen_name %></span> <a class="digg-story--deeper__sharer-tweet-link" href="<%= tweet.url %>" target="_blank"><%= tweet.fuzzyTimeStamp %></a>\n                                    <div class="digg-story--deeper__sharer-tweet-text"><%= tweet.text %></div>\n                                </figcaption>\n                            <% } %>\n                        </figure>\n                        <% if (lenTweets === 1) { %>\n                            <span class="digg-story--deeper__single-sharer-label"><%= sharer.name %></span>\n                        <% } %>\n                <% } %>\n\n                <% if (tweets.count > maxSharersDisplayed) { %>\n                    <span class="<%= ~~tweets.count - maxSharersDisplayed > 10 ? \'digg-story--deeper__sharers-circle--sml\' : \'digg-story--deeper__sharers-circle\' %>  js--btn-show-digg-story-modal">\n                        <span class="digg-story--deeper__sharers-total">+<%= ~~tweets.count - maxSharersDisplayed %></span>\n                    </span>\n                <% } %>\n            </div>\n        <% } %>\n    <% } %>\n\n    <div class="digg-story--deeper__content">\n        <header class="digg-story--deeper__header">\n            <h2 class="digg-story--deeper__title">\n                <a \n                    class="digg-story--deeper__title-link js--digg-story__link"\n                    href="<%= content.url %>"\n                    target="<%= content.link_target %>"\n                >\n                    <%= content.title %></a>\n            </h2>\n\n            <div class="digg-story--deeper__metadata-container">\n                <% if (showDiversityScore && digg_rank_score_display && digg_rank_score_display !== 0) { %>\n                    <span class="digg-story--deeper__metadata-score">\n                        <%= digg_rank_score_display %> \n                    </span>\n                <% } %>\n\n                <span class="digg-story--deeper__metadata--source">\n                    <a \n                        itemprop="publisher copyrightHolder sourceOrganization provider"\n                        class="digg-story--deeper__metadata--link js--digg-story__link"\n                        href="<%= content.url %>"\n                        target="<%= content.link_target %>"\n                    >\n                        <%= content.domain %>\n                    </a>\n                </span>\n\n                <% if (date !== null) { %>\n                    <abbr class="published digg-story--deeper__metadata--timestamp">\n                       <time><%= formattedDate %></time>\n                    </abbr>\n                <% } %>\n\n                <ul class="digg-story--deeper__actions--metadata-list">\n                    <li class="digg-story--deeper__action--digg js--digg-story-action--digg">\n                        <span class="js--digg-label digg-story--deeper__action-label"><%= dugg ? \'Dugg\' : \'Digg\' %></span>\n                    </li>\n                    <li class="digg-story--deeper__action--save js--digg-story-action--save">\n                        <span class="js--save-btn-label digg-story--deeper__action-label"><%= read_later ? \'Saved\' : \'Save\' %></span>\n                    </li>\n                    <li class="digg-story--deeper__action--share js--digg-story-action--share">\n                        <div class="digg-story--deeper__share-tooltip">\n                            <ul class="digg-story--deeper__share-action-list">\n                                <li class="digg-story--deeper__share-action-item"><a href="<%= tweetlink %>" class="digg-story--deeper__share-link js--tweet-btn">Share to Twitter</a></li>\n                                <li class="digg-story--deeper__share-action-item"><a href="<%= fblink %>" class="digg-story--deeper__share-link js--facebook-share-btn">Share to Facebook</a></li>\n                            </ul>\n                        </div>\n                        \n                        <span class="js--share-label digg-story--deeper__action-label">Share</span>\n                    </li>\n\n                    <% if ( ! tweets.hideSharers && ! tweets.hideTweetDetails) { %>\n                        <li class="digg-story--deeper__action js--btn-show-digg-story-modal">\n                            <span class="digg-story--deeper__action-label">View Tweets</span>\n                        </li>\n                    <% } %>\n\n                </ul>\n            </div>\n        </header>\n\n        <% if (typeof noContentPreview === \'undefined\' || ! noContentPreview) { %>\n            <div class="digg-story--deeper__content-preview">\n                <% if (content.video) { %>\n                    <%= content.video %>\n                <% } else if (content.media.images.length && content.media.images[0].url && content.media.images[0].url.length && content.media.images[0].url.indexOf(\'http\') > -1) { %>\n                    <figure class="digg-story--deeper__img-container"><a class="digg-story--deeper__img-link js--digg-story__link"\n                            href="<%= content.url %>"\n                            target="<%= content.link_target %>"><img src="<%= content.media.images[0].url %>" alt="" class="digg-story--deeper__img js--digg-story__img"></a></figure>\n                <% } %>\n\n                <% if (content.description) { %>\n                    <p class="digg-story--deeper__description">\n                        <%= content.description %>\n                    </p>\n                <% } %>\n            </div>\n        <% } %>\n    </div>\n\n</article>\n'}),define("text!bs/templates/deeper/story_sharer_tweet.html",[],function(){return'<div class="digg-story--deeper__sharer story-embedded-share">\n    <a href="https://twitter.com/<%= sharer.screen_name %>" target="_blank" class="digg-story--deeper__sharer-link" data-screenname="<%= sharer.screen_name %>">\n        <img class="digg-story--deeper__sharer-img" src="<%= sharer.profile_image_url %>" alt="Image of <%= sharer.name %>" title="<%= sharer.name %>">\n    </a>\n    <div class="digg-story--deeper__sharer__body">\n        <div class="digg-story--deeper__sharer__user-info">\n            <a href="https://twitter.com/<%= sharer.screen_name %>" target="_blank" class="digg-story--deeper__sharer__name-link">\n                <%= sharer.name %>\n            </a>\n            <a href="https://twitter.com/<%= sharer.screen_name %>" target="_blank" class="digg-story--deeper__sharer__meta-link">\n                @<%= sharer.screen_name %>\n            </a>\n            <span class="digg-story--deeper__sharer__meta-text">&middot;</span>\n            <a href="<%= tweet.url %>" target="_blank" class="digg-story--deeper__sharer__meta-link">\n                <%= tweet.fuzzyTimeStamp.replace(\' ago\', \'\') %>\n            </a>\n        </div>\n\n        <div class="digg-story--deeper__sharer__text">\n            <%= tweet.text %>\n        </div>\n\n        <ul class="horizontal-list story-embedded-tweet-actions">\n            <li><a class="btn-tweet-reply digg-story--deeper__sharer__tweet-action-link" href="https://twitter.com/intent/tweet?in_reply_to=<%= tweet.id %>">Reply</a></li>\n            <li><a class="btn-tweet-retweet digg-story--deeper__sharer__tweet-action-link" href="https://twitter.com/intent/retweet?tweet_id=<%= tweet.id %>">Retweet</a></li>\n            <li><a class="btn-tweet-favorite digg-story--deeper__sharer__tweet-action-link" href="https://twitter.com/intent/favorite?tweet_id=<%= tweet.id %>">Favorite</a></li>\n        </ul>\n    </div>\n</div>\n'}),define("bs/widgets/digg_deeper_story_modal",["bs/core","bs/util/xhr","bs/util/format","bs/util/helpers","text!bs/templates/deeper/story_modal.html","text!bs/templates/deeper/story.html","text!bs/templates/deeper/story_sharer_tweet.html","autolinker","lodash","bootstrap_modal","jquery"],function(e,t,n,r,i,s,o,u,a,f,l){function y(e,t){var n={content_id:e,full_text:!0};m.request({data:n,success:function(e){if(!e||!e.data||!e.data.feed||!e.data.feed.length)return console.error("unexpected response format:",e),t("failed");t(null,e.data.feed[0])},error:function(e,n,r){console.error("failed to get full alert:",n,r),t(r)}})}function b(e,t){c.removeClass("is--loading");if(e)return;var n=t.tweets.data.splice(10);n=w(n),l(E(n)).appendTo(l(".modal--digg-deeper_sharers"))}function w(e){return a.each(e,function(e){e.url=r.getTweetURL({twitter_screen_name:e.user.screen_name,tweet_id:e.id}),e.fuzzyTimeStamp=n.secondsToFuzzyTime(e.date),e.text=u.link(e.text)}),e}function E(e){return a.map(e,function(e){return v({tweet:e,sharer:e.user})}).join("\n")}function S(t,i,s){return t.position=i,t.formattedDate=n.secondsToFuzzyTime(t.date),t.content.title||(t.content.title=t.tweets.data[0].text),t.content.link_target="_blank",t.fblink=r.getFacebookStoryShareLink({app_id:e.config.FB_APP_ID,url:t.content.url}),t.tweetlink=r.getTweetStoryLink({url:t.content.url,title:t.content.title||t.tweets[0].text}),!t.content.media.videos.length&&t.content.media.images.length&&(t.content.description=n.truncate(t.content.description,g,!0)),t.tweets.hideSharers=!0,t.noContentPreview=!s,t.source="digg_deeper.modal",d(t)}var c,h={},p=a.template(i),d=a.template(s),v=a.template(o),m=new t.dataProvider({url:"/api/news/alert.json",cache:!1}),g=135,x={saveStoryDetails:function(e){a.each(e,function(e){e.tweets.data=w(e.tweets.data),h[e.story_id]=e})},show:function(e,t){var n=l(e.target).closest(".digg-story-el, .digg-story--deeper, article.expanded, article.feeditem-list"),r=n.data("content-id"),i=n.data("position"),s=h[r];if(!s)return;var o=p({storyDetailsHTML:S(s,i,t),sharersHTML:E(s.tweets.data),sharerCount:s.tweets.count});return c=l(o).appendTo("body").modal({keyboard:!0,show:!0}),l(document).on("click touchend",x.hide),s.tweets.count>10&&(c.addClass("is--loading"),y(r,b)),!1},hide:function(e){var t=l(e.target).hasClass("js--btn-modal-close"),n=l(e.target).closest(".js--modal--digg-deeper-story").length>0;if(t||!n)l(".js--modal--digg-deeper-story").modal("hide").remove(),l(document).off("click touchend",x.hide)}};return x}),define("text!bs/templates/deeper/stream_container_frontpage.html",[],function(){return'<header class="widget-hdr">\n    <h3 class="widget-hdr__title"><a class="widget-hdr__link" href="/deeper">Digg Deeper</a></h3>\n    <a class="widget-hdr__link--view-all" href="/deeper">View All</a>\n    <span id="alerts-sortby">\n        <select class="digg-deeper__sort-select js--digg-deeper-sort-select" dir="rtl">\n            <option value="score">Sort by: Most Shared</option>\n            <option value="date">Sort by: Time</option>\n        </select>\n    </span>\n</header>\n<div \n    id="digg-deeper" \n    class="stories-container" \n    data-tracking-section="Frontpage: Digg Deeper"\n>\n    <div class="ico-loading alerts-first-page-loading"></div>\n</div>\n'}),define("text!bs/templates/alerts/onboarding.html",[],function(){return'<div class="btn-alerts-close btn-alerts-opt-out">&#x2716;</div>\n<h3 class="alerts-hdr">Digg Deeper</h3>\n<p class="alerts-desc">Digg now shows you the <span class="nowrap">most-shared</span> stories from your Twitter friends.</p>\n<p><a href="http://blog.digg.com/post/91454524841/digg-deeper" target="_blank">Learn how it works</a></p>\n<p><button class="btn-primary btn-enable-alerts"><%= isUserLoggedIn && hasTwitter ? \'Turn On\' : \'Sign In with Twitter\' %></button></p>\n'}),define("text!bs/templates/alerts/email_onboarding.html",[],function(){return'<p class="alerts-desc first-el">You\'ll see your most-shared stories from Twitter here in a moment.</p>\n<p class="alerts-desc">Want to also get email alerts for these stories?</p>\n<p><input type="email" id="input-alerts-email" placeholder="you@domain.com" value="<%= email %>">\n<button class="btn-primary btn-enable-alerts-email">Enter</button></p>\n<p class="btn-alerts-email-skip">Skip this step</p>\n'}),define("text!bs/templates/alerts/email_onboarding_details.html",[],function(){return'<div class="email-details-container">\n\n    <p class="alerts-desc first-el">What emails would you like to receive?</p>\n\n    <div class="email-details">\n        <p><label><input type="radio" name="email-setting" value="alerts">Real-time alerts<br>\n            <span class="note">Up to 5 emails/day</span></label>\n        </p>\n        <p><label><input type="radio" name="email-setting" value="digest">Daily email summary</label></p>\n        <p><label><input type="radio" name="email-setting" value="both" checked>Both</label></p>\n    </div>\n\n    <p><button class="btn-primary btn-alerts-email-details-continue">Continue</button></p>\n\n    <input type="hidden" id="input-alerts-email" value="<%= email %>">\n\n</div>\n'}),define("bs/widgets/alerts",["bs/core","bs/util/xhr","bs/util/format","bs/util/cookies","bs/util/helpers","bs/util/item_actions","bs/widgets/digg_deeper_story_modal","text!bs/templates/deeper/stream_container_frontpage.html","text!bs/templates/deeper/story.html","text!bs/templates/alerts/onboarding.html","text!bs/templates/alerts/email_onboarding.html","text!bs/templates/alerts/email_onboarding_details.html","lodash","jquery"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function k(t,r){return t.position=r,t.formattedDate=n.secondsToFuzzyTime(t.date),t.content.title||(t.content.title=t.tweets.data[0].text),t.content.displayTitle=n.truncate(t.content.title,m),t.content.link_target="_blank",t.fblink=i.getFacebookStoryShareLink({app_id:e.config.FB_APP_ID,url:t.content.url}),t.tweetlink=i.getTweetStoryLink({url:t.content.url,title:t.content.title||t.tweets[0].text}),h.each(t.tweets.data,function(e){e.url=i.getTweetURL({twitter_screen_name:e.user.screen_name,tweet_id:e.id}),e.fuzzyTimeStamp=n.secondsToFuzzyTime(e.date)}),t.noContentPreview=!0,t.maxSharersDisplayed=6,t.feed="digg_deeper",t.showDiversityScore=!1,t.source="homepage.digg_deeper",g(t)}function L(e){var t=p(this),n=this.scrollTop,r=this.scrollHeight,i=t.height(),s=e.type=="DOMMouseScroll"?e.originalEvent.detail*-40:e.originalEvent.wheelDelta,o=s>0,u=function(){return e.stopPropagation(),e.preventDefault(),e.returnValue=!1,!1};if(t.hasClass("no-alerts-pagination"))return!0;if(!o&&-s>r-i-n)return t.scrollTop(r),u();if(o&&s>n)return t.scrollTop(0),u()}function A(e){e=e||{};if(!e.id)throw new Error("Missing id selector for Alerts widget");this.id=e.id,this.el=document.getElementById(this.id),this.$el=p(this.el),e.elHeight&&this.setElHeight(e.elHeight)}var d="We're working on finding the best stories from your Twitter stream. While you're waiting, check out some of our most dugg stories.",v="twitter-news-optout",m=75,g=h.template(a),y=0,b,w,E=require("bs/core").user,S,x=new t.dataProvider({url:"/api/news/alerts/top.json",cache:!1}),T,N=new t.dataProvider({url:"/api/news/popular.json",data:{count:10,exclude_sponsored:10,exclude_videos:10},success:function(e){T=e.data.feed},error:function(e,t,n){}}),C=N.request();return A.prototype={alertsOnboardingTemplate:h.template(f),emailOnboardingTemplate:h.template(l),emailOnboardingDetailsTemplate:h.template(c),init:function(t){var n=r.get(v);if(!this.el)return;e.mediaQueriesMonitor.addQuery("(max-width: 480px)",h.bind(this.handlePhoneLayout,this)),!E.isLoggedIn()&&!n||!E.deepGet("apps.digg_deeper.enabled")?(e.pubsub.fire("digg_deeper:onboarding:start"),this.renderOnboarding(),E.isLoggedIn()||e.pubsub.one("site_nav_user_widget",e.pubsub.channels.user_auth,h.bind(function(){E.deepGet("apps.digg_deeper.enabled")?this.renderDiggDeeper():this.renderOnboarding()},this))):E.deepGet("apps.digg_deeper.enabled")&&this.renderDiggDeeper()},handlePhoneLayout:function(){},renderDiggDeeper:function(){this.el.className="alerts-enabled",this.el.innerHTML="",S=S||E.get("deeper_sortby")||"score",this.renderStreamContainer(),this.setStreamElHeight(),this.$el.find("#digg-deeper").show(1),this.fetch(),this.$el.on("click",".digg-story--deeper__sharer-link",h.bind(this.handleStorySharerClick,this)).on("click",".js--btn-show-digg-story-modal",h.bind(this.showDeeperModal,this)).on("click",".ico-settings",h.bind(this.handleSettingsClick,this)).on("mouseover",".js--digg-deeper__sharer-img-container",h.bind(this.positionTooltip,this))},positionTooltip:function(e){var t=p(e.currentTarget),n=t.find(".js--digg-deeper__sharer-details"),r=t.position();n.css({top:r.top})},handleStorySharerClick:function(t){var n=p(t.currentTarget).data("screenname")||"Unknown";e.pubsub.fire("digg_deeper:stream:sharer_click",n)},showDeeperModal:function(e){e.stopPropagation(),e.preventDefault(),o.show(e,!0)},handleSettingsClick:function(t){e.pubsub.fire("digg_deeper:stream:settings_click")},setElHeight:function(e){var t=parseInt(this.$el.css("padding-top"),10),n=parseInt(this.$el.css("padding-bottom"),10);this.$el.height(e-t-n),this.$el.hasClass("alerts-enabled")&&this.setStreamElHeight()},fetch:function(){var e;e={sortby:S,full_text:!0},w!=null&&(e.position=w),x.request({data:e,success:h.bind(this.checkFeedResponse,this),error:h.bind(this.handleStreamRequestError,this)})},getNextPage:function(t){w!=="-1"&&b!==w&&(this.$el.find("#digg-deeper").append('<div class="ico-loading js--ico-loading alerts-page-loading"></div>'),b=w,this.fetch(),e.pubsub.fire("loading_in_progress"))},handleStreamRequestError:function(e,t,n){this.renderImportFailed(d)},checkFeedResponse:function(t,n,r){var i=t.data.polling.status,s=~~t.data.polling.interval*1e3,u=t.status_message||d;i===0?(w=t.data.next_position,y++,e.pubsub.fire("digg_deeper:stream:loaded",S,y),e.pubsub.fire("loading_in_done"),o.saveStoryDetails(t.data.feed),this.renderStories(t)):i===-1&&b==null?this.renderImportFailed(u):i===1&&setTimeout(h.bind(this.fetch,this),s)},renderImportFailed:function(e){var t=this.$el.find("#digg-deeper");this.$el.find(".ico-loading").remove(),t.hide(),t.append('<div class="alerts-message">'+e+"</div>"),this.renderMostDuggStories(5),this.$el.find("#digg-deeper").fadeIn(800)},renderStreamContainer:function(){document.getElementById("digg-alerts")||(this.el.className="alerts-enabled",this.el.innerHTML=u,p(".js--digg-deeper-sort-select").find("option[value="+S+"]").attr("selected","selected"),this.$el.on("change",".js--digg-deeper-sort-select",h.bind(this.selectSort,this)).on("mouseenter",".more-shares",h.bind(this.showMoreSharersTooltip,this)).on("mouseleave",".more-shares",h.bind(this.hideMoreSharersTooltip,this)))},selectSort:function(t){S=p(".js--digg-deeper-sort-select").val(),y=0,w=null,b=null,this.$el.find("#digg-deeper").html('<div class="ico-loading alerts-first-page-loading"></div>'),e.pubsub.fire("digg_deeper:stream:sortby_selected",S),this.fetch()},setStreamElHeight:function(){var e=p(".no-marquee").size()?5:15;this.$el.find("#digg-deeper").height(this.$el.height()-this.$el.find(".widget-hdr").outerHeight(!0)+e)},renderStories:function(e){var t=e.data.feed,n=e.status_message,r=h.map(t,k),i=this.$el.find(".story-container").size(),s=this.$el.find("#digg-deeper");this.scrollPanel||(this.scrollPanel=s[0],p(document).on("DOMMouseScroll mousewheel","#digg-deeper",L)),s.find(".ico-loading").remove(),i?s.append(r.join("")):(s.hide(),s.append(r.join("")).fadeIn(800)),n&&b==null&&(s.append('<div class="alerts-message">'+n+"</div>"),C.done(h.bind(this.renderMostDuggStories,this,5))),s.append('<a href="/deeper" class="digg-deeper__btn-view-all">View All</a>')},showMoreSharersTooltip:function(e){var t=e.currentTarget;p(t).addClass("tooltip-show"),this.hideMoreSharersProxy=h.bind(this.hideMoreSharersTooltip,this),this.$el.on("mouseleave",".btn-show-more-shares",this.hideMoreSharersProxy)},hideMoreSharersTooltip:function(e){var t=e.currentTarget;p(t).removeClass("tooltip-show")},renderMostDuggStories:function(t){var r=[],s=0,o;for(;s<t;s++)o=T[s],o.position=s,o.formattedDate=n.secondsToFuzzyTime(o.date),o.content.link_target="_blank",o.fblink=i.getFacebookStoryShareLink({app_id:e.config.FB_APP_ID,content_id:o.content.content_id}),o.tweetlink=i.getTweetStoryLink({content_id:o.content.content_id,title:o.content.title||o.tweets[0].text}),o.feed="most-dugg",o.maxSharersDisplayed=1,o.noContentPreview=!0,o.showDiversityScore=!1,o.tweets.count=1,o.tweets.hideTweetDetails=!0,o.tweets.data=[{user:{name:"Top story on Digg",profile_image_url:"https://pbs.twimg.com/profile_images/529093119665397760/W5XVfjAs_400x400.jpeg",screen_name:"digg",user_id:"15163466"}}],r.push(g(o));this.$el.find("#digg-deeper").append(r.join(""))},renderOnboarding:function(){var t=e.user.get("twitter"),n=h.bind(this.beginOnboarding,this);this.el.className="onboarding",this.el.innerHTML=this.alertsOnboardingTemplate({isUserLoggedIn:e.user.isLoggedIn(),hasTwitter:t&&t.username}),p(this.el).on("click",".btn-enable-alerts",E.authorized(n,"digg_deeper",{twitterOnly:!0})).on("click",".btn-alerts-opt-out",h.bind(this.optOut,this,"Twitter alerts"))},optOut:function(t){e.pubsub.fire("digg_deeper:onboarding:opt_out",t),r.set({name:v,value:1,expires:r.expires.oneYear(),path:"/"}),h.defer(function(){window.location.reload(!0)})},beginOnboarding:function(){E.deepGet("apps.digg_deeper.enabled")?this.$el.find("#digg-deeper").size()||this.renderDiggDeeper():this.enableTwitterAlerts()},renderEmailOnboarding:function(){this.el.innerHTML=this.emailOnboardingTemplate({email:e.user.get("email")||""}),p("#input-alerts-email").focus(),p(this.el).on("click",".btn-enable-alerts-email",h.bind(this.alertsEmailDetails,this)).on("click",".btn-alerts-email-skip",h.bind(this.renderOnboardingSuccess,this,{emailOptOut:!0})).on("keyup","#input-alerts-email",h.bind(this.alertsEmailDetailsProxy,this))},renderEmailDetailsOnboarding:function(e){this.el.innerHTML=this.emailOnboardingDetailsTemplate({email:e}),p("input[name=email-setting]").last().focus(),p(this.el).on("keyup","input[name=email-setting]",h.bind(this.alertsEmailProxy,this)).on("click",".btn-alerts-email-details-continue",h.bind(this.enableAlertsEmail,this))},alertsEmailDetailsProxy:function(e){e.keyCode===13&&(e.stopPropagation(),e.preventDefault(),this.alertsEmailDetails())},alertsEmailDetails:function(e){var t=p("#input-alerts-email"),n=t.val();this.renderEmailDetailsOnboarding(n)},alertsEmailProxy:function(e){e.keyCode===13&&(e.stopPropagation(),e.preventDefault(),this.enableAlertsEmail())},enableAlertsEmail:function(){var n=p("#input-alerts-email"),r=n.val(),i=p('input[name="email-setting"]:checked').val(),s=0,o=!1;if(i==="both"||i==="digest")o=!0;if(i==="both"||i==="alerts")s=2;var u=new t.dataProvider({url:"/api/settings/email.json",type:"POST",success:h.bind(this.renderOnboardingSuccess,this),error:h.bind(this.enableTwitterAlertsError),data:{source:"onboarding",email:r,"apps.digg_deeper.alerts.email.frequency":s,"apps.digg_deeper.digest.email.enabled":o}});r?(e.pubsub.fire("digg_deeper:onboarding:email_opt_in"),u.request()):n.addClass("input-error")},renderOnboardingSuccess:function(t){if(this.onboarded)return;this.onboarded=!0,t&&t.emailOptOut&&e.pubsub.fire("digg_deeper:onboarding:opt_out","Email alerts"),e.pubsub.fire("digg_deeper:onboarding:success"),r.set({name:v,value:1,expires:r.expires.oneYear(),path:"/"}),this.el.innerHTML='<div class="ico-loading onboarding-success"></div><p class="alerts-desc">Almost there...</p>',this.renderDiggDeeper()},enableTwitterAlertsSuccess:function(){E.deepGet("apps.digg_deeper.enabled")||setTimeout(h.bind(this.renderEmailOnboarding,this),3500)},enableTwitterAlertsError:function(){this.el.className="alerts-enabled",this.el.innerHTML="<p class=\"alerts-desc\">Oops! We're having trouble Digging Deeper. Why don't you refresh the page and try again.</p>"},enableTwitterAlerts:function(){var n=new t.dataProvider({url:"/api/settings/digg_deeper.json",type:"POST",success:h.bind(this.enableTwitterAlertsSuccess,this),error:h.bind(this.enableTwitterAlertsError,this),data:{source:"onboarding",enabled:!0}});n.request(),e.pubsub.fire("digg_deeper:onboarding:opt_in"),this.el.innerHTML='<div class="ico-loading onboarding-success"></div><p class="alerts-desc">Here we go!<br>Compiling stories from your Twitter timeline...</p>'}},{factory:function(e){return new A(e)}}}),!function(e,t){function n(e,t,n){var r=e.children(),i=!1;e.empty();for(var o=0,u=r.length;u>o;o++){var a=r.eq(o);if(e.append(a),n&&e.append(n),s(e,t)){a.remove(),i=!0;break}n&&n.detach()}return i}function r(t,n,o,u,a){var f=!1,l="a, table, thead, tbody, tfoot, tr, col, colgroup, object, embed, param, ol, ul, dl, blockquote, select, optgroup, option, textarea, script, style",c="script, .dotdotdot-keep";return t.contents().detach().each(function(){var h=this,p=e(h);if("undefined"==typeof h)return!0;if(p.is(c))t.append(p);else{if(f)return!0;t.append(p),!a||p.is(u.after)||p.find(u.after).length||t[t.is(l)?"after":"append"](a),s(o,u)&&(f=3==h.nodeType?i(p,n,o,u,a):r(p,n,o,u,a),f||(p.detach(),f=!0)),f||a&&a.detach()}}),n.addClass("is-truncated"),f}function i(t,n,r,i,u){var l=t[0];if(!l)return!1;var h=f(l),p=-1!==h.indexOf(" ")?" ":"\u3000",d="letter"==i.wrap?"":p,v=h.split(d),m=-1,g=-1,y=0,b=v.length-1;for(i.fallbackToLetter&&0==y&&0==b&&(d="",v=h.split(d),b=v.length-1);b>=y&&(0!=y||0!=b);){var w=Math.floor((y+b)/2);if(w==g)break;g=w,a(l,v.slice(0,g+1).join(d)+i.ellipsis),r.children().each(function(){e(this).toggle().toggle()}),s(r,i)?(b=g,i.fallbackToLetter&&0==y&&0==b&&(d="",v=v[0].split(d),m=-1,g=-1,y=0,b=v.length-1)):(m=g,y=g)}if(-1==m||1==v.length&&0==v[0].length){var E=t.parent();t.detach();var S=u&&u.closest(E).length?u.length:0;E.contents().length>S?l=c(E.contents().eq(-1-S),n):(l=c(E,n,!0),S||E.detach()),l&&(h=o(f(l),i),a(l,h),S&&u&&e(l).parent().append(u))}else h=o(v.slice(0,m+1).join(d),i),a(l,h);return!0}function s(e,t){return e.innerHeight()>t.maxHeight}function o(t,n){for(;e.inArray(t.slice(-1),n.lastCharacter.remove)>-1;)t=t.slice(0,-1);return e.inArray(t.slice(-1),n.lastCharacter.noEllipsis)<0&&(t+=n.ellipsis),t}function u(e){return{width:e.innerWidth(),height:e.innerHeight()}}function a(e,t){e.innerText?e.innerText=t:e.nodeValue?e.nodeValue=t:e.textContent&&(e.textContent=t)}function f(e){return e.innerText?e.innerText:e.nodeValue?e.nodeValue:e.textContent?e.textContent:""}function l(e){do e=e.previousSibling;while(e&&1!==e.nodeType&&3!==e.nodeType);return e}function c(t,n,r){var i,s=t&&t[0];if(s){if(!r){if(3===s.nodeType)return s;if(e.trim(t.text()))return c(t.contents().last(),n)}for(i=l(s);!i;){if(t=t.parent(),t.is(n)||!t.length)return!1;i=l(t[0])}if(i)return c(e(i),n)}return!1}function h(t,n){return t?"string"==typeof t?(t=e(t,n),t.length?t:!1):t.jquery?t:!1:!1}function p(e){for(var t=e.innerHeight(),n=["paddingTop","paddingBottom"],r=0,i=n.length;i>r;r++){var s=parseInt(e.css(n[r]),10);isNaN(s)&&(s=0),t-=s}return t}if(!e.fn.dotdotdot){e.fn.dotdotdot=function(t){if(0==this.length)return e.fn.dotdotdot.debug('No element found for "'+this.selector+'".'),this;if(this.length>1)return this.each(function(){e(this).dotdotdot(t)});var i=this;i.data("dotdotdot")&&i.trigger("destroy.dot"),i.data("dotdotdot-style",i.attr("style")||""),i.css("word-wrap","break-word"),"nowrap"===i.css("white-space")&&i.css("white-space","normal"),i.bind_events=function(){return i.bind("update.dot",function(t,u){switch(i.removeClass("is-truncated"),t.preventDefault(),t.stopPropagation(),typeof a.height){case"number":a.maxHeight=a.height;break;case"function":a.maxHeight=a.height.call(i[0]);break;default:a.maxHeight=p(i)}a.maxHeight+=a.tolerance,"undefined"!=typeof u&&(("string"==typeof u||"nodeType"in u&&1===u.nodeType)&&(u=e("<div />").append(u).contents()),u instanceof e&&(o=u)),v=i.wrapInner('<div class="dotdotdot" />').children(),v.contents().detach().end().append(o.clone(!0)).find("br").replaceWith("  <br />  ").end().css({height:"auto",width:"auto",border:"none",padding:0,margin:0});var l=!1,c=!1;return f.afterElement&&(l=f.afterElement.clone(!0),l.show(),f.afterElement.detach()),s(v,a)&&(c="children"==a.wrap?n(v,a,l):r(v,i,v,a,l)),v.replaceWith(v.contents()),v=null,e.isFunction(a.callback)&&a.callback.call(i[0],c,o),f.isTruncated=c,c}).bind("isTruncated.dot",function(e,t){return e.preventDefault(),e.stopPropagation(),"function"==typeof t&&t.call(i[0],f.isTruncated),f.isTruncated}).bind("originalContent.dot",function(e,t){return e.preventDefault(),e.stopPropagation(),"function"==typeof t&&t.call(i[0],o),o}).bind("destroy.dot",function(e){e.preventDefault(),e.stopPropagation(),i.unwatch().unbind_events().contents().detach().end().append(o).attr("style",i.data("dotdotdot-style")||"").data("dotdotdot",!1)}),i},i.unbind_events=function(){return i.unbind(".dot"),i},i.watch=function(){if(i.unwatch(),"window"==a.watch){var t=e(window),n=t.width(),r=t.height();t.bind("resize.dot"+f.dotId,function(){n==t.width()&&r==t.height()&&a.windowResizeFix||(n=t.width(),r=t.height(),c&&clearInterval(c),c=setTimeout(function(){i.trigger("update.dot")},100))})}else l=u(i),c=setInterval(function(){if(i.is(":visible")){var e=u(i);(l.width!=e.width||l.height!=e.height)&&(i.trigger("update.dot"),l=e)}},500);return i},i.unwatch=function(){return e(window).unbind("resize.dot"+f.dotId),c&&clearInterval(c),i};var o=i.contents(),a=e.extend(!0,{},e.fn.dotdotdot.defaults,t),f={},l={},c=null,v=null;return a.lastCharacter.remove instanceof Array||(a.lastCharacter.remove=e.fn.dotdotdot.defaultArrays.lastCharacter.remove),a.lastCharacter.noEllipsis instanceof Array||(a.lastCharacter.noEllipsis=e.fn.dotdotdot.defaultArrays.lastCharacter.noEllipsis),f.afterElement=h(a.after,i),f.isTruncated=!1,f.dotId=d++,i.data("dotdotdot",!0).bind_events().trigger("update.dot"),a.watch&&i.watch(),i},e.fn.dotdotdot.defaults={ellipsis:"... ",wrap:"word",fallbackToLetter:!0,lastCharacter:{},tolerance:0,callback:null,after:null,height:null,watch:!1,windowResizeFix:!0},e.fn.dotdotdot.defaultArrays={lastCharacter:{remove:[" ","\u3000",",",";",".","!","?"],noEllipsis:[]}},e.fn.dotdotdot.debug=function(){};var d=1,v=e.fn.html;e.fn.html=function(n){return n!=t&&!e.isFunction(n)&&this.data("dotdotdot")?this.trigger("update",[n]):v.apply(this,arguments)};var m=e.fn.text;e.fn.text=function(n){return n!=t&&!e.isFunction(n)&&this.data("dotdotdot")?(n=e("<div />").text(n).html(),this.trigger("update",[n])):m.apply(this,arguments)}}}(jQuery),define("jquery_dotdotdot",["jquery"],function(){}),require(["bs/core","bs/util/storyactions2","bs/util/item_actions","bs/util/user_graph","bs/util/storyscores","bs/util/tracking_v2","bs/util/cookies","bs/widgets/lazyimages","bs/widgets/usernav","bs/widgets/savedstories","bs/widgets/header","bs/widgets/mobileheader","bs/widgets/promobanner","bs/widgets/popularvideos","bs/widgets/popularstories","bs/widgets/upcomingstories","bs/widgets/footer","bs/widgets/onboarding","bs/widgets/alerts","jquery_dotdotdot","lodash"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w){function E(t,n){var r=document.getElementById("top-stories").getBoundingClientRect(),i=100;if(n||t>=r.bottom-i)p.init(),d.init(),v.init(),$(".ftr-ios-hero-img").addClass("lazy-loaded"),e.pubsub.off("scroll",e.pubsub.channels.scrolltop,E)}function S(){var e=document.getElementById("popular-videos").getBoundingClientRect(),t=$(document).scrollTop();E(t,!0),t<e.top&&$("html,body").animate({scrollTop:e.bottom-25},1e3)}function N(){function s(){var t=[{src:e.STATIC_BASE_URL+"audio/rickLoop.mp3",type:"audio/mp3"},{src:e.STATIC_BASE_URL+"audio/rickLoop.ogg",type:"audio/ogg"}];r=document.createElement("audio");if(!r.canPlayType)return;w.each(t,function(e,t){var n=document.createElement("source");n.setAttribute("src",e.src),n.setAttribute("type",e.type),r.appendChild(n)}),$("body").append(r),r.volume=0,r.addEventListener("ended",function(){u()},!1),r.play(),o()}function o(){if(i>=1)return;r.volume=i,i+=.1,setTimeout(o,500)}function u(){var e;for(var t=0;t<7;t++)e=$(n[t]),e.attr("src",e.attr("data-src"))}function a(){var r,i;if(!t.length)return;i=t.pop(),r=$(n[i-1]),r.addClass("img-rr"),r.css({opacity:0}),r.attr("data-src",r.attr("src")),r.attr("src",e.STATIC_BASE_URL+"images/rr/"+i+"-png.jpg"),r.fadeTo(1e3,1),i===3?(setTimeout(a,5e3),s()):a()}function f(){var n=[],r;w.each(t,function(t,r){n[r]={img:new Image,done:new $.Deferred},n[r].img.onload=function(){n[r].done.resolve()},n[r].src=e.STATIC_BASE_URL+"images/rr/"+r+"-png.jpg"}),r=w.map(t,function(e,t){return e.done}),$.when.apply(this,r).then(a)}var t=[2,3,1,4,5,6,7].reverse(),n=$(".js--digg-story__image-img"),r,i=0;f(),e.pubsub.fire("spreadgun","http://digg.com/")}var x,T={init:function(){var r=$("#marquee").find("article"),s=$(".no-marquee"),o=$(".js--top-stories"),c={id:"activity-feed-container"};window.location.hash==="#upcoming"&&S(),l.init(),u.init(),a.init(),h.init(),n.init();var p={id:"digg-alerts-container"};r.size()?p.elHeight=r.outerHeight():s.size()&&(p.elHeight=$("#js--deeper-widget-height").outerHeight()),alertsWidget=y.factory(p),e.user.getUser(w.bind(alertsWidget.init,alertsWidget));var d=function(){var e=r.size()?r.outerHeight():$("#js--deeper-widget-height").outerHeight();alertsWidget.setElHeight(e)};$(window).on("resize orientationchange",w.throttle(d,100)),e.features.edit_mode&&$("#edit-mode-label-container").insertBefore(".site-header-container"),e.features.saved_stories&&f.initialize({elID:"#modal-savedstories"});var v=$(".js--digg-story"),m=w.map(v,function(e){return $(e).data("contentId")}),b=i.factory("top_stories");m.length&&b.register(m),$(document).on("click",".launch-dailydigg-modal",g.dailyDiggModal).on("click",".story-action-digg > .target",e.user.authorized(t.submitDigg,"Digg")).on("click",".story-action-save > .target",e.user.authorized(t.addReadingList,"Save")).on("click",".story-action-share > .target",t.shareStory).on("click",".story-link",t.redirectStoryLink),g.dailyDiggModalHash(),$(window).on("hashchange",g.dailyDiggModalHash),$(function(){e.pubsub.on("scroll",e.pubsub.channels.scrolltop,E),E($(document).scrollTop())})}};$.fn.k=function(e,t){return t===undefined&&(t="38,38,40,40,37,39,37,39,66,65"),this.each(function(){var n=[];$(this).keydown(function(r){n.push(r.keyCode),n.toString().indexOf(t)>=0&&($(this).unbind("keydown",arguments.callee),e(r))})})},$(window).k(N),T.init()}),define("bs/frontpage",function(){})})();