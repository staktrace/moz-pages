function CompareStorageProfileHandler(){this.productEditionIds=[];this.productEditionCache={};this.init()};Object.extend(CompareStorageProfileHandler.prototype,{init:function(){this.productEditionIds=this.getMostRecentBasket()},getMostRecentBasket:function(){var initialCompareBasket=jsConfig.get(['compare','initialCompareBasket']),initialBasketTimestamp=jsConfig.get(['compare','timestamp'],0),cachedCompareData=this.getBasketFromStorage();if(cachedCompareData&&cachedCompareData.timestamp>=initialBasketTimestamp)return cachedCompareData.productEditionIds;if(Array.isArray(initialCompareBasket)&&initialBasketTimestamp){this.setBasketInStorage(initialCompareBasket,initialBasketTimestamp);return initialCompareBasket};return[]},getBasketFromStorage:function(){if(!Browser.supports('sessionStorage'))return null;var cachedCompareJsonData=sessionStorage.getItem('compare');return cachedCompareJsonData&&JSON.parse(cachedCompareJsonData)},setBasketInStorage:function(productEditionIds,timestamp){if(!Browser.supports('sessionStorage'))return;var cachedCompareJsonData=JSON.stringify({productEditionIds:productEditionIds,timestamp:timestamp});sessionStorage.setItem('compare',cachedCompareJsonData)},clearCache:function(){this.productEditionIds=[];this.productEditionCache={}},getProductEditionCount:function(){return this.productEditionIds.length},hasProductEditionId:function(productEditionId){return this.findPosition(productEditionId)>=0},findPosition:function(productEditionId){return this.productEditionIds.indexOf(Number(productEditionId))},addProductEdition:function(productEditionId,productEditionData){if(!(productEditionId=Number(productEditionId)))return;if(this.hasProductEditionId(productEditionId)){this.productEditionCache[productEditionId]=productEditionData;return};this.productEditionCache[productEditionId]=productEditionData;this.productEditionIds.push(productEditionId);this.accessStorage('add',productEditionId);trackEventWt('addOneToCompare')},deleteProductEdition:function(productEditionId){if(!(productEditionId=Number(productEditionId)))return;var currentPosition=this.findPosition(productEditionId);if(currentPosition>=0){this.productEditionIds.splice(currentPosition,1);delete this.productEditionCache[productEditionId]};this.accessStorage('delete',productEditionId);trackEventWt('removeOneFromCompare')},deleteAll:function(){var productEditionIds=this.getProductEditionIds().join(',');this.clearCache();this.accessStorage('delete',productEditionIds);trackEventWt('emptyCompareBasket')},getProductEditionIds:function(){return this.productEditionIds},getProductEditionData:function(){var productEditionData=[];for(var i=0,productEditionId;i<this.productEditionIds.length;i++){productEditionId=this.productEditionIds[i];productEditionData.push(this.productEditionCache[productEditionId])};return productEditionData},updateCache:function(callback){for(var i=0,productEditionId;i<this.productEditionIds.length;i++){productEditionId=this.productEditionIds[i];if(!(productEditionId in this.productEditionCache)){this.accessStorage('get',0,callback);return false}};for(productEditionId in this.productEditionCache)if(!this.hasProductEditionId(productEditionId)){this.accessStorage('get',0,callback);return false};if(callback)callback(this.getProductEditionData());return true},accessStorage:function(method,productEditionId,callback){try{Ajax.sendRequest(location.protocol+'//'+location.host+'/ajax/pricewatch/compare/'+method+'/',{method:'POST',type:'json',async:true,nocache:true,appendSid:true,strictSidCheck:true,handler:this.handleResponse.bind(this,callback)},(productEditionId?'productEditionIds='+productEditionId:''))}catch(e){if(e=='noSessionException'){alert('Er werd geen geldige sessie gevonden, de pagina wordt herladen');location.reload(true)}}},handleResponse:function(callback,response){var productEditionResult=checkJsonResponse(response);if(productEditionResult&&'productEditionData'in productEditionResult){this.clearCache();var productEditionData,i=0,newProductEditionId;while((productEditionData=productEditionResult.productEditionData[i++]))if((newProductEditionId=Number(productEditionData.id))){this.productEditionIds.push(newProductEditionId);this.productEditionCache[newProductEditionId]=productEditionData};this.setBasketInStorage(this.productEditionIds,productEditionResult.timestamp)};if(callback)callback(this.getProductEditionData())}})
function CompareStorage(){this.formName='compareProductListing';this.storageHandler=new CompareStorageProfileHandler();this.form=null;this.positionElement=null;this.popup=null;this.overviewList=null;this.currentProductCount=0;this.maxProductCount=jsConfig.get(['compare','compareMax']);this.initialized=false};Object.extend(CompareStorage.prototype,{init:function(){var self=this;this.getCompareHeaderButtons().forEach(function(el){el.onclick=self.compareHeaderButtonClick.bind(self,el)});this.update();this.initialized=true},update:function(){this.updateCheckBoxes();this.updateProductCount()},compareHeaderButtonClick:function(compareHeaderButton){if(hasClass(compareHeaderButton,'selected')){if(this.popup)this.popup.close(true)}else this.buildOverview(compareHeaderButton,null)},updateCheckBoxes:function(){var checkboxes=this.getAllCheckBoxes(),checkbox,i=0,checked;if(!checkboxes.length)return;while((checkbox=checkboxes[i++])){checked=this.storageHandler.hasProductEditionId(checkbox.value);if(this.initialized&&checkbox.checked==checked)continue;checkbox.checked=checked;if(hasClass(checkbox.parentNode,'fancyButton'))this.updateFancyButton(checkbox)}},getAllCheckBoxes:function(){var checkboxes=[],checkbox,form=this.formName&&document.forms[this.formName],isNewForm=form!=this.form;if(form){if(isNewForm)form.onsubmit=this.submit.bind(this,'main');if((checkbox=form.elements['products[]']))checkboxes=checkbox.length?Array.slice(checkbox):[checkbox];this.form=form};if((checkbox=this.getEntityHeaderCheckBox()))checkboxes.push(checkbox);if(isNewForm||!this.initialized)checkboxes.forEach(this.bindCheckbox.bind(this));return checkboxes},bindCheckbox:function(checkbox){var fancyButton=checkbox.parentNode;if(hasClass(fancyButton,'fancyButton')){fancyButton.onclick=this.checkFancy.bind(this,checkbox)}else checkbox.onclick=this.check.bind(this,checkbox)},checkFancy:function(checkbox){checkbox.checked=!checkbox.checked;this.updateFancyButton(checkbox);this.check(checkbox)},updateFancyButton:function(checkbox){var fancyButton=checkbox.parentNode,buttonColor=fancyButton.getAttribute('data-buttoncolor')||'white';if(checkbox.checked){addClass(checkbox.nextSibling,'checked');removeClass(fancyButton,buttonColor);addClass(fancyButton,'green')}else{removeClass(checkbox.nextSibling,'checked');removeClass(fancyButton,'green');addClass(fancyButton,buttonColor)}},check:function(checkbox){var productId=checkbox.value;if(checkbox.checked){var parent=checkbox.parentNode,product={},productData=parent.getAttribute('data-productdata');if(productData){product=JSON.parse(productData)}else{product={id:productId,url:'#',img:null,name:'Product: '+productId};while(parent){if(parent.nodeName=='TR'||parent.nodeName=='DIV')break;parent=parent.parentNode};Selector('a.thumb',parent).forEach(function(a){if(a.href.contains('pricewatch/'+productId)){if(!hasClass(a,'empty'))product.img=Selector('img',a)[0].src;product.url=a.href;product.name=a.title.escapeHtml()}})};this.storageHandler.addProductEdition(productId,product)}else this.storageHandler.deleteProductEdition(productId);this.updateCheckBoxes();this.buildOverview(checkbox,productId)},remove:function(productId,e){this.storageHandler.deleteProductEdition(productId);this.updateCheckBoxes();this.buildOverview(this.positionElement);stopPropagation(e)},deleteAll:function(e){this.storageHandler.deleteAll();this.updateCheckBoxes();this.buildOverview(this.positionElement);stopPropagation(e)},createPopup:function(){if(!this.popup){this.popup=PopupGenerator.get('selectedProductsPopup');if(!this.popup)return;this.popup.options.compareStorage=this};preload('deleteIcon','g/if/icons/delete_product.png');this.overviewList=document.createElement('ul');var html=HTMLBuilder().built({n:'div',c:[{n:'div',a:{className:'header'},c:{n:'h3',t:'Geen producten in vergelijking'}},{n:'p',a:{className:'maxMessage error'},t:'Je kan niet meer dan '+this.maxProductCount+' producten vergelijken'},{n:'div',a:{className:'noProducts'},c:[{n:'p',t:'Je hebt nog geen producten in je vergelijking.'},{n:'a',a:{className:'fancyButton grey clickOut',href:jsConfig.get('TnetBaseURL')+'pricewatch/'},t:'Naar de Pricewatch'}]},{n:'div',a:{className:'productListPopup scrollArea'},c:this.overviewList},{n:'div',a:{className:'compare clearfix'},c:[{n:'input',a:{type:'button',className:'fancyButton',value:'Vergelijk',onclick:this.submit.bind(this,'popup')}},{n:'a',a:{className:'deleteAll',onclick:this.deleteAll.bind(this)},t:'Verwijder lijst'}]}]});this.popup.setContent(html)},clearList:function(){while(this.overviewList.hasChildNodes())this.overviewList.removeChild(this.overviewList.lastChild)},buildOverview:function(positionElement,selectedProductId){if(!this.popup)this.createPopup();this.updateProductCount();if(!this.storageHandler.getProductEditionCount()&&!this.isPopupInHeader(positionElement)){this.popup.close(true);this.positionElement=null;return};if(positionElement){this.positionElement=positionElement;if(hasClass(positionElement.parentNode,'fancyButton'))positionElement=positionElement.parentNode;this.popup.show(positionElement)};var cacheIsComplete=this.storageHandler.updateCache(this.buildList.bind(this,selectedProductId));if(!cacheIsComplete){this.clearList();this.overviewList.appendChild(HTMLBuilder().built({n:'li',h:this.popup.getLoadingMessage('Producten worden geladen...')}))}},buildList:function(selectedProductId,products){this.clearList();var product,i=0,li;while((product=products[i++])){li=this.buildProductListItem(product);if(product.id==selectedProductId)li.className='fadeIn';this.overviewList.appendChild(li)};Scrollable.create(Selector('.productListPopup',this.popup.element)[0],{fadeShowMore:1})},popupOnShow:function(popup){addClass(popup.element,'scrollableList');if(this.isPopupInHeader()){addClass(popup.offsetElement,'selected');addClass(popup.element,'menuHeaderPopup');addClass(popup.element,'compareHeaderPopup')}else{if(hasClass(popup.element,'compareHeaderPopup')){this.getCompareHeaderButtons().forEach(function(el){removeClass(el,'selected')});removeClass(popup.element,'compareHeaderPopup')};removeClass(popup.element,'menuHeaderPopup')}},isPopupInHeader:function(positionElement){if(!positionElement)positionElement=this.positionElement;return positionElement&&hasClass(positionElement,'icon')},popupOnClose:function(popup){if(this.isPopupInHeader()){removeClass(popup.offsetElement,'selected');removeClass(popup.element,'compareHeaderPopup');this.setCounterHighlight(false)}},getCompareHeaderButtons:function(){return Selector('.icon.compare')},getEntityHeaderCheckBox:function(){return Selector('.entityHeader .specs .fancyButton.compare input')[0]},buildProductListItem:function(product){return HTMLBuilder().built({n:'li',a:{className:'listItem'},c:[{n:'img',a:{src:getPreloadImage('deleteIcon'),title:'product verwijderen uit selectielijst',className:'delProduct',onclick:this.remove.bind(this,product.id)}},{n:'a',a:{href:product.url,className:'thumb micro product'+(product.img?'':' empty')},c:product.img?{n:'img',a:{src:product.img,width:37,height:31}}:null},{n:'a',a:{href:product.url,className:'itemname'},h:product.name}]})},updateProductCount:function(){var productCount=this.storageHandler.getProductEditionCount(),productLabel=productCount==1?' product':' producten';if(this.popup){Selector('h3',this.popup.element)[0].innerHTML=productCount<1?'Geen producten in vergelijking':productCount+productLabel+' in vergelijking';Selector('p',this.popup.element)[0].style.display=productCount>this.maxProductCount?'block':'none';Selector('.noProducts',this.popup.element)[0].style.display=productCount<1?'block':'none';Selector('.compare',this.popup.element)[0].style.display=productCount<1?'none':'block'};var compareButtons=Selector('.submitComparePrice',this.form),i=0,button;while((button=compareButtons[i++])){button.value='Vergelijk'+(productCount>1?' '+productCount+productLabel:'');button.onmouseover=this.buildOverview.bind(this,button)};if(this.initialized&&productCount>this.currentProductCount){this.setCounterHighlight(true)}else if(productCount==0)this.setCounterHighlight(false);this.currentProductCount=productCount;NotificationNotifier.updateUnreadCounts({newCompareItemCount:productCount})},setCounterHighlight:function(highlight){var headerButtons=this.getCompareHeaderButtons(),sideBar=Selector('.rightSidebarToggle')[0];if(sideBar)headerButtons.push(sideBar);headerButtons.forEach(function(el){if(highlight){addClass(el,'highlight')}else removeClass(el,'highlight')})},submit:function(formType){if(this.storageHandler.getProductEditionCount()==0){alert('Je hebt geen producten aangevinkt om te vergelijken.');return false};var selectedProductEditions=this.storageHandler.getProductEditionIds(),productCount=selectedProductEditions.length;if(productCount>this.maxProductCount){if(!confirm('Je kan niet meer dan '+this.maxProductCount+' producten met elkaar vergelijken. Je hebt '+productCount+' producten geselecteerd. '+(productCount==this.maxProductCount+1?'Het laatste geselecteerde product in de lijst zal':'De laatste '+(productCount-this.maxProductCount)+' geselecteerde producten in de lijst zullen')+' worden genegeerd.'))return false;selectedProductEditions=selectedProductEditions.slice(0,this.maxProductCount);productCount=this.maxProductCount};if(formType=='popup'&&this.isPopupInHeader())formType='header';trackEventWt('productCompare',{3:formType,4:''+productCount},true);var url=this.form?this.form.action:jsConfig.get(['compare','defaultCompareUrl']),match;if(url.contains('/0/')){url=url.replace('/0/','/'+selectedProductEditions.join(';')+'/')}else url=url.replace(/\/+$/,'')+'/'+selectedProductEditions.join(';')+'/';window.location.href=url;return false},positionPopup:function(popup){if(this.isPopupInHeader()){setRelativePosition(popup.element,popup.offsetElement,37,-336);return};if(this.form&&hasClass(this.form,'reposition')){popup.setAutoPosition();return};var pageDimensions=getPageDimensions(),relativePosY=getOffsetTop(popup.offsetElement)-pageDimensions.offsetY,xPos=-20,yPos=-330;popup.arrow.className='arrow right';if(this.form&&(popup.element.offsetHeight>this.form.offsetHeight-getOffsetTop(popup.offsetElement,this.form)||(popup.element.offsetHeight>pageDimensions.innerHeight-relativePosY&&popup.element.offsetHeight<relativePosY))){xPos=30-popup.element.offsetHeight+Math.floor(popup.offsetElement.offsetHeight/2);addClass(popup.arrow,'lopsided')}else{xPos=Math.floor(popup.offsetElement.offsetHeight/2)-29;removeClass(popup.arrow,'lopsided')};setRelativePosition(popup.element,popup.offsetElement,xPos,yPos)}})
function updateScoreStars(minValue){var scoreLabel=Selector('#scoreFilter .sliderLabel')[0],scoreClass;if(scoreLabel){scoreLabel.style.marginLeft=(-14*minValue+6)+'px';scoreClass=minValue*10;if(scoreClass<10)scoreClass='0'+scoreClass;scoreLabel.className='sliderLabel scoreStars score'+scoreClass}};if(window.PopupGenerator)PopupGenerator.register('selectedProductsPopup',{arrow:['top','bottom'],className:'menuHeaderPopup scrollableList',offsetTop:8,offsetLeft:-13,forceReposition:true,compareStorage:null,afterShow:function(popup){if(this.compareStorage)this.compareStorage.popupOnShow(popup)},onClose:function(popup){if(this.compareStorage)this.compareStorage.popupOnClose(popup)},setPosition:function(popup){if(this.compareStorage)this.compareStorage.positionPopup(popup)}});var compareStorage=new CompareStorage()